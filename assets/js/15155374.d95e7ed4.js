"use strict";(globalThis.webpackChunkcelltype_refinery_docs=globalThis.webpackChunkcelltype_refinery_docs||[]).push([[9754],{1634(e,n,i){i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"methodology/tuning-guide","title":"Tuning Guide","description":"Parameter tuning is a normal part of the annotation workflow. Almost every dataset benefits from some adjustment to match your tissue type and marker panel.","source":"@site/docs/methodology/tuning-guide.md","sourceDirName":"methodology","slug":"/methodology/tuning-guide","permalink":"/CellType-Refinery/docs/methodology/tuning-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/kuang-da/CellType-Refinery/tree/main/celltype-refinery-docs/docs/methodology/tuning-guide.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"docsSidebar","previous":{"title":"Refinement Decision Logic","permalink":"/CellType-Refinery/docs/methodology/refinement-decision-logic"},"next":{"title":"Workflow Overview","permalink":"/CellType-Refinery/docs/core-workflows/workflow-overview"}}');var s=i(4848),a=i(8453);const t={sidebar_position:6},l="Tuning Guide",o={},c=[{value:"Overview",id:"overview",level:2},{value:"How to Use This Guide",id:"how-to-use-this-guide",level:3},{value:"General Tuning Philosophy",id:"general-tuning-philosophy",level:3},{value:"Scenario 1: Too Many &quot;Unassigned&quot; Clusters",id:"scenario-1-too-many-unassigned-clusters",level:2},{value:"Diagnostic Checklist",id:"diagnostic-checklist",level:3},{value:"Primary Fixes",id:"primary-fixes",level:3},{value:"Fix 1.1: Lower Coverage Requirements",id:"fix-11-lower-coverage-requirements",level:4},{value:"Fix 1.2: Lower Positive Fraction Requirements",id:"fix-12-lower-positive-fraction-requirements",level:4},{value:"Fix 1.3: Review Hard Requirements",id:"fix-13-review-hard-requirements",level:4},{value:"Fix 1.4: Check Expression Layer",id:"fix-14-check-expression-layer",level:4},{value:"Advanced Diagnostics",id:"advanced-diagnostics",level:3},{value:"Scenario 2: Annotation Stops Too Early (Parent-Level Only)",id:"scenario-2-annotation-stops-too-early-parent-level-only",level:2},{value:"Diagnostic Checklist",id:"diagnostic-checklist-1",level:3},{value:"Primary Fixes",id:"primary-fixes-1",level:3},{value:"Fix 2.1: Lower Gap Thresholds at Child Levels",id:"fix-21-lower-gap-thresholds-at-child-levels",level:4},{value:"Fix 2.2: Adjust Coverage at Child Levels",id:"fix-22-adjust-coverage-at-child-levels",level:4},{value:"Fix 2.3: Add Distinguishing Markers",id:"fix-23-add-distinguishing-markers",level:4},{value:"Fix 2.4: Check Child Marker Expression",id:"fix-24-check-child-marker-expression",level:4},{value:"Scenario 3: Wrong Cell Types Assigned",id:"scenario-3-wrong-cell-types-assigned",level:2},{value:"Diagnostic Checklist",id:"diagnostic-checklist-2",level:3},{value:"Primary Fixes",id:"primary-fixes-2",level:3},{value:"Fix 3.1: Add Anti-Markers",id:"fix-31-add-anti-markers",level:4},{value:"Fix 3.2: Increase Anti-Weight",id:"fix-32-increase-anti-weight",level:4},{value:"Fix 3.3: Add Root Hard Requirements",id:"fix-33-add-root-hard-requirements",level:4},{value:"Fix 3.4: Add Root Veto Markers",id:"fix-34-add-root-veto-markers",level:4},{value:"Fix 3.5: Change Anti-Aggregation Method",id:"fix-35-change-anti-aggregation-method",level:4},{value:"Scenario 4: Refinement Too Aggressive",id:"scenario-4-refinement-too-aggressive",level:2},{value:"Diagnostic Checklist",id:"diagnostic-checklist-3",level:3},{value:"Primary Fixes",id:"primary-fixes-3",level:3},{value:"Fix 4.1: Raise Score Threshold",id:"fix-41-raise-score-threshold",level:4},{value:"Fix 4.2: Increase Minimum Cell Requirement",id:"fix-42-increase-minimum-cell-requirement",level:4},{value:"Fix 4.3: Adjust Heterogeneity Gap",id:"fix-43-adjust-heterogeneity-gap",level:4},{value:"Fix 4.4: Disable Refinement",id:"fix-44-disable-refinement",level:4},{value:"Scenario 5: Refinement Too Conservative",id:"scenario-5-refinement-too-conservative",level:2},{value:"Primary Fixes",id:"primary-fixes-4",level:3},{value:"Fix 5.1: Lower Score Threshold",id:"fix-51-lower-score-threshold",level:4},{value:"Fix 5.2: Lower Minimum Cell Requirement",id:"fix-52-lower-minimum-cell-requirement",level:4},{value:"Fix 5.3: Lower Heterogeneity Gap",id:"fix-53-lower-heterogeneity-gap",level:4},{value:"Scenario 6: Results Inconsistent Between Runs",id:"scenario-6-results-inconsistent-between-runs",level:2},{value:"Primary Fixes",id:"primary-fixes-5",level:3},{value:"Fix 6.1: Disable GPU for Reproducibility",id:"fix-61-disable-gpu-for-reproducibility",level:4},{value:"Fix 6.2: Fix Clustering, Iterate Annotation",id:"fix-62-fix-clustering-iterate-annotation",level:4},{value:"Fix 6.3: Set Random Seeds",id:"fix-63-set-random-seeds",level:4},{value:"Scenario 7: High Confidence but Biologically Wrong",id:"scenario-7-high-confidence-but-biologically-wrong",level:2},{value:"Primary Fixes",id:"primary-fixes-6",level:3},{value:"Fix 7.1: Review Marker Map for Tissue Appropriateness",id:"fix-71-review-marker-map-for-tissue-appropriateness",level:4},{value:"Fix 7.2: Create Tissue-Specific Marker Map",id:"fix-72-create-tissue-specific-marker-map",level:4},{value:"Fix 7.3: Add Tissue-Specific Gating Parameters",id:"fix-73-add-tissue-specific-gating-parameters",level:4},{value:"Parameter Reference",id:"parameter-reference",level:2},{value:"Scoring Parameters",id:"scoring-parameters",level:3},{value:"Detailed Parameter Explanations",id:"detailed-parameter-explanations",level:4},{value:"Gating Parameters",id:"gating-parameters",level:3},{value:"Level-Specific Configuration",id:"level-specific-configuration",level:4},{value:"Refinement Parameters",id:"refinement-parameters",level:3},{value:"Combined Refinement Configuration",id:"combined-refinement-configuration",level:4},{value:"Tissue-Specific Configuration",id:"tissue-specific-configuration",level:2},{value:"Adding Gating Parameters to Marker Map",id:"adding-gating-parameters-to-marker-map",level:3},{value:"Example: Fallopian Tube Configuration",id:"example-fallopian-tube-configuration",level:3},{value:"Recommended Configuration",id:"recommended-configuration",level:4},{value:"Why These Settings Work",id:"why-these-settings-work",level:4},{value:"Example: Lung Configuration",id:"example-lung-configuration",level:3},{value:"Example: Tumor Microenvironment",id:"example-tumor-microenvironment",level:3},{value:"Iterative Tuning Workflow",id:"iterative-tuning-workflow",level:2},{value:"Step 1: Initial Run with Defaults",id:"step-1-initial-run-with-defaults",level:3},{value:"Step 2: Evaluate Results",id:"step-2-evaluate-results",level:3},{value:"Step 3: Diagnose Issues",id:"step-3-diagnose-issues",level:3},{value:"Step 4: Apply Targeted Fixes",id:"step-4-apply-targeted-fixes",level:3},{value:"Step 5: Re-run and Compare",id:"step-5-re-run-and-compare",level:3},{value:"Step 6: Validate Improvements",id:"step-6-validate-improvements",level:3},{value:"Common Parameter Combinations",id:"common-parameter-combinations",level:2},{value:"Sparse Data (Spatial Transcriptomics)",id:"sparse-data-spatial-transcriptomics",level:3},{value:"High-Quality Deep scRNA-seq",id:"high-quality-deep-scrna-seq",level:3},{value:"Heterogeneous Tumor Samples",id:"heterogeneous-tumor-samples",level:3},{value:"Conservative Annotation (High Precision)",id:"conservative-annotation-high-precision",level:3},{value:"See Also",id:"see-also",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"tuning-guide",children:"Tuning Guide"})}),"\n",(0,s.jsx)(n.admonition,{title:"Expected Usage",type:"tip",children:(0,s.jsx)(n.p,{children:"Parameter tuning is a normal part of the annotation workflow. Almost every dataset benefits from some adjustment to match your tissue type and marker panel."})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"This guide helps you adjust parameters when results need improvement. Each section addresses a common scenario with specific recommendations."}),"\n",(0,s.jsx)(n.p,{children:"Cell type annotation is not a one-size-fits-all process. Different tissues have different marker expression patterns, different sequencing depths produce different signal-to-noise ratios, and different marker panels have different coverage of the cell type hierarchy. This guide provides systematic approaches to diagnosing and fixing common issues."}),"\n",(0,s.jsx)(n.h3,{id:"how-to-use-this-guide",children:"How to Use This Guide"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Identify your symptoms"})," - Look through the scenarios below to find matching issues"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Diagnose the cause"})," - Use the diagnostic checks to understand why the issue occurs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Apply targeted fixes"})," - Start with the most likely fix and iterate"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Validate improvements"})," - Check that fixes improve results without creating new problems"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"general-tuning-philosophy",children:"General Tuning Philosophy"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Start with defaults"})," - The default parameters work well for many datasets"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Change one thing at a time"})," - Makes it easier to understand what helps"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use biological knowledge"})," - Let your understanding of the tissue guide adjustments"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Document changes"})," - Keep track of what you tried and why"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"scenario-1-too-many-unassigned-clusters",children:'Scenario 1: Too Many "Unassigned" Clusters'}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),': Many clusters labeled "Unassigned" with stop_reason = "no_root_passed"']}),"\n",(0,s.jsx)(n.p,{children:"This is the most common issue users encounter. It indicates that clusters are failing to meet the minimum requirements for any root cell type in the hierarchy."}),"\n",(0,s.jsx)(n.h3,{id:"diagnostic-checklist",children:"Diagnostic Checklist"}),"\n",(0,s.jsx)(n.p,{children:"Before adjusting parameters, verify:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Marker panel coverage"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Do you have markers for all expected cell types?"}),"\n",(0,s.jsx)(n.li,{children:"Are the markers in your panel present in the marker map?"}),"\n",(0,s.jsx)(n.li,{children:'Check for naming mismatches (e.g., "CD45" vs "PTPRC")'}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Expression layer quality"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Is there sufficient signal in your expression data?"}),"\n",(0,s.jsx)(n.li,{children:"Are expression values in the expected range (log-normalized)?"}),"\n",(0,s.jsx)(n.li,{children:"Check for batch effects or technical artifacts"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Root requirements alignment"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Are ",(0,s.jsx)(n.code,{children:"root_hard_requirements"})," markers present in your panel?"]}),"\n",(0,s.jsx)(n.li,{children:"Are the thresholds appropriate for your data type?"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"primary-fixes",children:"Primary Fixes"}),"\n",(0,s.jsx)(n.h4,{id:"fix-11-lower-coverage-requirements",children:"Fix 1.1: Lower Coverage Requirements"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"min_coverage"})," parameter controls what fraction of a cell type's markers must be expressed. Lower values allow clusters with partial marker expression to pass."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Default at root level is 0.50\n# Try lowering progressively\nctr annotate ... --gating-params \'{"level_defaults": {"0": {"min_coverage": 0.40}}}\'\n\n# For sparse data (e.g., spatial transcriptomics)\nctr annotate ... --gating-params \'{"level_defaults": {"0": {"min_coverage": 0.30}}}\'\n\n# For very sparse panels (< 50 markers)\nctr annotate ... --gating-params \'{"level_defaults": {"0": {"min_coverage": 0.20}}}\'\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Your marker panel doesn't include all canonical markers for each cell type, or expression is generally sparse."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-12-lower-positive-fraction-requirements",children:"Fix 1.2: Lower Positive Fraction Requirements"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"min_pos_frac"}),' parameter controls what fraction of cells must express the marker for it to count as "positive" for the cluster.']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Default is 0.30 (30% of cells must express marker)\n# Lower for heterogeneous clusters\nctr annotate ... --gating-params \'{"level_defaults": {"0": {"min_pos_frac": 0.20}}}\'\n\n# For tissues with high heterogeneity\nctr annotate ... --gating-params \'{"level_defaults": {"0": {"min_pos_frac": 0.15}}}\'\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Clusters contain mixed populations or markers have bimodal expression."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-13-review-hard-requirements",children:"Fix 1.3: Review Hard Requirements"}),"\n",(0,s.jsx)(n.p,{children:"If specific root types are consistently failing, check whether hard requirements are too strict."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "_gating_params": {\n        "root_hard_requirements": {\n            "Immune Cells": {\n                "marker": "CD45",\n                "min_pos_frac": 0.30,  // Lower from 0.50 if CD45 expression is low\n                "min_enrichment": 0.0\n            }\n        }\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": A specific cell type consistently fails despite clear marker expression."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-14-check-expression-layer",children:"Fix 1.4: Check Expression Layer"}),"\n",(0,s.jsx)(n.p,{children:"Verify your expression data has the expected characteristics:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import scanpy as sc\nimport numpy as np\n\n# Load data\nadata = sc.read_h5ad("your_data.h5ad")\n\n# Check expression range\nprint(f"Expression range: {adata.X.min():.2f} to {adata.X.max():.2f}")\nprint(f"Mean expression: {adata.X.mean():.2f}")\n\n# Check for specific markers\nmarkers_to_check = ["CD45", "CD3", "CD19", "CD14"]\nfor marker in markers_to_check:\n    if marker in adata.var_names:\n        expr = adata[:, marker].X.toarray().flatten()\n        pos_frac = (expr > 0).mean()\n        print(f"{marker}: {pos_frac:.1%} positive, mean={expr.mean():.2f}")\n'})}),"\n",(0,s.jsx)(n.h3,{id:"advanced-diagnostics",children:"Advanced Diagnostics"}),"\n",(0,s.jsx)(n.p,{children:"If the basic fixes don't help, examine the detailed outputs:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"import pandas as pd\n\n# Check gate results for a specific cluster\nresults = pd.read_csv(\"output_dir/gating_details.csv\")\ncluster_results = results[results['cluster'] == 'problematic_cluster']\n\n# Look at coverage scores for each root type\nprint(cluster_results[['root_type', 'coverage', 'pos_frac', 'passed']])\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"scenario-2-annotation-stops-too-early-parent-level-only",children:"Scenario 2: Annotation Stops Too Early (Parent-Level Only)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),': Clusters assigned at parent level (e.g., "Epithelium" instead of "Ciliated Epithelium")']}),"\n",(0,s.jsx)(n.p,{children:"This occurs when the algorithm successfully identifies a root or intermediate type but cannot confidently descend to more specific child types."}),"\n",(0,s.jsx)(n.h3,{id:"diagnostic-checklist-1",children:"Diagnostic Checklist"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Child marker definitions"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Are child types well-defined with unique markers in the marker map?"}),"\n",(0,s.jsx)(n.li,{children:"Do child types have sufficient marker coverage in your panel?"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Gap thresholds"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Is ",(0,s.jsx)(n.code,{children:"min_gap"})," preventing descent when scores are close?"]}),"\n",(0,s.jsx)(n.li,{children:"Are child types genuinely difficult to distinguish in your data?"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Expression patterns"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Do the expected child-specific markers show differential expression?"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"primary-fixes-1",children:"Primary Fixes"}),"\n",(0,s.jsx)(n.h4,{id:"fix-21-lower-gap-thresholds-at-child-levels",children:"Fix 2.1: Lower Gap Thresholds at Child Levels"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"min_gap"})," parameter controls the required score difference between the top candidate and alternatives. Lower values allow the algorithm to make decisions with smaller margins."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Default is often 0.30-0.50 depending on level\n# Lower for deeper annotation\nctr annotate ... --gating-params \'{\n    "level_defaults": {\n        "1": {"min_gap": 0.20},\n        "2": {"min_gap": 0.15}\n    }\n}\'\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Child types have similar marker profiles, or your panel doesn't strongly distinguish subtypes."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-22-adjust-coverage-at-child-levels",children:"Fix 2.2: Adjust Coverage at Child Levels"}),"\n",(0,s.jsx)(n.p,{children:"Child types may need different coverage requirements than roots:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'ctr annotate ... --gating-params \'{\n    "level_defaults": {\n        "0": {"min_coverage": 0.50},\n        "1": {"min_coverage": 0.35},\n        "2": {"min_coverage": 0.25}\n    }\n}\'\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Child types have fewer markers defined, or markers are more specific/sparse."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-23-add-distinguishing-markers",children:"Fix 2.3: Add Distinguishing Markers"}),"\n",(0,s.jsx)(n.p,{children:"Update your marker map with markers that distinguish child types:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "Epithelium": {\n        "markers": ["EPCAM", "KRT8", "KRT18"],\n        "children": {\n            "Ciliated Epithelium": {\n                "markers": ["FOXJ1", "TUBB4B", "DNAH5", "CCDC78"],\n                "anti_markers": ["MUC5B", "SCGB1A1"]\n            },\n            "Secretory Epithelium": {\n                "markers": ["MUC5B", "SCGB1A1", "MUC16"],\n                "anti_markers": ["FOXJ1", "TUBB4B"]\n            }\n        }\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Child types are biologically distinct but markers don't adequately capture the differences."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-24-check-child-marker-expression",children:"Fix 2.4: Check Child Marker Expression"}),"\n",(0,s.jsx)(n.p,{children:"Verify that expected markers for child types are actually expressed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"# For clusters stuck at \"Epithelium\"\nepithelial_clusters = adata[adata.obs['annotation'] == 'Epithelium']\n\n# Check ciliated markers\nciliated_markers = ['FOXJ1', 'TUBB4B', 'DNAH5']\nfor marker in ciliated_markers:\n    if marker in adata.var_names:\n        expr = epithelial_clusters[:, marker].X.toarray().flatten()\n        print(f\"{marker}: {(expr > 0).mean():.1%} positive\")\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"scenario-3-wrong-cell-types-assigned",children:"Scenario 3: Wrong Cell Types Assigned"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": High confidence but biologically incorrect assignments"]}),"\n",(0,s.jsx)(n.p,{children:"This is the most concerning scenario because it can lead to incorrect biological conclusions. It typically indicates that the marker definitions or anti-marker constraints are insufficient."}),"\n",(0,s.jsx)(n.h3,{id:"diagnostic-checklist-2",children:"Diagnostic Checklist"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Marker specificity"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Are assigned markers actually specific to that cell type in your tissue?"}),"\n",(0,s.jsx)(n.li,{children:"Could markers be expressed by multiple cell types?"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Anti-marker definitions"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Are there anti-markers defined that should prevent the assignment?"}),"\n",(0,s.jsxs)(n.li,{children:["Is ",(0,s.jsx)(n.code,{children:"anti_weight"})," high enough to penalize conflicting expression?"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Root veto markers"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Should certain markers completely block a root assignment?"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"primary-fixes-2",children:"Primary Fixes"}),"\n",(0,s.jsx)(n.h4,{id:"fix-31-add-anti-markers",children:"Fix 3.1: Add Anti-Markers"}),"\n",(0,s.jsx)(n.p,{children:"Anti-markers penalize scores when markers that should NOT be expressed are present:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "T Cells": {\n        "markers": ["CD3D", "CD3E", "CD3G"],\n        "anti_markers": ["CD19", "CD20", "MS4A1", "CD14", "CD68"]\n    },\n    "B Cells": {\n        "markers": ["CD19", "CD20", "MS4A1", "CD79A"],\n        "anti_markers": ["CD3D", "CD3E", "CD14", "CD68"]\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"fix-32-increase-anti-weight",children:"Fix 3.2: Increase Anti-Weight"}),"\n",(0,s.jsx)(n.p,{children:"Make anti-markers more impactful on the score:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Default is typically 0.5\n# Increase for stricter conflict handling\nctr annotate ... --scoring-params '{\"anti_weight\": 0.8}'\n\n# For very strict anti-marker enforcement\nctr annotate ... --scoring-params '{\"anti_weight\": 1.0}'\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Anti-markers are defined but wrong assignments still occur."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-33-add-root-hard-requirements",children:"Fix 3.3: Add Root Hard Requirements"}),"\n",(0,s.jsx)(n.p,{children:"Require specific markers for root assignment:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "_gating_params": {\n        "root_hard_requirements": {\n            "T Cells": {\n                "marker": "CD3D",\n                "min_pos_frac": 0.40,\n                "min_enrichment": 0.0\n            },\n            "B Cells": {\n                "marker": "CD19",\n                "min_pos_frac": 0.30,\n                "min_enrichment": 0.0\n            }\n        }\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Specific lineage markers are definitive for cell type identity."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-34-add-root-veto-markers",children:"Fix 3.4: Add Root Veto Markers"}),"\n",(0,s.jsx)(n.p,{children:"Completely block assignment when incompatible markers are expressed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "_gating_params": {\n        "root_veto_markers": {\n            "T Cells": {\n                "markers": ["CD19", "MS4A1"],\n                "max_pos_frac": 0.15\n            },\n            "B Cells": {\n                "markers": ["CD3D", "CD3E"],\n                "max_pos_frac": 0.15\n            },\n            "Epithelium": {\n                "markers": ["CD45"],\n                "max_pos_frac": 0.20\n            }\n        }\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Certain marker combinations are biologically impossible."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-35-change-anti-aggregation-method",children:"Fix 3.5: Change Anti-Aggregation Method"}),"\n",(0,s.jsx)(n.p,{children:"For stricter anti-marker handling:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Default is 'top2mean' (average of top 2 anti-markers)\n# Use 'max' for strictest enforcement\nctr annotate ... --scoring-params '{\"anti_agg\": \"max\"}'\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Even one strongly expressed anti-marker should disqualify the type."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"scenario-4-refinement-too-aggressive",children:"Scenario 4: Refinement Too Aggressive"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": Too many clusters being subclustered when they should be kept intact"]}),"\n",(0,s.jsx)(n.p,{children:"The refinement step identifies clusters that may benefit from additional subclustering. When too aggressive, this creates unnecessary fragmentation."}),"\n",(0,s.jsx)(n.h3,{id:"diagnostic-checklist-3",children:"Diagnostic Checklist"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Score threshold"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Is the heterogeneity score threshold too low?"}),"\n",(0,s.jsx)(n.li,{children:"Are many clusters just barely triggering refinement?"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Minimum cell counts"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Are small clusters being subclustered unnecessarily?"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Heterogeneity interpretation"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Is biological heterogeneity being confused with technical noise?"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"primary-fixes-3",children:"Primary Fixes"}),"\n",(0,s.jsx)(n.h4,{id:"fix-41-raise-score-threshold",children:"Fix 4.1: Raise Score Threshold"}),"\n",(0,s.jsx)(n.p,{children:"Higher thresholds mean only clearly heterogeneous clusters are flagged:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Default is 1.0\n# Raise for more conservative refinement\nctr annotate ... --refinement-params '{\"score_threshold\": 1.5}'\n\n# For very conservative refinement\nctr annotate ... --refinement-params '{\"score_threshold\": 2.0}'\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Many clusters are being flagged that appear homogeneous on inspection."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-42-increase-minimum-cell-requirement",children:"Fix 4.2: Increase Minimum Cell Requirement"}),"\n",(0,s.jsx)(n.p,{children:"Prevent subclustering of small clusters:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Default is 500\n# Raise for larger datasets\nctr annotate ... --refinement-params '{\"min_cells\": 1000}'\n\n# For very large datasets (> 100k cells)\nctr annotate ... --refinement-params '{\"min_cells\": 2000}'\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Small clusters are being unnecessarily fragmented."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-43-adjust-heterogeneity-gap",children:"Fix 4.3: Adjust Heterogeneity Gap"}),"\n",(0,s.jsx)(n.p,{children:"Control when relabeling is preferred over subclustering:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Default is 0.3\n# Higher values favor relabeling over subclustering\nctr annotate ... --refinement-params '{\"heterogeneity_gap\": 0.4}'\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": Clusters are being subclustered when a different label would be more appropriate."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-44-disable-refinement",children:"Fix 4.4: Disable Refinement"}),"\n",(0,s.jsx)(n.p,{children:"For initial exploration or when refinement is not needed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ctr annotate ... --skip-refinement\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": You want to focus on primary annotation without refinement complexity."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"scenario-5-refinement-too-conservative",children:"Scenario 5: Refinement Too Conservative"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Symptoms"}),": Heterogeneous clusters not being split when they should be"]}),"\n",(0,s.jsx)(n.p,{children:"The opposite of Scenario 4 - clusters that clearly contain multiple cell types are being kept together."}),"\n",(0,s.jsx)(n.h3,{id:"primary-fixes-4",children:"Primary Fixes"}),"\n",(0,s.jsx)(n.h4,{id:"fix-51-lower-score-threshold",children:"Fix 5.1: Lower Score Threshold"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Default is 1.0\n# Lower for more aggressive refinement\nctr annotate ... --refinement-params '{\"score_threshold\": 0.7}'\n"})}),"\n",(0,s.jsx)(n.h4,{id:"fix-52-lower-minimum-cell-requirement",children:"Fix 5.2: Lower Minimum Cell Requirement"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Allow smaller clusters to be flagged\nctr annotate ... --refinement-params '{\"min_cells\": 300}'\n"})}),"\n",(0,s.jsx)(n.h4,{id:"fix-53-lower-heterogeneity-gap",children:"Fix 5.3: Lower Heterogeneity Gap"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Lower values favor subclustering over relabeling\nctr annotate ... --refinement-params '{\"heterogeneity_gap\": 0.2}'\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"scenario-6-results-inconsistent-between-runs",children:"Scenario 6: Results Inconsistent Between Runs"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause"}),": GPU non-determinism in Leiden clustering"]}),"\n",(0,s.jsx)(n.p,{children:"When using GPU-accelerated clustering (via rapids-singlecell), results may vary slightly between runs due to floating-point non-determinism."}),"\n",(0,s.jsx)(n.h3,{id:"primary-fixes-5",children:"Primary Fixes"}),"\n",(0,s.jsx)(n.h4,{id:"fix-61-disable-gpu-for-reproducibility",children:"Fix 6.1: Disable GPU for Reproducibility"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Force CPU-based clustering\nctr annotate ... --no-gpu\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Trade-off"}),": Slower execution but perfectly reproducible results."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-62-fix-clustering-iterate-annotation",children:"Fix 6.2: Fix Clustering, Iterate Annotation"}),"\n",(0,s.jsx)(n.p,{children:"Run clustering once, then iterate on annotation parameters:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# First run - includes clustering\nctr annotate input.h5ad --output-dir run1/\n\n# Subsequent runs - use existing clustering\nctr annotate run1/output.h5ad --annotation-only --output-dir run2/\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"When to use"}),": You want to compare different annotation parameters without re-clustering."]}),"\n",(0,s.jsx)(n.h4,{id:"fix-63-set-random-seeds",children:"Fix 6.3: Set Random Seeds"}),"\n",(0,s.jsx)(n.p,{children:"While not guaranteed for GPU operations, setting seeds improves reproducibility:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ctr annotate ... --random-seed 42\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"scenario-7-high-confidence-but-biologically-wrong",children:"Scenario 7: High Confidence but Biologically Wrong"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue"}),": Markers may not be specific for your tissue"]}),"\n",(0,s.jsx)(n.p,{children:"Different tissues have different expression patterns. A marker highly specific in one tissue may be expressed by multiple types in another."}),"\n",(0,s.jsx)(n.h3,{id:"primary-fixes-6",children:"Primary Fixes"}),"\n",(0,s.jsx)(n.h4,{id:"fix-71-review-marker-map-for-tissue-appropriateness",children:"Fix 7.1: Review Marker Map for Tissue Appropriateness"}),"\n",(0,s.jsx)(n.p,{children:"Audit your marker map against known tissue biology:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# Load marker map\nimport json\nwith open("marker_map.json") as f:\n    markers = json.load(f)\n\n# List all markers for review\ndef list_all_markers(node, path=""):\n    all_markers = []\n    if "markers" in node:\n        for m in node["markers"]:\n            all_markers.append((path, m, "positive"))\n    if "anti_markers" in node:\n        for m in node["anti_markers"]:\n            all_markers.append((path, m, "anti"))\n    if "children" in node:\n        for child_name, child_node in node["children"].items():\n            all_markers.extend(list_all_markers(child_node, f"{path}/{child_name}"))\n    return all_markers\n\n# Review marker list\nfor path, marker, marker_type in list_all_markers(markers):\n    print(f"{path}: {marker} ({marker_type})")\n'})}),"\n",(0,s.jsx)(n.h4,{id:"fix-72-create-tissue-specific-marker-map",children:"Fix 7.2: Create Tissue-Specific Marker Map"}),"\n",(0,s.jsx)(n.p,{children:"Start with the default and customize for your tissue:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Export default marker map\nctr export-markers --output my_tissue_markers.json\n\n# Edit for your tissue\n# Then use your customized map\nctr annotate ... --marker-map my_tissue_markers.json\n"})}),"\n",(0,s.jsx)(n.h4,{id:"fix-73-add-tissue-specific-gating-parameters",children:"Fix 7.3: Add Tissue-Specific Gating Parameters"}),"\n",(0,s.jsx)(n.p,{children:"Include custom gating in your marker map:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "_gating_params": {\n        "root_hard_requirements": { ... },\n        "root_veto_markers": { ... }\n    },\n    "Immune Cells": { ... },\n    "Epithelium": { ... }\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"parameter-reference",children:"Parameter Reference"}),"\n",(0,s.jsx)(n.h3,{id:"scoring-parameters",children:"Scoring Parameters"}),"\n",(0,s.jsx)(n.p,{children:"These parameters control how marker scores are calculated."}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Range"}),(0,s.jsx)(n.th,{children:"Effect"}),(0,s.jsx)(n.th,{children:"When to Adjust"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"positive_quantile"})}),(0,s.jsx)(n.td,{children:"0.75"}),(0,s.jsx)(n.td,{children:"0.5-0.95"}),(0,s.jsx)(n.td,{children:"Percentile for positive expression threshold"}),(0,s.jsx)(n.td,{children:"Sparse data: lower to 0.5-0.6"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"de_bonus"})}),(0,s.jsx)(n.td,{children:"0.5-0.6"}),(0,s.jsx)(n.td,{children:"0.0-1.0"}),(0,s.jsx)(n.td,{children:"Weight for differential expression"}),(0,s.jsx)(n.td,{children:"Good DE results: increase to 0.7"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"anti_weight"})}),(0,s.jsx)(n.td,{children:"0.5-0.8"}),(0,s.jsx)(n.td,{children:"0.0-1.0"}),(0,s.jsx)(n.td,{children:"Penalty weight for anti-markers"}),(0,s.jsx)(n.td,{children:"Wrong assignments: increase"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"anti_agg"})}),(0,s.jsx)(n.td,{children:"top2mean"}),(0,s.jsx)(n.td,{children:"top2mean/max/mean"}),(0,s.jsx)(n.td,{children:"How to aggregate anti-markers"}),(0,s.jsx)(n.td,{children:"Strict: use max"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"coverage_weight"})}),(0,s.jsx)(n.td,{children:"0.3"}),(0,s.jsx)(n.td,{children:"0.0-1.0"}),(0,s.jsx)(n.td,{children:"Weight for marker coverage in score"}),(0,s.jsx)(n.td,{children:"Low panel coverage: decrease"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"detailed-parameter-explanations",children:"Detailed Parameter Explanations"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"positive_quantile"})}),': Determines the expression threshold for considering a marker "positive." A value of 0.75 means the threshold is set at the 75th percentile of non-zero expression. Lower values make it easier to be positive, higher values are more stringent.']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# For sparse spatial data\nctr annotate ... --scoring-params '{\"positive_quantile\": 0.50}'\n\n# For deep scRNA-seq\nctr annotate ... --scoring-params '{\"positive_quantile\": 0.85}'\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"de_bonus"})}),": Controls how much differential expression contributes to the score. Higher values emphasize markers that are specifically enriched in the cluster compared to background."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Emphasize DE\nctr annotate ... --scoring-params '{\"de_bonus\": 0.7}'\n\n# De-emphasize DE (rely more on absolute expression)\nctr annotate ... --scoring-params '{\"de_bonus\": 0.3}'\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"anti_weight"})}),': Controls the penalty applied when anti-markers are expressed. Higher values more strongly penalize "forbidden" marker expression.']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Moderate anti-marker penalty\nctr annotate ... --scoring-params '{\"anti_weight\": 0.5}'\n\n# Strong anti-marker penalty\nctr annotate ... --scoring-params '{\"anti_weight\": 0.9}'\n"})}),"\n",(0,s.jsx)(n.h3,{id:"gating-parameters",children:"Gating Parameters"}),"\n",(0,s.jsx)(n.p,{children:"These parameters control the hierarchical decision-making process."}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Level"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Effect"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"min_coverage"})}),(0,s.jsx)(n.td,{children:"0"}),(0,s.jsx)(n.td,{children:"0.50"}),(0,s.jsx)(n.td,{children:"Fraction of markers that must be positive"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"min_coverage"})}),(0,s.jsx)(n.td,{children:"1+"}),(0,s.jsx)(n.td,{children:"0.30-0.40"}),(0,s.jsx)(n.td,{children:"Generally lower at deeper levels"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"min_pos_frac"})}),(0,s.jsx)(n.td,{children:"0"}),(0,s.jsx)(n.td,{children:"0.30"}),(0,s.jsx)(n.td,{children:"Fraction of cells positive for counted markers"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"min_gap"})}),(0,s.jsx)(n.td,{children:"all"}),(0,s.jsx)(n.td,{children:"0.20-0.50"}),(0,s.jsx)(n.td,{children:"Required score gap between top candidates"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"max_ambiguity"})}),(0,s.jsx)(n.td,{children:"all"}),(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:"Maximum types within gap to still proceed"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"level-specific-configuration",children:"Level-Specific Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Configure each level separately\nctr annotate ... --gating-params \'{\n    "level_defaults": {\n        "0": {\n            "min_coverage": 0.50,\n            "min_pos_frac": 0.30,\n            "min_gap": 0.40\n        },\n        "1": {\n            "min_coverage": 0.40,\n            "min_pos_frac": 0.25,\n            "min_gap": 0.30\n        },\n        "2": {\n            "min_coverage": 0.30,\n            "min_pos_frac": 0.20,\n            "min_gap": 0.20\n        }\n    }\n}\'\n'})}),"\n",(0,s.jsx)(n.h3,{id:"refinement-parameters",children:"Refinement Parameters"}),"\n",(0,s.jsx)(n.p,{children:"These parameters control the refinement step that identifies heterogeneous clusters."}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Range"}),(0,s.jsx)(n.th,{children:"Effect"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"score_threshold"})}),(0,s.jsx)(n.td,{children:"1.0"}),(0,s.jsx)(n.td,{children:"0.5-3.0"}),(0,s.jsx)(n.td,{children:"Heterogeneity score to trigger refinement"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"min_cells"})}),(0,s.jsx)(n.td,{children:"500"}),(0,s.jsx)(n.td,{children:"100-5000"}),(0,s.jsx)(n.td,{children:"Minimum cluster size for refinement"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"heterogeneity_gap"})}),(0,s.jsx)(n.td,{children:"0.3"}),(0,s.jsx)(n.td,{children:"0.1-0.5"}),(0,s.jsx)(n.td,{children:"Gap to prefer relabel over subcluster"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"max_iterations"})}),(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:"1-5"}),(0,s.jsx)(n.td,{children:"Maximum refinement iterations"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"combined-refinement-configuration",children:"Combined Refinement Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Conservative refinement\nctr annotate ... --refinement-params \'{\n    "score_threshold": 1.5,\n    "min_cells": 1000,\n    "heterogeneity_gap": 0.4,\n    "max_iterations": 2\n}\'\n\n# Aggressive refinement\nctr annotate ... --refinement-params \'{\n    "score_threshold": 0.7,\n    "min_cells": 300,\n    "heterogeneity_gap": 0.2,\n    "max_iterations": 5\n}\'\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"tissue-specific-configuration",children:"Tissue-Specific Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"adding-gating-parameters-to-marker-map",children:"Adding Gating Parameters to Marker Map"}),"\n",(0,s.jsxs)(n.p,{children:["The marker map can include a ",(0,s.jsx)(n.code,{children:"_gating_params"})," section for tissue-specific configuration:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "_gating_params": {\n        "root_hard_requirements": {\n            "Immune Cells": {\n                "marker": "CD45",\n                "min_pos_frac": 0.30,\n                "min_enrichment": 0.0\n            },\n            "Epithelium": {\n                "marker": "EPCAM",\n                "min_pos_frac": 0.40,\n                "min_enrichment": 0.0\n            }\n        },\n        "root_veto_markers": {\n            "Immune Cells": {\n                "markers": ["Pan-Cytokeratin", "E-cadherin", "EPCAM"],\n                "max_pos_frac": 0.20\n            },\n            "Epithelium": {\n                "markers": ["CD45", "CD3D", "CD19"],\n                "max_pos_frac": 0.15\n            }\n        },\n        "level_defaults": {\n            "0": {"min_coverage": 0.45},\n            "1": {"min_coverage": 0.35}\n        }\n    },\n    "Immune Cells": { ... },\n    "Epithelium": { ... }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"example-fallopian-tube-configuration",children:"Example: Fallopian Tube Configuration"}),"\n",(0,s.jsx)(n.p,{children:"The fallopian tube presents unique challenges for cell type annotation:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mixed epithelial populations"}),": Ciliated and secretory cells intermingle"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Stromal complexity"}),": Multiple fibroblast subtypes with overlapping markers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Immune infiltration"}),": Variable immune cell populations"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Hormonal influence"}),": Expression patterns vary with menstrual cycle"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"recommended-configuration",children:"Recommended Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "_gating_params": {\n        "root_hard_requirements": {\n            "Epithelium": {\n                "marker": "EPCAM",\n                "min_pos_frac": 0.50,\n                "min_enrichment": 0.0\n            },\n            "Immune Cells": {\n                "marker": "PTPRC",\n                "min_pos_frac": 0.35,\n                "min_enrichment": 0.0\n            }\n        },\n        "root_veto_markers": {\n            "Epithelium": {\n                "markers": ["PTPRC", "VIM"],\n                "max_pos_frac": 0.25\n            },\n            "Fibroblasts": {\n                "markers": ["EPCAM", "PTPRC"],\n                "max_pos_frac": 0.15\n            }\n        },\n        "level_defaults": {\n            "0": {\n                "min_coverage": 0.45,\n                "min_pos_frac": 0.30,\n                "min_gap": 0.35\n            },\n            "1": {\n                "min_coverage": 0.35,\n                "min_pos_frac": 0.25,\n                "min_gap": 0.25\n            }\n        }\n    },\n    "Epithelium": {\n        "markers": ["EPCAM", "KRT8", "KRT18", "CDH1"],\n        "children": {\n            "Ciliated Epithelium": {\n                "markers": ["FOXJ1", "TUBB4B", "DNAH5", "CAPS", "PIFO"],\n                "anti_markers": ["MUC5B", "SCGB2A1", "OVGP1"]\n            },\n            "Secretory Epithelium": {\n                "markers": ["PAX8", "MUC16", "OVGP1", "SCGB2A1"],\n                "anti_markers": ["FOXJ1", "TUBB4B", "CAPS"]\n            }\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"why-these-settings-work",children:"Why These Settings Work"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"EPCAM hard requirement for Epithelium"}),": Ensures epithelial clusters truly express this definitive marker"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"PTPRC (CD45) for Immune"}),": Standard pan-immune marker"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"VIM veto for Epithelium"}),": Prevents stromal contamination (though some epithelial-mesenchymal transition cells express VIM)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Lower coverage at level 1"}),": Allows ciliated/secretory distinction even with partial marker panels"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Anti-markers for ciliated/secretory"}),": Provides mutual exclusion between these related types"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-lung-configuration",children:"Example: Lung Configuration"}),"\n",(0,s.jsx)(n.p,{children:"Lung tissue has distinct challenges:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Diverse epithelium"}),": AT1, AT2, club, ciliated, basal cells"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Immune complexity"}),": Alveolar macrophages, interstitial macrophages"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Endothelial diversity"}),": Arterial, venous, capillary subtypes"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "_gating_params": {\n        "root_hard_requirements": {\n            "Epithelium": {\n                "marker": "EPCAM",\n                "min_pos_frac": 0.40,\n                "min_enrichment": 0.0\n            },\n            "Endothelium": {\n                "marker": "PECAM1",\n                "min_pos_frac": 0.50,\n                "min_enrichment": 0.0\n            }\n        },\n        "root_veto_markers": {\n            "Epithelium": {\n                "markers": ["PTPRC", "PECAM1"],\n                "max_pos_frac": 0.15\n            },\n            "Macrophages": {\n                "markers": ["EPCAM", "CD3D"],\n                "max_pos_frac": 0.10\n            }\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"example-tumor-microenvironment",children:"Example: Tumor Microenvironment"}),"\n",(0,s.jsx)(n.p,{children:"Tumor samples present additional challenges:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Aberrant expression"}),": Cancer cells may express unexpected markers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mixed populations"}),": Tumor heterogeneity creates complex clusters"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Immune exhaustion"}),": Immune markers may be downregulated"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "_gating_params": {\n        "root_hard_requirements": {\n            "T Cells": {\n                "marker": "CD3D",\n                "min_pos_frac": 0.25,\n                "min_enrichment": 0.0\n            }\n        },\n        "level_defaults": {\n            "0": {\n                "min_coverage": 0.35,\n                "min_pos_frac": 0.20\n            }\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"iterative-tuning-workflow",children:"Iterative Tuning Workflow"}),"\n",(0,s.jsx)(n.h3,{id:"step-1-initial-run-with-defaults",children:"Step 1: Initial Run with Defaults"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ctr annotate input.h5ad --output-dir run_v1/\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-2-evaluate-results",children:"Step 2: Evaluate Results"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"import pandas as pd\n\n# Load results\nresults = pd.read_csv(\"run_v1/cluster_annotations.csv\")\n\n# Check assignment distribution\nprint(results['final_annotation'].value_counts())\n\n# Check stop reasons\nprint(results['stop_reason'].value_counts())\n\n# Identify problematic clusters\nunassigned = results[results['final_annotation'] == 'Unassigned']\nprint(f\"Unassigned clusters: {len(unassigned)}\")\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-3-diagnose-issues",children:"Step 3: Diagnose Issues"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"# For unassigned clusters, check coverage scores\ndetails = pd.read_csv(\"run_v1/gating_details.csv\")\nfor cluster in unassigned['cluster']:\n    cluster_details = details[details['cluster'] == cluster]\n    print(f\"\\n{cluster}:\")\n    print(cluster_details[['root_type', 'coverage', 'pos_frac', 'score']])\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-4-apply-targeted-fixes",children:"Step 4: Apply Targeted Fixes"}),"\n",(0,s.jsx)(n.p,{children:"Based on diagnosis, apply appropriate fixes (see scenarios above)."}),"\n",(0,s.jsx)(n.h3,{id:"step-5-re-run-and-compare",children:"Step 5: Re-run and Compare"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Use annotation-only to skip re-clustering\nctr annotate run_v1/output.h5ad \\\n    --annotation-only \\\n    --gating-params \'{"level_defaults": {"0": {"min_coverage": 0.35}}}\' \\\n    --output-dir run_v2/\n'})}),"\n",(0,s.jsx)(n.h3,{id:"step-6-validate-improvements",children:"Step 6: Validate Improvements"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"# Compare versions\nv1 = pd.read_csv(\"run_v1/cluster_annotations.csv\")\nv2 = pd.read_csv(\"run_v2/cluster_annotations.csv\")\n\n# Check if unassigned reduced\nprint(f\"V1 unassigned: {(v1['final_annotation'] == 'Unassigned').sum()}\")\nprint(f\"V2 unassigned: {(v2['final_annotation'] == 'Unassigned').sum()}\")\n\n# Check for new issues\nchanged = v1.merge(v2, on='cluster', suffixes=('_v1', '_v2'))\nchanged = changed[changed['final_annotation_v1'] != changed['final_annotation_v2']]\nprint(f\"Changed assignments: {len(changed)}\")\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"common-parameter-combinations",children:"Common Parameter Combinations"}),"\n",(0,s.jsx)(n.h3,{id:"sparse-data-spatial-transcriptomics",children:"Sparse Data (Spatial Transcriptomics)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'ctr annotate ... \\\n    --scoring-params \'{"positive_quantile": 0.50}\' \\\n    --gating-params \'{\n        "level_defaults": {\n            "0": {"min_coverage": 0.30, "min_pos_frac": 0.15},\n            "1": {"min_coverage": 0.20, "min_pos_frac": 0.10}\n        }\n    }\'\n'})}),"\n",(0,s.jsx)(n.h3,{id:"high-quality-deep-scrna-seq",children:"High-Quality Deep scRNA-seq"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'ctr annotate ... \\\n    --scoring-params \'{"positive_quantile": 0.80, "de_bonus": 0.7}\' \\\n    --gating-params \'{\n        "level_defaults": {\n            "0": {"min_coverage": 0.55, "min_gap": 0.45},\n            "1": {"min_coverage": 0.45, "min_gap": 0.35}\n        }\n    }\'\n'})}),"\n",(0,s.jsx)(n.h3,{id:"heterogeneous-tumor-samples",children:"Heterogeneous Tumor Samples"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'ctr annotate ... \\\n    --scoring-params \'{"anti_weight": 0.8}\' \\\n    --gating-params \'{\n        "level_defaults": {\n            "0": {"min_coverage": 0.35, "min_pos_frac": 0.20}\n        }\n    }\' \\\n    --refinement-params \'{"score_threshold": 0.8, "min_cells": 300}\'\n'})}),"\n",(0,s.jsx)(n.h3,{id:"conservative-annotation-high-precision",children:"Conservative Annotation (High Precision)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'ctr annotate ... \\\n    --scoring-params \'{"anti_weight": 0.9, "anti_agg": "max"}\' \\\n    --gating-params \'{\n        "level_defaults": {\n            "0": {"min_coverage": 0.55, "min_gap": 0.50}\n        }\n    }\' \\\n    --refinement-params \'{"score_threshold": 1.5}\'\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/marker-scoring-algorithm",children:"Marker Scoring Algorithm"})," - Understand scoring components"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm",children:"Hierarchical Gating Algorithm"})," - Understand gating thresholds"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/refinement-decision-logic",children:"Refinement Decision Logic"})," - Understand heterogeneity detection"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/annotation-pipeline",children:"Annotation Pipeline"})," - End-to-end workflow understanding"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453(e,n,i){i.d(n,{R:()=>t,x:()=>l});var r=i(6540);const s={},a=r.createContext(s);function t(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);