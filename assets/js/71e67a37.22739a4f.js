"use strict";(globalThis.webpackChunkcelltype_refinery_docs=globalThis.webpackChunkcelltype_refinery_docs||[]).push([[3836],{8453(e,n,i){i.d(n,{R:()=>t,x:()=>a});var r=i(6540);const s={},l=r.createContext(s);function t(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(l.Provider,{value:n},e.children)}},9593(e,n,i){i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"modules/annotation/overview","title":"Annotation Overview","description":"The annotation module assigns cell types using hierarchical marker-based gating. It processes clustered single-cell data against a structured marker map to produce biologically meaningful cell type labels.","source":"@site/docs/modules/annotation/overview.md","sourceDirName":"modules/annotation","slug":"/modules/annotation/overview","permalink":"/CellType-Refinery/docs/modules/annotation/overview","draft":false,"unlisted":false,"editUrl":"https://github.com/kuang-da/CellType-Refinery/tree/main/celltype-refinery-docs/docs/modules/annotation/overview.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Differential Expression","permalink":"/CellType-Refinery/docs/modules/clustering/differential-expression"},"next":{"title":"Marker Maps","permalink":"/CellType-Refinery/docs/modules/annotation/marker-maps"}}');var s=i(4848),l=i(8453);const t={sidebar_position:1},a="Annotation Overview",o={},c=[{value:"Pipeline Overview",id:"pipeline-overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Key Components",id:"key-components",level:2},{value:"Marker Loading (<code>marker_loading.py</code>)",id:"marker-loading-marker_loadingpy",level:3},{value:"Marker Scoring (<code>scoring.py</code>)",id:"marker-scoring-scoringpy",level:3},{value:"Hierarchical Gating (<code>gating.py</code>)",id:"hierarchical-gating-gatingpy",level:3},{value:"Label Assignment (<code>assignment.py</code>)",id:"label-assignment-assignmentpy",level:3},{value:"Per-Cell Voting",id:"per-cell-voting",level:3},{value:"Export (<code>export.py</code>)",id:"export-exportpy",level:3},{value:"Quick Reference",id:"quick-reference",level:2},{value:"Key Parameters",id:"key-parameters",level:3},{value:"Output Files",id:"output-files",level:3},{value:"CLI Usage",id:"cli-usage",level:2},{value:"Basic Command",id:"basic-command",level:3},{value:"Common Options",id:"common-options",level:3},{value:"Parameter Descriptions",id:"parameter-descriptions",level:3},{value:"See Also",id:"see-also",level:2},{value:"Module Documentation",id:"module-documentation",level:3},{value:"Methodology Reference",id:"methodology-reference",level:3},{value:"Related Guides",id:"related-guides",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"annotation-overview",children:"Annotation Overview"})}),"\n",(0,s.jsx)(n.p,{children:"The annotation module assigns cell types using hierarchical marker-based gating. It processes clustered single-cell data against a structured marker map to produce biologically meaningful cell type labels."}),"\n",(0,s.jsxs)(n.admonition,{title:"Deep Dive",type:"tip",children:[(0,s.jsxs)(n.p,{children:["For comprehensive algorithm details, see the ",(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/",children:"Methodology section"}),":"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/marker-scoring-algorithm",children:"Marker Scoring Algorithm"})," - Complete formula breakdown"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm",children:"Hierarchical Gating Algorithm"})," - Assignment logic"]}),"\n"]})]}),"\n",(0,s.jsx)(n.h2,{id:"pipeline-overview",children:"Pipeline Overview"}),"\n",(0,s.jsx)(n.p,{children:"The annotation pipeline flows through several distinct stages, from loading marker definitions to exporting final results:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         ANNOTATION PIPELINE                                  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                             \u2502\n\u2502   Marker Map JSON \u2500\u2500\u252c\u2500\u2500\u25ba Load & Resolve \u2500\u2500\u25ba Compute Scores \u2500\u2500\u25ba Assign      \u2502\n\u2502                     \u2502        Markers           per cluster     Labels       \u2502\n\u2502   Clustered .h5ad \u2500\u2500\u2518                              \u2502             \u2502          \u2502\n\u2502                                                    \u2502             \u25bc          \u2502\n\u2502                                                    \u2502      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502                                                    \u2502      \u2502 Per-Cell   \u2502    \u2502\n\u2502                                                    \u2502      \u2502 Voting     \u2502    \u2502\n\u2502                                                    \u2502      \u2502 (evidence) \u2502    \u2502\n\u2502                                                    \u2502      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                                                    \u25bc             \u2502          \u2502\n\u2502                                              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502          \u2502\n\u2502                                              \u2502 Export CSVs \u2502\u25c4\u2500\u2500\u2500\u2500\u2518          \u2502\n\u2502                                              \u2502 + AnnData   \u2502                \u2502\n\u2502                                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.mermaid,{value:"flowchart TB\n    A[Marker Map] --\x3e B[Load Markers]\n    B --\x3e C[Compute Scores]\n    C --\x3e D[Hierarchical Gating]\n    D --\x3e E[Label Assignment]\n    E --\x3e F[Export Results]"}),"\n",(0,s.jsx)(n.h2,{id:"key-components",children:"Key Components"}),"\n",(0,s.jsx)(n.p,{children:"The annotation module is organized into several interconnected components:"}),"\n",(0,s.jsxs)(n.h3,{id:"marker-loading-marker_loadingpy",children:["Marker Loading (",(0,s.jsx)(n.code,{children:"marker_loading.py"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Parses hierarchical JSON marker maps and prepares them for scoring. Key responsibilities:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Parse nested JSON structure into internal hierarchy representation"}),"\n",(0,s.jsx)(n.li,{children:"Resolve gene aliases to canonical names using the alias database"}),"\n",(0,s.jsx)(n.li,{children:"Handle missing markers gracefully with warnings"}),"\n",(0,s.jsx)(n.li,{children:"Validate marker map structure and report errors"}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"marker-scoring-scoringpy",children:["Marker Scoring (",(0,s.jsx)(n.code,{children:"scoring.py"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Computes expression-based scores for each cluster against each cell type definition. The scoring combines multiple signals:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Enrichment score"}),": Log fold-change of expression vs. background"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Positive fraction"}),": Percentage of cells expressing the marker above threshold"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"DE bonus"}),": Additional weight for differentially expressed markers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Anti-penalty"}),": Score reduction when anti-markers are expressed"]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"hierarchical-gating-gatingpy",children:["Hierarchical Gating (",(0,s.jsx)(n.code,{children:"gating.py"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Implements top-down traversal through the cell type hierarchy:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Start at root nodes (e.g., Immune, Stromal, Epithelial)"}),"\n",(0,s.jsx)(n.li,{children:"At each level, check gate conditions before descending"}),"\n",(0,s.jsx)(n.li,{children:"Apply minimum score thresholds at branch points"}),"\n",(0,s.jsx)(n.li,{children:"Track path through hierarchy for audit purposes"}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"label-assignment-assignmentpy",children:["Label Assignment (",(0,s.jsx)(n.code,{children:"assignment.py"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Maps the winning cell type label from each cluster to individual cells:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Propagate cluster-level labels to all cells in each cluster"}),"\n",(0,s.jsxs)(n.li,{children:["Store both the label and confidence score in ",(0,s.jsx)(n.code,{children:"adata.obs"})]}),"\n",(0,s.jsx)(n.li,{children:"Record the full hierarchical path for each assignment"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"per-cell-voting",children:"Per-Cell Voting"}),"\n",(0,s.jsx)(n.p,{children:"Collects evidence at the single-cell level for ambiguous clusters:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Aggregates marker evidence across individual cells"}),"\n",(0,s.jsx)(n.li,{children:"Provides additional confidence metrics for borderline cases"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Important"}),": Does NOT override cluster-level labels; serves as supplementary evidence only"]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"export-exportpy",children:["Export (",(0,s.jsx)(n.code,{children:"export.py"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Generates output files for downstream analysis and review:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CSV files with cluster-to-label mappings"}),"\n",(0,s.jsx)(n.li,{children:"Audit cards summarizing evidence for each assignment"}),"\n",(0,s.jsx)(n.li,{children:"Review checklists highlighting low-confidence annotations"}),"\n",(0,s.jsxs)(n.li,{children:["Updated AnnData object with annotations in ",(0,s.jsx)(n.code,{children:".obs"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"quick-reference",children:"Quick Reference"}),"\n",(0,s.jsx)(n.h3,{id:"key-parameters",children:"Key Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--min-score"})}),(0,s.jsx)(n.td,{children:"0.3"}),(0,s.jsx)(n.td,{children:"Minimum composite score to accept a cell type assignment"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--min-positive-frac"})}),(0,s.jsx)(n.td,{children:"0.1"}),(0,s.jsx)(n.td,{children:"Minimum fraction of cells expressing marker"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--anti-weight"})}),(0,s.jsx)(n.td,{children:"0.5"}),(0,s.jsx)(n.td,{children:"Penalty multiplier for anti-marker expression"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--de-bonus"})}),(0,s.jsx)(n.td,{children:"0.2"}),(0,s.jsx)(n.td,{children:"Bonus added for differentially expressed markers"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--gate-threshold"})}),(0,s.jsx)(n.td,{children:"0.5"}),(0,s.jsx)(n.td,{children:"Score threshold for passing hierarchical gates"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--resolve-aliases"})}),(0,s.jsx)(n.td,{children:"true"}),(0,s.jsx)(n.td,{children:"Whether to resolve gene aliases automatically"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"output-files",children:"Output Files"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"cluster_labels.csv"})}),(0,s.jsx)(n.td,{children:"Cluster ID to cell type mapping"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"cell_annotations.csv"})}),(0,s.jsx)(n.td,{children:"Per-cell annotations with confidence"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"audit_cards.json"})}),(0,s.jsx)(n.td,{children:"Detailed evidence for each assignment"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"review_checklist.csv"})}),(0,s.jsx)(n.td,{children:"Low-confidence annotations for manual review"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"annotated.h5ad"})}),(0,s.jsx)(n.td,{children:"Full AnnData with annotations"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"cli-usage",children:"CLI Usage"}),"\n",(0,s.jsx)(n.h3,{id:"basic-command",children:"Basic Command"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"celltype-refinery annotate \\\n  --input clustered.h5ad \\\n  --marker-map markers.json \\\n  --out output/annotated\n"})}),"\n",(0,s.jsx)(n.h3,{id:"common-options",children:"Common Options"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"celltype-refinery annotate \\\n  --input clustered.h5ad \\\n  --marker-map markers.json \\\n  --out output/annotated \\\n  --min-score 0.25 \\\n  --min-positive-frac 0.15 \\\n  --anti-weight 0.6 \\\n  --gate-threshold 0.4 \\\n  --cluster-key leiden_1.0 \\\n  --resolve-aliases \\\n  --export-audit-cards \\\n  --verbose\n"})}),"\n",(0,s.jsx)(n.h3,{id:"parameter-descriptions",children:"Parameter Descriptions"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--input"}),": Path to clustered AnnData file (.h5ad)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--marker-map"}),": Path to hierarchical marker map JSON"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--out"}),": Output directory prefix"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--min-score"}),": Lower values increase sensitivity but may reduce specificity"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--min-positive-frac"}),": Adjust based on expected dropout rate in your data"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--anti-weight"}),": Higher values more strongly penalize anti-marker expression"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--cluster-key"}),": Column in ",(0,s.jsx)(n.code,{children:"adata.obs"})," containing cluster assignments"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--resolve-aliases"}),": Enable automatic gene alias resolution"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--export-audit-cards"}),": Generate detailed evidence files for review"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--verbose"}),": Enable detailed logging output"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,s.jsx)(n.h3,{id:"module-documentation",children:"Module Documentation"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/modules/annotation/marker-scoring",children:"Marker Scoring"})," - Detailed scoring methodology and configuration"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/modules/annotation/hierarchical-gating",children:"Hierarchical Gating"})," - Gate logic and traversal strategies"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/modules/annotation/exports",children:"Exports"})," - Output file formats and customization"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"methodology-reference",children:"Methodology Reference"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/marker-scoring-algorithm",children:"Marker Scoring Algorithm"})," - Complete mathematical formulation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm",children:"Hierarchical Gating Algorithm"})," - Formal algorithm specification"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"related-guides",children:"Related Guides"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/tuning-guide",children:"Tuning Guide"})," - Parameter optimization strategies"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/configuration/marker-maps",children:"Marker Maps Configuration"})," - JSON schema and examples"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);