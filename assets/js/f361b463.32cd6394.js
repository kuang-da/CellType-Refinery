"use strict";(globalThis.webpackChunkcelltype_refinery_docs=globalThis.webpackChunkcelltype_refinery_docs||[]).push([[7202],{4494(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"methodology/refinement-decision-logic","title":"Refinement Decision Logic","description":"This page explains Stage I refinement criteria. For initial annotation, see Hierarchical Gating first.","source":"@site/docs/methodology/refinement-decision-logic.md","sourceDirName":"methodology","slug":"/methodology/refinement-decision-logic","permalink":"/CellType-Refinery/docs/methodology/refinement-decision-logic","draft":false,"unlisted":false,"editUrl":"https://github.com/kuang-da/CellType-Refinery/tree/main/celltype-refinery-docs/docs/methodology/refinement-decision-logic.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"docsSidebar","previous":{"title":"Hierarchical Gating Algorithm","permalink":"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm"},"next":{"title":"Tuning Guide","permalink":"/CellType-Refinery/docs/methodology/tuning-guide"}}');var s=i(4848),t=i(8453);const l={sidebar_position:5},o="Refinement Decision Logic",c={},a=[{value:"Overview: The Refinement Question",id:"overview-the-refinement-question",level:2},{value:"AutoPolicy Selection Criteria",id:"autopolicy-selection-criteria",level:2},{value:"Criterion 1: Low Confidence",id:"criterion-1-low-confidence",level:3},{value:"Criterion 2a: Homogeneous Parent",id:"criterion-2a-homogeneous-parent",level:3},{value:"Criterion 2b: Heterogeneous Parent",id:"criterion-2b-heterogeneous-parent",level:3},{value:"Criterion 3: Mixed Population (Extension)",id:"criterion-3-mixed-population-extension",level:3},{value:"Criterion 4: Weak Leaf (Extension)",id:"criterion-4-weak-leaf-extension",level:3},{value:"Decision Flowchart",id:"decision-flowchart",level:2},{value:"Operation Types",id:"operation-types",level:2},{value:"Operation Details",id:"operation-details",level:3},{value:"Diagnostic vs Execution Mode",id:"diagnostic-vs-execution-mode",level:2},{value:"Diagnostic Mode",id:"diagnostic-mode",level:3},{value:"Execution Mode",id:"execution-mode",level:3},{value:"Iterative Refinement",id:"iterative-refinement",level:2},{value:"Convergence Criteria",id:"convergence-criteria",level:3},{value:"Lineage Tracking",id:"lineage-tracking",level:3},{value:"Configuration Reference",id:"configuration-reference",level:2},{value:"AutoPolicy Parameters",id:"autopolicy-parameters",level:3},{value:"ManualPolicy YAML Format",id:"manualpolicy-yaml-format",level:3},{value:"See Also",id:"see-also",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"refinement-decision-logic",children:"Refinement Decision Logic"})}),"\n",(0,s.jsx)(n.admonition,{title:"Prerequisites",type:"info",children:(0,s.jsxs)(n.p,{children:["This page explains Stage I refinement criteria. For initial annotation, see ",(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm",children:"Hierarchical Gating"})," first."]})}),"\n",(0,s.jsx)(n.h2,{id:"overview-the-refinement-question",children:"Overview: The Refinement Question"}),"\n",(0,s.jsx)(n.p,{children:"Stage H produces initial annotations. Some clusters are confident, others need refinement."}),"\n",(0,s.jsxs)(n.p,{children:["The key question: ",(0,s.jsx)(n.strong,{children:"SUBCLUSTER (re-cluster) or RELABEL (instant reassignment)?"})]}),"\n",(0,s.jsx)(n.p,{children:"This decision determines whether a cluster undergoes computational re-clustering to discover\nhidden subpopulations, or receives a simple label update based on existing evidence. Making\nthe wrong choice wastes computational resources or misses biological signal."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        POLICY-BASED ARCHITECTURE                \u2502\n\u2502                                                                 \u2502\n\u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502\n\u2502    \u2502   AutoPolicy    \u2502         \u2502  ManualPolicy   \u2502              \u2502\n\u2502    \u2502  (--auto flag)  \u2502         \u2502 (--config YAML) \u2502              \u2502\n\u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502\n\u2502             \u2502                           \u2502                       \u2502\n\u2502             \u25bc                           \u25bc                       \u2502\n\u2502        base_plan                   overlay_plan                 \u2502\n\u2502             \u2502                           \u2502                       \u2502\n\u2502             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                       \u2502\n\u2502                         \u25bc                                       \u2502\n\u2502              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                            \u2502\n\u2502              \u2502    merge_plans()    \u2502                            \u2502\n\u2502              \u2502  (overlay wins on   \u2502                            \u2502\n\u2502              \u2502   conflicts)        \u2502                            \u2502\n\u2502              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                            \u2502\n\u2502                         \u25bc                                       \u2502\n\u2502                    merged_plan                                  \u2502\n\u2502                         \u2502                                       \u2502\n\u2502                         \u25bc                                       \u2502\n\u2502              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                            \u2502\n\u2502              \u2502  RefinementEngine   \u2502                            \u2502\n\u2502              \u2502  (execute plan on   \u2502                            \u2502\n\u2502              \u2502   AnnData object)   \u2502                            \u2502\n\u2502              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                            \u2502\n\u2502                         \u25bc                                       \u2502\n\u2502                      Output                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.p,{children:"The architecture separates policy definition from execution. AutoPolicy provides algorithmic\nrecommendations while ManualPolicy allows expert overrides. Both produce plans that merge\nbefore execution."}),"\n",(0,s.jsx)(n.h2,{id:"autopolicy-selection-criteria",children:"AutoPolicy Selection Criteria"}),"\n",(0,s.jsx)(n.p,{children:"AutoPolicy evaluates each cluster against a series of criteria to determine the appropriate\nrefinement action. These criteria are evaluated in order, with the first matching criterion\ndetermining the action."}),"\n",(0,s.jsx)(n.h3,{id:"criterion-1-low-confidence",children:"Criterion 1: Low Confidence"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"IF score < score_threshold (default: 1.0)\nAND n_cells >= min_cells (default: 500)\n\u2192 SUBCLUSTER\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rationale"}),": Large, poorly-scoring clusters likely contain mixed populations. Subclustering\nmay reveal hidden subpopulations."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Implementation Details"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The score threshold is configurable via ",(0,s.jsx)(n.code,{children:"--score-threshold"})]}),"\n",(0,s.jsx)(n.li,{children:"Minimum cell count prevents fragmenting small clusters into noise"}),"\n",(0,s.jsx)(n.li,{children:"Score is computed from the hierarchical gating algorithm output"}),"\n",(0,s.jsx)(n.li,{children:"Clusters below this threshold show weak marker expression patterns"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Example Scenario"}),':\nA cluster of 2,000 cells labeled "Immune" has a score of 0.6. This suggests the marker\nsignature is ambiguous. Subclustering may reveal distinct T-cell and B-cell populations\nthat were merged due to insufficient resolution.']}),"\n",(0,s.jsx)(n.h3,{id:"criterion-2a-homogeneous-parent",children:"Criterion 2a: Homogeneous Parent"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:'IF assigned at parent level (e.g., "Epithelium" not "Ciliated Epithelium")\nAND best_child_score > subtype_signal_threshold (default: 0.5)\nAND (only_one_passing_child OR gap_to_runner_up >= heterogeneity_gap)\n\u2192 RELABEL to best child\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rationale"}),": Clear subtype signal with no competition. No need to re-cluster - instant\nrelabel is sufficient."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Parameters"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"subtype_signal_threshold"}),": Minimum score for a child to be considered viable (default: 0.5)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"heterogeneity_gap"}),": Required score difference between top candidates (default: 0.3)"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Example Scenario"}),':\nA cluster labeled "Epithelium" shows a child score of 0.85 for "Ciliated Epithelium" and\n0.3 for "Secretory Epithelium". The gap of 0.55 exceeds the threshold of 0.3, so the\ncluster is relabeled to "Ciliated Epithelium" without re-clustering.']}),"\n",(0,s.jsx)(n.h3,{id:"criterion-2b-heterogeneous-parent",children:"Criterion 2b: Heterogeneous Parent"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"IF assigned at parent level\nAND best_child_score > subtype_signal_threshold\nAND multiple_passing_children\nAND gap < heterogeneity_gap (default: 0.3)\n\u2192 SUBCLUSTER\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rationale"}),": Competing child signals suggest a mixed population. Subclustering should\nseparate the different cell types."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Detection Logic"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Count children with scores above ",(0,s.jsx)(n.code,{children:"subtype_signal_threshold"})]}),"\n",(0,s.jsx)(n.li,{children:"If more than one child passes AND"}),"\n",(0,s.jsxs)(n.li,{children:["The difference between top two is less than ",(0,s.jsx)(n.code,{children:"heterogeneity_gap"})]}),"\n",(0,s.jsx)(n.li,{children:"The cluster contains mixed populations requiring separation"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Example Scenario"}),':\nA cluster labeled "T Cell" has child scores of 0.7 for "CD4+ T Cell" and 0.65 for\n"CD8+ T Cell". Both exceed the threshold, and the gap of 0.05 is below 0.3. This\nindicates a mix of CD4+ and CD8+ T cells that subclustering can separate.']}),"\n",(0,s.jsx)(n.h3,{id:"criterion-3-mixed-population-extension",children:"Criterion 3: Mixed Population (Extension)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"IF parent has high score\nAND all children below subtype_signal_threshold\n\u2192 SUBCLUSTER\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rationale"}),": Strong parent signal but weak children = novel subtype or noise that needs\ninvestigation."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Biological Interpretation"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The cells clearly belong to the parent category (strong marker expression)"}),"\n",(0,s.jsx)(n.li,{children:"No known child subtype matches the expression pattern"}),"\n",(0,s.jsxs)(n.li,{children:["Possibilities include:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Novel subtype not in the marker map"}),"\n",(0,s.jsx)(n.li,{children:"Transitional state between subtypes"}),"\n",(0,s.jsx)(n.li,{children:"Technical noise requiring further investigation"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Example Scenario"}),':\nA cluster labeled "Macrophage" has a parent score of 0.9 but all child scores (M1, M2,\ntissue-resident) are below 0.4. This may represent a novel macrophage subtype or\nactivation state not captured in the current marker hierarchy.']}),"\n",(0,s.jsx)(n.h3,{id:"criterion-4-weak-leaf-extension",children:"Criterion 4: Weak Leaf (Extension)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"IF at leaf level\nAND score low\nAND marker heterogeneity high\n\u2192 SUBCLUSTER\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rationale"}),": Leaf with high variance may contain distinct subpopulations."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Heterogeneity Metrics"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Coefficient of variation across marker genes"}),"\n",(0,s.jsx)(n.li,{children:"Bimodal distribution detection in key markers"}),"\n",(0,s.jsx)(n.li,{children:"Entropy of marker expression within cluster"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Example Scenario"}),':\nA cluster labeled "Regulatory T Cell" (a leaf node) has a score of 0.5 and shows\nbimodal expression of FOXP3. Subclustering may reveal true Tregs versus activated\nconventional T cells.']}),"\n",(0,s.jsx)(n.h2,{id:"decision-flowchart",children:"Decision Flowchart"}),"\n",(0,s.jsx)(n.p,{children:"The following flowchart summarizes the complete decision logic. Each cluster traverses\nthis tree to determine its refinement action."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     REFINEMENT DECISION TREE                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n                         Cluster Assessment\n                                 \u2502\n                 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                 \u25bc                               \u25bc\n         score < threshold?              At parent level?\n                 \u2502                               \u2502\n           \u250c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2510                  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n           YES         NO                 YES           NO\n           \u2502           \u2502                   \u2502            \u2502\n           \u25bc           \u25bc                   \u25bc            \u25bc\n      n_cells \u2265 500?  SKIP         Has child signal?   SKIP\n           \u2502                               \u2502\n     \u250c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2510                  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     YES         NO                 YES           NO\n     \u2502           \u2502                   \u2502            \u2502\n     \u25bc           \u25bc                   \u25bc            \u25bc\n  SUBCLUSTER   SKIP           Gap \u2265 threshold?   SKIP\n                                     \u2502\n                              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                              YES           NO\n                              \u2502             \u2502\n                              \u25bc             \u25bc\n                           RELABEL     SUBCLUSTER\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Flowchart Interpretation"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Left branch: Low-confidence clusters evaluated for subclustering based on size"}),"\n",(0,s.jsx)(n.li,{children:"Right branch: Parent-level clusters evaluated for relabeling vs subclustering"}),"\n",(0,s.jsx)(n.li,{children:"SKIP: Cluster is already optimally annotated, no action needed"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"operation-types",children:"Operation Types"}),"\n",(0,s.jsxs)(n.p,{children:["Operations execute in deterministic order: ",(0,s.jsx)(n.code,{children:"override \u2192 merge \u2192 subcluster \u2192 relabel \u2192 rescore"})]}),"\n",(0,s.jsx)(n.p,{children:"This ordering ensures that:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Manual overrides take precedence over all automated decisions"}),"\n",(0,s.jsx)(n.li,{children:"Cluster merges happen before subclustering to avoid redundant computation"}),"\n",(0,s.jsx)(n.li,{children:"Subclustering precedes relabeling to generate new clusters first"}),"\n",(0,s.jsx)(n.li,{children:"Rescoring happens last to reflect all structural changes"}),"\n"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Operation"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Source"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"OVERRIDE"})}),(0,s.jsx)(n.td,{children:"Direct label assignment"}),(0,s.jsx)(n.td,{children:"ManualPolicy (YAML)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"MERGE"})}),(0,s.jsx)(n.td,{children:"Combine multiple clusters"}),(0,s.jsx)(n.td,{children:"ManualPolicy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"SUBCLUSTER"})}),(0,s.jsx)(n.td,{children:"Re-cluster with finer resolution"}),(0,s.jsx)(n.td,{children:"AutoPolicy or ManualPolicy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"RELABEL"})}),(0,s.jsx)(n.td,{children:"Instant label change (no re-clustering)"}),(0,s.jsx)(n.td,{children:"AutoPolicy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"RESCORE"})}),(0,s.jsx)(n.td,{children:"Recompute scores with updated markers"}),(0,s.jsx)(n.td,{children:"AutoPolicy"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"operation-details",children:"Operation Details"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"OVERRIDE"}),": Assigns a specific label regardless of algorithmic recommendations. Useful\nwhen domain expertise contradicts automated classification."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"MERGE"}),": Combines two or more clusters into a single cluster. Typically used when\nover-clustering has split a homogeneous population."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"SUBCLUSTER"}),": Applies Leiden clustering at higher resolution to subdivide a cluster.\nParameters include resolution factor and minimum cluster size."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"RELABEL"}),": Changes the cluster label without re-clustering. Fast operation that\nupdates metadata only."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"RESCORE"}),": Recomputes hierarchical gating scores using potentially updated marker\ndefinitions. Triggered when marker maps change between iterations."]}),"\n",(0,s.jsx)(n.h2,{id:"diagnostic-vs-execution-mode",children:"Diagnostic vs Execution Mode"}),"\n",(0,s.jsx)(n.p,{children:"Stage I operates in two distinct modes to support both exploration and production workflows."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"DIAGNOSTIC MODE (default, no --execute)\n\u251c\u2500 Generates diagnostic_report.csv\n\u251c\u2500 Shows recommendations (SUBCLUSTER, RELABEL, or SKIP)\n\u2514\u2500 Does NOT modify data\n\nEXECUTION MODE (with --execute)\n\u251c\u2500 Builds execution plan from recommendations\n\u251c\u2500 Executes all operations\n\u251c\u2500 Exports refined.h5ad\n\u2514\u2500 Stores provenance in AnnData\n"})}),"\n",(0,s.jsx)(n.h3,{id:"diagnostic-mode",children:"Diagnostic Mode"}),"\n",(0,s.jsx)(n.p,{children:"The default mode generates a comprehensive report without modifying data. This allows\nusers to review recommendations before committing changes."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Output Files"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"diagnostic_report.csv"}),": Per-cluster recommendations with scores"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"score_distribution.png"}),": Visualization of score distributions"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"decision_summary.json"}),": Machine-readable decision rationale"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Report Columns"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cluster_id"}),": Original cluster identifier"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"current_label"}),": Label from Stage H"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"recommendation"}),": SUBCLUSTER, RELABEL, or SKIP"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"target_label"}),": Proposed new label (for RELABEL)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"confidence"}),": Algorithmic confidence in recommendation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"rationale"}),": Human-readable explanation"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"execution-mode",children:"Execution Mode"}),"\n",(0,s.jsx)(n.p,{children:"Execution mode applies the refinement plan to produce updated annotations."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Provenance Tracking"}),":\nAll operations are logged in ",(0,s.jsx)(n.code,{children:"adata.uns['refinement_provenance']"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Operation type and parameters"}),"\n",(0,s.jsx)(n.li,{children:"Source cluster(s) and target label(s)"}),"\n",(0,s.jsx)(n.li,{children:"Timestamp and iteration number"}),"\n",(0,s.jsx)(n.li,{children:"Score changes before/after"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"iterative-refinement",children:"Iterative Refinement"}),"\n",(0,s.jsx)(n.p,{children:"Stage I supports iterative chains until convergence:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"H \u2192 I (iteration 1) \u2192 I (iteration 2) \u2192 I (iteration 3) \u2192 ...\n"})}),"\n",(0,s.jsx)(n.p,{children:"Each iteration:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Uses previous output's cluster_lvl1 as new cluster_lvl0"}),"\n",(0,s.jsx)(n.li,{children:"Selects new candidates based on updated scores"}),"\n",(0,s.jsx)(n.li,{children:"Further refines clusters that still need improvement"}),"\n",(0,s.jsx)(n.li,{children:"Tracks full lineage in provenance"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Typically converges in 2-3 iterations."}),"\n",(0,s.jsx)(n.h3,{id:"convergence-criteria",children:"Convergence Criteria"}),"\n",(0,s.jsx)(n.p,{children:"Iteration stops when any of the following conditions are met:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"No clusters meet refinement criteria (all SKIP)"}),"\n",(0,s.jsx)(n.li,{children:"Maximum iteration count reached (default: 5)"}),"\n",(0,s.jsx)(n.li,{children:"Score improvement falls below threshold (default: 0.05)"}),"\n",(0,s.jsx)(n.li,{children:"Manual termination via configuration"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"lineage-tracking",children:"Lineage Tracking"}),"\n",(0,s.jsx)(n.p,{children:"Each cell maintains a complete lineage record:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Cell X: Immune \u2192 T Cell \u2192 CD8+ T Cell \u2192 Effector CD8+ T Cell\n        (H)       (I.1)     (I.2)         (I.3)\n"})}),"\n",(0,s.jsx)(n.p,{children:"This enables:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Tracing annotation provenance"}),"\n",(0,s.jsx)(n.li,{children:"Comparing intermediate states"}),"\n",(0,s.jsx)(n.li,{children:"Debugging unexpected classifications"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"configuration-reference",children:"Configuration Reference"}),"\n",(0,s.jsx)(n.h3,{id:"autopolicy-parameters",children:"AutoPolicy Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"score_threshold"})}),(0,s.jsx)(n.td,{children:"1.0"}),(0,s.jsx)(n.td,{children:"Minimum score to skip refinement"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"min_cells"})}),(0,s.jsx)(n.td,{children:"500"}),(0,s.jsx)(n.td,{children:"Minimum cluster size for subclustering"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"subtype_signal_threshold"})}),(0,s.jsx)(n.td,{children:"0.5"}),(0,s.jsx)(n.td,{children:"Minimum child score for relabeling"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"heterogeneity_gap"})}),(0,s.jsx)(n.td,{children:"0.3"}),(0,s.jsx)(n.td,{children:"Required gap between top candidates"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"max_iterations"})}),(0,s.jsx)(n.td,{children:"5"}),(0,s.jsx)(n.td,{children:"Maximum refinement iterations"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"manualpolicy-yaml-format",children:"ManualPolicy YAML Format"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'refinements:\n  - cluster: "Cluster_15"\n    action: override\n    label: "Plasma Cell"\n\n  - cluster: "Cluster_8"\n    action: subcluster\n    resolution: 1.2\n\n  - clusters: ["Cluster_3", "Cluster_7"]\n    action: merge\n    label: "Fibroblast"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm",children:"Hierarchical Gating Algorithm"})," - Initial annotation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/tuning-guide",children:"Tuning Guide"})," - Refinement parameters"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453(e,n,i){i.d(n,{R:()=>l,x:()=>o});var r=i(6540);const s={},t=r.createContext(s);function l(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);