"use strict";(globalThis.webpackChunkcelltype_refinery_docs=globalThis.webpackChunkcelltype_refinery_docs||[]).push([[455],{252(e,n,i){i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"methodology/annotation-pipeline","title":"Annotation Pipeline","description":"This page provides a complete overview of the cell type annotation pipeline, showing how data flows through Stage H (initial clustering and annotation) and Stage I (refinement).","source":"@site/docs/methodology/annotation-pipeline.md","sourceDirName":"methodology","slug":"/methodology/annotation-pipeline","permalink":"/CellType-Refinery/docs/methodology/annotation-pipeline","draft":false,"unlisted":false,"editUrl":"https://github.com/kuang-da/CellType-Refinery/tree/main/celltype-refinery-docs/docs/methodology/annotation-pipeline.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"Cell Type Annotation Methodology","permalink":"/CellType-Refinery/docs/methodology/"},"next":{"title":"Marker Scoring Algorithm","permalink":"/CellType-Refinery/docs/methodology/marker-scoring-algorithm"}}');var s=i(4848),t=i(8453);const l={sidebar_position:2},a="Annotation Pipeline",o={},d=[{value:"Complete Pipeline Flow",id:"complete-pipeline-flow",level:2},{value:"Stage Details",id:"stage-details",level:2},{value:"1. Preprocessing",id:"1-preprocessing",level:3},{value:"Layer Selection Priority",id:"layer-selection-priority",level:4},{value:"Technical Marker Exclusion",id:"technical-marker-exclusion",level:4},{value:"Low-Variance Filtering",id:"low-variance-filtering",level:4},{value:"Marker Resolution from JSON",id:"marker-resolution-from-json",level:4},{value:"2. Clustering",id:"2-clustering",level:3},{value:"Clustering Pipeline",id:"clustering-pipeline",level:4},{value:"Key Parameters",id:"key-parameters",level:4},{value:"GPU Acceleration",id:"gpu-acceleration",level:4},{value:"3. Differential Expression",id:"3-differential-expression",level:3},{value:"Wilcoxon Rank-Sum Test",id:"wilcoxon-rank-sum-test",level:4},{value:"Dynamic K Calculation",id:"dynamic-k-calculation",level:4},{value:"Rank-Based DE Lookup",id:"rank-based-de-lookup",level:4},{value:"4. Marker Scoring",id:"4-marker-scoring",level:3},{value:"Summary",id:"summary",level:4},{value:"Score Interpretation",id:"score-interpretation",level:4},{value:"5. Hierarchical Assignment",id:"5-hierarchical-assignment",level:3},{value:"Summary",id:"summary-1",level:4},{value:"Stop Reasons",id:"stop-reasons",level:4},{value:"Gating Parameters by Level",id:"gating-parameters-by-level",level:4},{value:"6. Per-Cell Voting",id:"6-per-cell-voting",level:3},{value:"Key Principle",id:"key-principle",level:4},{value:"Output Format",id:"output-format",level:4},{value:"7. Outputs",id:"7-outputs",level:3},{value:"Primary Outputs",id:"primary-outputs",level:4},{value:"AnnData Contents",id:"anndata-contents",level:4},{value:"Stage I Refinement Flow",id:"stage-i-refinement-flow",level:2},{value:"Refinement Decision Logic",id:"refinement-decision-logic",level:3},{value:"Decision Criteria",id:"decision-criteria",level:4},{value:"Operation Types",id:"operation-types",level:4},{value:"Iterative Refinement",id:"iterative-refinement",level:3},{value:"Convergence Criteria",id:"convergence-criteria",level:4},{value:"End-to-End Example",id:"end-to-end-example",level:2},{value:"See Also",id:"see-also",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"annotation-pipeline",children:"Annotation Pipeline"})}),"\n",(0,s.jsx)(n.p,{children:"This page provides a complete overview of the cell type annotation pipeline, showing how data flows through Stage H (initial clustering and annotation) and Stage I (refinement)."}),"\n",(0,s.jsx)(n.h2,{id:"complete-pipeline-flow",children:"Complete Pipeline Flow"}),"\n",(0,s.jsx)(n.p,{children:"The annotation pipeline transforms raw merged expression data into refined cell type assignments through a multi-stage process. The following diagram shows the complete data flow from inputs through all processing stages to final outputs."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"                               INPUTS\n                                 \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u25bc                       \u25bc                       \u25bc\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n \u2502 merged_data   \u2502    \u2502 cell_type_markers   \u2502    \u2502   CLI Args      \u2502\n \u2502   .h5ad       \u2502    \u2502   .json             \u2502    \u2502 (resolution,    \u2502\n \u2502 (Stage F)     \u2502    \u2502 (marker hierarchy)  \u2502    \u2502  n_pcs, etc.)   \u2502\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502                       \u2502                        \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1. PREPROCESSING                                                           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 - Select expression layer (batchcorr / aligned / raw)                  \u2502 \u2502\n\u2502  \u2502 - Filter low-variance markers (std < 1e-3)                             \u2502 \u2502\n\u2502  \u2502 - Exclude technical markers (DAPI, Collagen IV, Beta-actin) -> .obs    \u2502 \u2502\n\u2502  \u2502 - Load and resolve marker sets from JSON hierarchy                     \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  2. CLUSTERING (GPU-accelerated if available)                               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 - Scale features (zero-center, clip at +/-10 std)                      \u2502 \u2502\n\u2502  \u2502 - PCA dimensionality reduction (default: 30 components)                \u2502 \u2502\n\u2502  \u2502 - k-NN graph construction (default: k=15)                              \u2502 \u2502\n\u2502  \u2502 - Leiden community detection (default: resolution=0.6)                 \u2502 \u2502\n\u2502  \u2502 - Optional: UMAP embedding for visualization                           \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  3. DIFFERENTIAL EXPRESSION                                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 - Wilcoxon rank-sum test with tie correction (cluster vs rest)         \u2502 \u2502\n\u2502  \u2502 - Dynamic K: ceil(panel_size x de_top_frac) clamped to [de_min_k, 12]  \u2502 \u2502\n\u2502  \u2502 - Rank-based lookup for continuous DE bonus scoring                    \u2502 \u2502\n\u2502  \u2502 - Commonness penalty for markers shared across many cell types         \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  4. MARKER SCORING (per cluster x cell type)                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502                                                                        \u2502 \u2502\n\u2502  \u2502  score = mean_enrichment + mean_positive + de_component - anti_penalty \u2502 \u2502\n\u2502  \u2502          -----------------------------------------------------         \u2502 \u2502\n\u2502  \u2502               |              |           |            |                \u2502 \u2502\n\u2502  \u2502               v              v           v            v                \u2502 \u2502\n\u2502  \u2502         z-score vs     % cells      bonus if    penalty for           \u2502 \u2502\n\u2502  \u2502         global median  above Q75    marker is   anti-markers           \u2502 \u2502\n\u2502  \u2502                                     DE hit      being expressed        \u2502 \u2502\n\u2502  \u2502                                                                        \u2502 \u2502\n\u2502  \u2502  Additional metrics: coverage, frac_markers_on, n_markers_on           \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  5. HIERARCHICAL ASSIGNMENT (top-down traversal)                            \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502                                                                        \u2502 \u2502\n\u2502  \u2502              Marker Hierarchy Example:                                 \u2502 \u2502\n\u2502  \u2502                                                                        \u2502 \u2502\n\u2502  \u2502                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                         \u2502 \u2502\n\u2502  \u2502         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  ROOT   \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                              \u2502 \u2502\n\u2502  \u2502         \u25bc          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u25bc                              \u2502 \u2502\n\u2502  \u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                        \u2502 \u2502\n\u2502  \u2502    \u2502Epithelium\u2502                   \u2502 Immune    \u2502  ... (other roots)     \u2502 \u2502\n\u2502  \u2502    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518                   \u2502  Cells    \u2502                        \u2502 \u2502\n\u2502  \u2502         \u2502                         \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518                        \u2502 \u2502\n\u2502  \u2502    \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510                    \u250c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2510                        \u2502 \u2502\n\u2502  \u2502    \u25bc         \u25bc                    \u25bc           \u25bc                        \u2502 \u2502\n\u2502  \u2502 Ciliated  Glandular           Myeloids    Lymphoids                    \u2502 \u2502\n\u2502  \u2502                                   \u2502                                    \u2502 \u2502\n\u2502  \u2502                              \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510                               \u2502 \u2502\n\u2502  \u2502                              \u25bc         \u25bc                               \u2502 \u2502\n\u2502  \u2502                         Granulocytes  Monocytes                        \u2502 \u2502\n\u2502  \u2502                                                                        \u2502 \u2502\n\u2502  \u2502  Algorithm:                                                            \u2502 \u2502\n\u2502  \u2502  1. Find best passing ROOT (score > threshold, coverage > min)         \u2502 \u2502\n\u2502  \u2502  2. Descend: compare SIBLINGS only at each level                       \u2502 \u2502\n\u2502  \u2502  3. Stop when: leaf reached, no child passes gate, or ambiguous        \u2502 \u2502\n\u2502  \u2502                                                                        \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  6. PER-CELL VOTING (Evidence Collection)                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 - Triggered when sibling gap < min_gap threshold                       \u2502 \u2502\n\u2502  \u2502 - Computes per-cell Z-score for each candidate's markers               \u2502 \u2502\n\u2502  \u2502 - Records vote composition as EVIDENCE ONLY (does NOT override labels) \u2502 \u2502\n\u2502  \u2502 - Stored for downstream audit and Stage I refinement                   \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  7. QC & DEBUG OUTPUTS                                                      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 - Cluster size distribution plot                                       \u2502 \u2502\n\u2502  \u2502 - Confidence distribution plot                                         \u2502 \u2502\n\u2502  \u2502 - Depth distribution plot                                              \u2502 \u2502\n\u2502  \u2502 - Stop reason summary plot                                             \u2502 \u2502\n\u2502  \u2502 - Near-miss report (close-call clusters)                               \u2502 \u2502\n\u2502  \u2502 - Marker evidence table (--expand-markers)                             \u2502 \u2502\n\u2502  \u2502 - Audit cards HTML (--generate-audit-cards)                            \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n                              OUTPUTS\n                                 \u2502\n      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n      \u25bc              \u25bc           \u25bc           \u25bc              \u25bc\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n \u2502coarse_  \u2502  \u2502cluster_   \u2502 \u2502marker_  \u2502 \u2502decision_\u2502  \u2502figures/   \u2502\n \u2502clusters \u2502  \u2502annotations\u2502 \u2502scores   \u2502 \u2502steps    \u2502  \u2502 *.png     \u2502\n \u2502.h5ad    \u2502  \u2502.csv       \u2502 \u2502.csv     \u2502 \u2502.csv     \u2502  \u2502           \u2502\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502              \u2502           \u2502           \u2502              \u2502\n      \u25bc              \u25bc           \u25bc           \u25bc              \u25bc\n  AnnData with    Summary     Full       Hierarchical   QC plots\n  cluster_lvl0    per         scoring    decision       (confidence,\n  assignments     cluster     matrix     trace          depth, etc.)\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"stage-details",children:"Stage Details"}),"\n",(0,s.jsx)(n.h3,{id:"1-preprocessing",children:"1. Preprocessing"}),"\n",(0,s.jsx)(n.p,{children:"The preprocessing stage prepares expression data for clustering and annotation."}),"\n",(0,s.jsx)(n.h4,{id:"layer-selection-priority",children:"Layer Selection Priority"}),"\n",(0,s.jsx)(n.p,{children:"Stage H operates on one expression layer from the merged AnnData, selected in order of preference:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Priority: batchcorr > aligned > X (raw)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The selected layer is copied to ",(0,s.jsx)(n.code,{children:'adata.layers["stage_h_input"]'})," and pinned to ",(0,s.jsx)(n.code,{children:"adata.X"})," for downstream processing."]}),"\n",(0,s.jsx)(n.h4,{id:"technical-marker-exclusion",children:"Technical Marker Exclusion"}),"\n",(0,s.jsx)(n.p,{children:"Technical markers are excluded from clustering features but preserved for QC:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'TECHNICAL_MARKERS = ["DAPI", "Collagen IV", "Beta-actin"]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["These are moved to ",(0,s.jsx)(n.code,{children:".obs"})," columns named ",(0,s.jsx)(n.code,{children:"{marker}_intensity"})," and are not used in clustering or scoring calculations."]}),"\n",(0,s.jsx)(n.h4,{id:"low-variance-filtering",children:"Low-Variance Filtering"}),"\n",(0,s.jsx)(n.p,{children:"Markers with standard deviation < 1e-3 are dropped to avoid numerical issues in scaling and PCA. This prevents constant or near-constant markers from causing division-by-zero errors or dominating principal components."}),"\n",(0,s.jsx)(n.h4,{id:"marker-resolution-from-json",children:"Marker Resolution from JSON"}),"\n",(0,s.jsx)(n.p,{children:"Marker names from the JSON hierarchy are resolved against the AnnData panel:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Marker Map Entry"}),(0,s.jsx)(n.th,{children:"AnnData var_names"}),(0,s.jsx)(n.th,{children:"Result"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:'"CD45"'}),(0,s.jsx)(n.td,{children:'"CD45"'}),(0,s.jsx)(n.td,{children:"Resolved"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:'"Pan-Cytokeratin"'}),(0,s.jsx)(n.td,{children:'"Pan-CK"'}),(0,s.jsx)(n.td,{children:"Alias matched"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:'"CD3epsilon"'}),(0,s.jsx)(n.td,{children:"(not found)"}),(0,s.jsx)(n.td,{children:"Missing - excluded"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"Missing markers are logged and excluded from scoring for that cell type."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"2-clustering",children:"2. Clustering"}),"\n",(0,s.jsx)(n.p,{children:"The clustering stage groups cells based on expression similarity using the following pipeline."}),"\n",(0,s.jsx)(n.h4,{id:"clustering-pipeline",children:"Clustering Pipeline"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:'Expression Matrix (n_cells x n_markers)\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. SCALE                                                        \u2502\n\u2502    - Zero-center each marker                                    \u2502\n\u2502    - Clip values at +/-10 standard deviations                   \u2502\n\u2502    - Prevents outlier domination in PCA                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2. PCA                                                          \u2502\n\u2502    - n_components = 30 (default)                                \u2502\n\u2502    - SVD solver: arpack                                         \u2502\n\u2502    - Stores in adata.obsm["X_pca"]                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 3. NEIGHBORS                                                    \u2502\n\u2502    - k = 15 (default)                                           \u2502\n\u2502    - Uses PCA coordinates                                       \u2502\n\u2502    - Stores connectivity in adata.obsp                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 4. LEIDEN                                                       \u2502\n\u2502    - resolution = 0.6 (default)                                 \u2502\n\u2502    - GPU: rapids_singlecell (RAPIDS/cuGraph)                    \u2502\n\u2502    - CPU: igraph backend, n_iterations=2                        \u2502\n\u2502    - random_state = 1337                                        \u2502\n\u2502    - Stores in adata.obs["cluster_lvl0"]                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 5. UMAP (optional, --compute-umap)                              \u2502\n\u2502    - 2D embedding for visualization                             \u2502\n\u2502    - Stores in adata.obsm["X_umap"]                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,s.jsx)(n.h4,{id:"key-parameters",children:"Key Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--n-pcs"})}),(0,s.jsx)(n.td,{children:"30"}),(0,s.jsx)(n.td,{children:"Number of PCA components"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--neighbors-k"})}),(0,s.jsx)(n.td,{children:"15"}),(0,s.jsx)(n.td,{children:"k-NN neighbors for graph construction"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--resolution"})}),(0,s.jsx)(n.td,{children:"0.6"}),(0,s.jsx)(n.td,{children:"Leiden resolution (higher = more clusters)"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"gpu-acceleration",children:"GPU Acceleration"}),"\n",(0,s.jsxs)(n.p,{children:["When ",(0,s.jsx)(n.code,{children:"--use-gpu"})," is enabled (default), Stage H uses RAPIDS libraries for accelerated computation. The system falls back to CPU (scanpy) automatically on GPU errors."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": GPU Leiden is non-deterministic and may produce different cluster counts across runs even with fixed random_state. For reproducible results, use ",(0,s.jsx)(n.code,{children:"--annotation-only"})," to reuse existing clusters."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"3-differential-expression",children:"3. Differential Expression"}),"\n",(0,s.jsx)(n.p,{children:"Differential expression analysis identifies marker genes that distinguish each cluster from the rest of the population."}),"\n",(0,s.jsx)(n.h4,{id:"wilcoxon-rank-sum-test",children:"Wilcoxon Rank-Sum Test"}),"\n",(0,s.jsx)(n.p,{children:"For each cluster, DE testing identifies markers significantly enriched compared to all other cells:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'sc.tl.rank_genes_groups(adata, groupby="cluster_lvl0", method="wilcoxon")\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Results are stored in ",(0,s.jsx)(n.code,{children:'adata.uns[f"de_wilcoxon_{layer}"]'}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"dynamic-k-calculation",children:"Dynamic K Calculation"}),"\n",(0,s.jsx)(n.p,{children:"The number of top DE genes considered (K) adapts to panel size:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"K_target = ceil(panel_size x de_top_frac)\nK = clamp(K_target, de_min_k, de_max_k)\n\nDefault parameters:\n  de_top_frac = 0.2\n  de_min_k = 3\n  de_max_k = 12\n\nExample (panel_size = 40):\n  K_target = ceil(40 x 0.2) = 8\n  K = clamp(8, 3, 12) = 8\n"})}),"\n",(0,s.jsx)(n.h4,{id:"rank-based-de-lookup",children:"Rank-Based DE Lookup"}),"\n",(0,s.jsx)(n.p,{children:"DE contribution uses rank-weighted scoring rather than binary hit/miss. Higher-ranked DE genes contribute more to the score, with a commonness penalty for markers that appear in many cell type definitions."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"4-marker-scoring",children:"4. Marker Scoring"}),"\n",(0,s.jsxs)(n.p,{children:["For detailed information about the scoring algorithm, see ",(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/marker-scoring-algorithm",children:"Marker Scoring Algorithm"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:"Each (cluster, cell_type) pair receives a composite score:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"score = mean_enrichment + mean_positive + de_component - anti_penalty\n"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Component"}),(0,s.jsx)(n.th,{children:"What It Measures"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mean_enrichment"})}),(0,s.jsx)(n.td,{children:"Z-score of cluster expression vs global median"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mean_positive"})}),(0,s.jsx)(n.td,{children:"Fraction of cells expressing markers above Q75"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"de_component"})}),(0,s.jsx)(n.td,{children:"Rank-weighted bonus for markers in top-K DE genes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"anti_penalty"})}),(0,s.jsx)(n.td,{children:"Penalty for anti-markers being expressed"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"score-interpretation",children:"Score Interpretation"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Typical winning scores"}),": 1.5 to 4.0 for well-matched cell types"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Marginal matches"}),": 0.5 to 1.5, may indicate subtypes or transitional states"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Poor matches"}),": < 0.5, usually indicates wrong cell type assignment"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Negative scores"}),": Strong evidence against the cell type"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"5-hierarchical-assignment",children:"5. Hierarchical Assignment"}),"\n",(0,s.jsxs)(n.p,{children:["For detailed information about the gating algorithm, see ",(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm",children:"Hierarchical Gating Algorithm"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"summary-1",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:"The algorithm traverses the marker hierarchy top-down:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Identify roots"}),": Extract labels that are never children (Epithelium, Immune, etc.)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Evaluate roots"}),": Check hard requirements, veto markers, and standard gates"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Select best root"}),": Sort passing roots by score, check margin"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Descend hierarchy"}),": At each level, filter by gates and select best scoring child"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Record result"}),": Store assigned label, confidence, and stop reason"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"stop-reasons",children:"Stop Reasons"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Stop Reason"}),(0,s.jsx)(n.th,{children:"Meaning"}),(0,s.jsx)(n.th,{children:"Assigned Label"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"leaf_reached"})}),(0,s.jsx)(n.td,{children:"Best case - reached deepest level"}),(0,s.jsx)(n.td,{children:"Deepest node"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ambiguous_siblings"})}),(0,s.jsx)(n.td,{children:"Top 2 children too close"}),(0,s.jsx)(n.td,{children:"Parent node"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"no_child_passed"})}),(0,s.jsx)(n.td,{children:"All children failed gates"}),(0,s.jsx)(n.td,{children:"Current node"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"no_root_passed"})}),(0,s.jsx)(n.td,{children:"No root category fit"}),(0,s.jsx)(n.td,{children:'"Unassigned"'})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ambiguous_root"})}),(0,s.jsx)(n.td,{children:"Top 2 roots too close"}),(0,s.jsx)(n.td,{children:'"Root1~Root2"'})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"gating-parameters-by-level",children:"Gating Parameters by Level"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Level"}),(0,s.jsx)(n.th,{children:"min_coverage"}),(0,s.jsx)(n.th,{children:"min_pos_frac"}),(0,s.jsx)(n.th,{children:"min_enrichment"}),(0,s.jsx)(n.th,{children:"min_gap"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0 (Root)"}),(0,s.jsx)(n.td,{children:"0.50"}),(0,s.jsx)(n.td,{children:"0.30"}),(0,s.jsx)(n.td,{children:"0.00"}),(0,s.jsx)(n.td,{children:"0.50"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1"}),(0,s.jsx)(n.td,{children:"0.40"}),(0,s.jsx)(n.td,{children:"0.20"}),(0,s.jsx)(n.td,{children:"-0.50"}),(0,s.jsx)(n.td,{children:"0.30"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"2"}),(0,s.jsx)(n.td,{children:"0.30"}),(0,s.jsx)(n.td,{children:"0.15"}),(0,s.jsx)(n.td,{children:"-1.00"}),(0,s.jsx)(n.td,{children:"0.20"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"3+"}),(0,s.jsx)(n.td,{children:"0.30"}),(0,s.jsx)(n.td,{children:"0.15"}),(0,s.jsx)(n.td,{children:"-1.00"}),(0,s.jsx)(n.td,{children:"0.20"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"6-per-cell-voting",children:"6. Per-Cell Voting"}),"\n",(0,s.jsx)(n.p,{children:"Per-cell voting provides additional evidence when cluster-level decisions are ambiguous."}),"\n",(0,s.jsx)(n.h4,{id:"key-principle",children:"Key Principle"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:'+=====================================================================+\n|  CRITICAL: Voting is EVIDENCE ONLY                                  |\n|                                                                     |\n|  - assigned_label = PARENT (not any child)                          |\n|  - stop_reason = "ambiguous_siblings" (not "voted")                 |\n|  - Composition stored for audit and Stage I refinement hints        |\n+=====================================================================+\n'})}),"\n",(0,s.jsx)(n.p,{children:"Per-cell voting does NOT override cluster-level assignments. When siblings are too close, each cell is scored against the competing candidates, and the vote distribution is stored for downstream analysis."}),"\n",(0,s.jsx)(n.h4,{id:"output-format",children:"Output Format"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'{\n    "cluster_id": 42,\n    "assigned_label": "Lymphoid",\n    "stop_reason": "ambiguous_siblings",\n    "cell_votes": {\n        "T Cell": 0.62,\n        "B Cell": 0.38\n    }\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"7-outputs",children:"7. Outputs"}),"\n",(0,s.jsx)(n.p,{children:"Stage H produces multiple output files for analysis and downstream processing."}),"\n",(0,s.jsx)(n.h4,{id:"primary-outputs",children:"Primary Outputs"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"coarse_clusters.h5ad"})}),(0,s.jsx)(n.td,{children:"AnnData with cluster assignments and annotation columns"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"cluster_annotations.csv"})}),(0,s.jsx)(n.td,{children:"Per-cluster summary with assigned labels"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"marker_scores.csv"})}),(0,s.jsx)(n.td,{children:"Full scoring matrix (clusters x cell types)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"decision_steps.csv"})}),(0,s.jsx)(n.td,{children:"Step-by-step hierarchical decision trace"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"anndata-contents",children:"AnnData Contents"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"adata.obs columns:\n  cluster_lvl0          - Leiden cluster ID (string)\n  cell_type_auto        - Assigned cell type label\n  cell_type_auto_root   - Root category (Epithelium, Immune, etc.)\n  cell_type_auto_conf   - Confidence score (min margin along path)\n\nadata.uns:\n  de_wilcoxon_{layer}   - Differential expression results\n  stage_h_params        - Run parameters\n  stage_h_gating_params - Gating thresholds used\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"stage-i-refinement-flow",children:"Stage I Refinement Flow"}),"\n",(0,s.jsx)(n.p,{children:"Stage I refines initial annotations from Stage H, addressing ambiguous assignments and discovering hidden subpopulations."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"                    Input: coarse_clusters.h5ad + refinement plan\n                                       \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u25bc                                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  DIAGNOSTIC MODE (default)           \u2502    \u2502  EXECUTION MODE (--execute)          \u2502\n\u2502  No modification to data             \u2502    \u2502  Applies refinement plan             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                      \u2502    \u2502                                      \u2502\n\u2502  - Evaluate cluster quality          \u2502    \u2502  - Apply operations in order:        \u2502\n\u2502  - Detect ambiguous assignments      \u2502    \u2502      override -> merge ->            \u2502\n\u2502  - Analyze subtype signals           \u2502    \u2502      subcluster -> relabel           \u2502\n\u2502  - Suggest operations                \u2502    \u2502  - Re-score affected clusters        \u2502\n\u2502                                      \u2502    \u2502  - Track provenance                  \u2502\n\u2502  Output:                             \u2502    \u2502                                      \u2502\n\u2502    diagnostic_report.csv             \u2502    \u2502  Output:                             \u2502\n\u2502    score_distribution.png            \u2502    \u2502    refined.h5ad                      \u2502\n\u2502    decision_summary.json             \u2502    \u2502    refinement_log.csv                \u2502\n\u2502                                      \u2502    \u2502                                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h3,{id:"refinement-decision-logic",children:"Refinement Decision Logic"}),"\n",(0,s.jsxs)(n.p,{children:["For detailed information, see ",(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/refinement-decision-logic",children:"Refinement Decision Logic"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"decision-criteria",children:"Decision Criteria"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Criterion"}),(0,s.jsx)(n.th,{children:"Condition"}),(0,s.jsx)(n.th,{children:"Action"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Low Confidence"}),(0,s.jsx)(n.td,{children:"score < 1.0 AND n_cells >= 500"}),(0,s.jsx)(n.td,{children:"SUBCLUSTER"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Homogeneous Parent"}),(0,s.jsx)(n.td,{children:"clear child signal, large gap"}),(0,s.jsx)(n.td,{children:"RELABEL"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Heterogeneous Parent"}),(0,s.jsx)(n.td,{children:"multiple competing children"}),(0,s.jsx)(n.td,{children:"SUBCLUSTER"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Mixed Population"}),(0,s.jsx)(n.td,{children:"strong parent, weak children"}),(0,s.jsx)(n.td,{children:"SUBCLUSTER"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"operation-types",children:"Operation Types"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Operation"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Source"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"OVERRIDE"})}),(0,s.jsx)(n.td,{children:"Direct label assignment"}),(0,s.jsx)(n.td,{children:"ManualPolicy (YAML)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"MERGE"})}),(0,s.jsx)(n.td,{children:"Combine multiple clusters"}),(0,s.jsx)(n.td,{children:"ManualPolicy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"SUBCLUSTER"})}),(0,s.jsx)(n.td,{children:"Re-cluster with finer resolution"}),(0,s.jsx)(n.td,{children:"AutoPolicy or ManualPolicy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"RELABEL"})}),(0,s.jsx)(n.td,{children:"Instant label change (no re-clustering)"}),(0,s.jsx)(n.td,{children:"AutoPolicy"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"iterative-refinement",children:"Iterative Refinement"}),"\n",(0,s.jsx)(n.p,{children:"Stage I supports iterative chains until convergence:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Stage H -> Stage I (iter 1) -> Stage I (iter 2) -> Stage I (iter 3) -> ...\n"})}),"\n",(0,s.jsx)(n.p,{children:"Each iteration uses the previous output's clusters as input. Typically converges in 2-3 iterations."}),"\n",(0,s.jsx)(n.h4,{id:"convergence-criteria",children:"Convergence Criteria"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"No clusters meet refinement criteria (all SKIP)"}),"\n",(0,s.jsx)(n.li,{children:"Maximum iteration count reached (default: 5)"}),"\n",(0,s.jsx)(n.li,{children:"Score improvement falls below threshold (default: 0.05)"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"end-to-end-example",children:"End-to-End Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"merged_data.h5ad (100,000 cells, 40 markers)\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  STAGE H                                                        \u2502\n\u2502  - Preprocessing: 37 markers retained                           \u2502\n\u2502  - Clustering: 42 clusters at resolution 0.6                    \u2502\n\u2502  - Annotation: 38 assigned, 4 ambiguous                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\ncoarse_clusters.h5ad\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  STAGE I - Iteration 1                                          \u2502\n\u2502  - 4 clusters flagged for refinement                            \u2502\n\u2502  - 2 subclustered (mixed populations)                           \u2502\n\u2502  - 2 relabeled (clear subtype signal)                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\nrefined_iter1.h5ad (48 clusters)\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  STAGE I - Iteration 2                                          \u2502\n\u2502  - 1 cluster flagged for refinement                             \u2502\n\u2502  - 1 subclustered                                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\nrefined_iter2.h5ad (50 clusters) - CONVERGED\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/",children:"Methodology Overview"})," - Conceptual background on the annotation approach"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/marker-scoring-algorithm",children:"Marker Scoring Algorithm"})," - Detailed scoring formula explanation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm",children:"Hierarchical Gating Algorithm"})," - Gate checks and assignment logic"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/refinement-decision-logic",children:"Refinement Decision Logic"})," - Stage I decision criteria"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453(e,n,i){i.d(n,{R:()=>l,x:()=>a});var r=i(6540);const s={},t=r.createContext(s);function l(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);