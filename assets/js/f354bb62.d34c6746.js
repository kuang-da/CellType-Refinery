"use strict";(globalThis.webpackChunkcelltype_refinery_docs=globalThis.webpackChunkcelltype_refinery_docs||[]).push([[6369],{6255(e,n,t){t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"getting-started/first-annotation","title":"First Annotation Tutorial","description":"A complete walkthrough of annotating your first dataset with CellType-Refinery.","source":"@site/docs/getting-started/first-annotation.md","sourceDirName":"getting-started","slug":"/getting-started/first-annotation","permalink":"/CellType-Refinery/docs/getting-started/first-annotation","draft":false,"unlisted":false,"editUrl":"https://github.com/kuang-da/CellType-Refinery/tree/main/celltype-refinery-docs/docs/getting-started/first-annotation.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"docsSidebar","previous":{"title":"Configuration","permalink":"/CellType-Refinery/docs/getting-started/configuration"},"next":{"title":"Workflow Overview","permalink":"/CellType-Refinery/docs/core-workflows/workflow-overview"}}');var i=t(4848),s=t(8453);const a={sidebar_position:4},l="First Annotation Tutorial",o={},d=[{value:"Overview",id:"overview",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1: Prepare Input Data",id:"step-1-prepare-input-data",level:2},{value:"Step 2: Create Marker Map",id:"step-2-create-marker-map",level:2},{value:"Step 3: Run Clustering",id:"step-3-run-clustering",level:2},{value:"Step 4: Annotate Cell Types",id:"step-4-annotate-cell-types",level:2},{value:"Step 5: Review Results",id:"step-5-review-results",level:2},{value:"Understanding Scores",id:"understanding-scores",level:3},{value:"Step 6: Refine Annotations",id:"step-6-refine-annotations",level:2},{value:"Step 7: Run Analysis",id:"step-7-run-analysis",level:2},{value:"Output Structure",id:"output-structure",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"High Unassigned Rate",id:"high-unassigned-rate",level:3},{value:"Incorrect Annotations",id:"incorrect-annotations",level:3},{value:"Low Confidence Scores",id:"low-confidence-scores",level:3},{value:"Next Steps",id:"next-steps",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"first-annotation-tutorial",children:"First Annotation Tutorial"})}),"\n",(0,i.jsx)(n.p,{children:"A complete walkthrough of annotating your first dataset with CellType-Refinery."}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    subgraph Steps["Tutorial Steps"]\n        S1["1. Prepare<br/>Data"] --\x3e S2["2. Create<br/>Marker Map"]\n        S2 --\x3e S3["3. Run<br/>Clustering"]\n        S3 --\x3e S4["4. Annotate<br/>Cell Types"]\n        S4 --\x3e S5["5. Review<br/>& Refine"]\n    end\n\n    style S1 fill:#E6E6FA\n    style S5 fill:#90EE90'}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"In this tutorial, you'll:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Prepare your input data"}),"\n",(0,i.jsx)(n.li,{children:"Create a marker map"}),"\n",(0,i.jsx)(n.li,{children:"Run clustering"}),"\n",(0,i.jsx)(n.li,{children:"Annotate cell types"}),"\n",(0,i.jsx)(n.li,{children:"Review and refine results"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CellType-Refinery installed"}),"\n",(0,i.jsx)(n.li,{children:"A merged AnnData file with normalized expression data"}),"\n",(0,i.jsx)(n.li,{children:"Knowledge of expected cell types in your tissue"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"step-1-prepare-input-data",children:"Step 1: Prepare Input Data"}),"\n",(0,i.jsxs)(n.p,{children:["Your input should be an AnnData (",(0,i.jsx)(n.code,{children:".h5ad"}),") file with:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"X matrix"}),": Normalized expression values"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"obs"}),": Cell metadata (sample_id, region, etc.)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"var"}),": Marker/antibody names"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import scanpy as sc\n\n# Load your data\nadata = sc.read_h5ad("merged_data.h5ad")\n\n# Check structure\nprint(f"Cells: {adata.n_obs}")\nprint(f"Markers: {adata.n_vars}")\nprint(f"Layers: {list(adata.layers.keys())}")\n'})}),"\n",(0,i.jsx)(n.h2,{id:"step-2-create-marker-map",children:"Step 2: Create Marker Map"}),"\n",(0,i.jsx)(n.p,{children:"Define your cell-type hierarchy in JSON:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "_marker_map_metadata": {\n    "version": "1.0",\n    "tissue": "example_tissue",\n    "description": "Example marker map"\n  },\n  "Epithelium": {\n    "markers": ["EpCAM", "Pan-Cytokeratin"],\n    "anti_markers": ["CD45", "Vimentin"],\n    "subtypes": {\n      "Type A": {\n        "markers": ["Marker1", "Marker2"]\n      },\n      "Type B": {\n        "markers": ["Marker3", "Marker4"]\n      }\n    }\n  },\n  "Immune Cells": {\n    "markers": ["CD45"],\n    "anti_markers": ["EpCAM"],\n    "subtypes": {\n      "T Cells": {\n        "markers": ["CD3"]\n      },\n      "Macrophages": {\n        "markers": ["CD68", "CD163"]\n      }\n    }\n  },\n  "Stromal": {\n    "markers": ["Vimentin"],\n    "anti_markers": ["CD45", "EpCAM"]\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Save as ",(0,i.jsx)(n.code,{children:"marker_map.json"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"step-3-run-clustering",children:"Step 3: Run Clustering"}),"\n",(0,i.jsx)(n.p,{children:"Cluster cells using Leiden algorithm:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"celltype-refinery cluster \\\n  --input merged_data.h5ad \\\n  --resolution 0.6 \\\n  --n-pcs 30 \\\n  --out output/clustering\n"})}),"\n",(0,i.jsx)(n.p,{children:"Or in Python:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from celltype_refinery.core.clustering import ClusteringEngine\n\nengine = ClusteringEngine(resolution=0.6, n_pcs=30)\nresult = engine.run(adata, output_dir="output/clustering")\n\nprint(f"Found {result.n_clusters} clusters")\n'})}),"\n",(0,i.jsx)(n.h2,{id:"step-4-annotate-cell-types",children:"Step 4: Annotate Cell Types"}),"\n",(0,i.jsx)(n.p,{children:"Run annotation with your marker map:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"celltype-refinery annotate \\\n  --input output/clustering/clustered.h5ad \\\n  --marker-map marker_map.json \\\n  --out output/annotation\n"})}),"\n",(0,i.jsx)(n.p,{children:"Or in Python:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from celltype_refinery.core.annotation import AnnotationEngine\n\nengine = AnnotationEngine(marker_map_path="marker_map.json")\nresult = engine.run(adata, output_dir="output/annotation")\n\n# Review results\nprint(result.summary())\n'})}),"\n",(0,i.jsx)(n.h2,{id:"step-5-review-results",children:"Step 5: Review Results"}),"\n",(0,i.jsx)(n.p,{children:"Check the annotation outputs:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import pandas as pd\n\n# Load cluster annotations\nannotations = pd.read_csv("output/annotation/cluster_annotations.csv")\nprint(annotations[["cluster_id", "assigned_label", "score", "confidence"]])\n\n# Check cell-type distribution\nprint(adata.obs["cell_type_curated"].value_counts())\n'})}),"\n",(0,i.jsx)(n.h3,{id:"understanding-scores",children:"Understanding Scores"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Score Range"}),(0,i.jsx)(n.th,{children:"Confidence"}),(0,i.jsx)(n.th,{children:"Interpretation"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"> 2.0"}),(0,i.jsx)(n.td,{children:"HIGH"}),(0,i.jsx)(n.td,{children:"Strong marker expression"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"1.0 - 2.0"}),(0,i.jsx)(n.td,{children:"MEDIUM"}),(0,i.jsx)(n.td,{children:"Moderate expression"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"0.5 - 1.0"}),(0,i.jsx)(n.td,{children:"LOW"}),(0,i.jsx)(n.td,{children:"Weak expression"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"< 0.5"}),(0,i.jsx)(n.td,{children:"VERY_LOW"}),(0,i.jsx)(n.td,{children:"Consider refinement"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"step-6-refine-annotations",children:"Step 6: Refine Annotations"}),"\n",(0,i.jsx)(n.p,{children:"If some clusters have low confidence, refine them:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Diagnostic mode first (no changes)\ncelltype-refinery refine \\\n  --input output/annotation/annotated.h5ad \\\n  --auto \\\n  --out output/refinement\n\n# Review diagnostic report\ncat output/refinement/diagnostic_report.csv\n\n# Execute refinement\ncelltype-refinery refine \\\n  --input output/annotation/annotated.h5ad \\\n  --auto \\\n  --execute \\\n  --out output/refinement\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-7-run-analysis",children:"Step 7: Run Analysis"}),"\n",(0,i.jsx)(n.p,{children:"Generate composition and spatial analysis:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"celltype-refinery analyze \\\n  --input output/refinement/refined.h5ad \\\n  --out output/analysis\n"})}),"\n",(0,i.jsx)(n.h2,{id:"output-structure",children:"Output Structure"}),"\n",(0,i.jsx)(n.p,{children:"After completing all steps:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"output/\n\u251c\u2500\u2500 clustering/\n\u2502   \u251c\u2500\u2500 clustered.h5ad\n\u2502   \u2514\u2500\u2500 cluster_stats.csv\n\u251c\u2500\u2500 annotation/\n\u2502   \u251c\u2500\u2500 annotated.h5ad\n\u2502   \u251c\u2500\u2500 cluster_annotations.csv\n\u2502   \u251c\u2500\u2500 marker_scores.csv\n\u2502   \u2514\u2500\u2500 mapping_table.csv\n\u251c\u2500\u2500 refinement/\n\u2502   \u251c\u2500\u2500 refined.h5ad\n\u2502   \u251c\u2500\u2500 diagnostic_report.csv\n\u2502   \u2514\u2500\u2500 curation_log.json\n\u2514\u2500\u2500 analysis/\n    \u251c\u2500\u2500 composition/\n    \u251c\u2500\u2500 spatial/\n    \u2514\u2500\u2500 review/\n"})}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"high-unassigned-rate",children:"High Unassigned Rate"}),"\n",(0,i.jsx)(n.p,{children:"If many cells are unassigned:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Check marker names match between data and marker map"}),"\n",(0,i.jsxs)(n.li,{children:["Lower gating thresholds (",(0,i.jsx)(n.code,{children:"--min-coverage 0.2"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["Review marker expression with ",(0,i.jsx)(n.code,{children:"sc.pl.dotplot()"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"incorrect-annotations",children:"Incorrect Annotations"}),"\n",(0,i.jsx)(n.p,{children:"If cell types seem wrong:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Check marker specificity in your data"}),"\n",(0,i.jsx)(n.li,{children:"Add anti-markers to distinguish similar types"}),"\n",(0,i.jsx)(n.li,{children:"Use manual overrides for known misassignments"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"low-confidence-scores",children:"Low Confidence Scores"}),"\n",(0,i.jsx)(n.p,{children:"If scores are consistently low:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Verify data normalization"}),"\n",(0,i.jsx)(n.li,{children:"Check for batch effects"}),"\n",(0,i.jsx)(n.li,{children:"Consider fewer, more specific markers"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../core-workflows/workflow-overview",children:"Core Workflows"})," - Learn advanced patterns"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../modules/refinement/overview",children:"Refinement Guide"})," - Deep dive into refinement"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../configuration/marker-maps",children:"Configuration Reference"})," - Full parameter docs"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453(e,n,t){t.d(n,{R:()=>a,x:()=>l});var r=t(6540);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);