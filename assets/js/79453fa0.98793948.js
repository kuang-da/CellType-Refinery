"use strict";(globalThis.webpackChunkcelltype_refinery_docs=globalThis.webpackChunkcelltype_refinery_docs||[]).push([[9714],{2014(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"methodology/marker-scoring-algorithm","title":"Marker Scoring Algorithm","description":"This page explains scoring details. For conceptual background, see Methodology Overview first.","source":"@site/docs/methodology/marker-scoring-algorithm.md","sourceDirName":"methodology","slug":"/methodology/marker-scoring-algorithm","permalink":"/CellType-Refinery/docs/methodology/marker-scoring-algorithm","draft":false,"unlisted":false,"editUrl":"https://github.com/kuang-da/CellType-Refinery/tree/main/celltype-refinery-docs/docs/methodology/marker-scoring-algorithm.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docsSidebar","previous":{"title":"Annotation Pipeline","permalink":"/CellType-Refinery/docs/methodology/annotation-pipeline"},"next":{"title":"Hierarchical Gating Algorithm","permalink":"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm"}}');var s=i(4848),l=i(8453);const t={sidebar_position:3},a="Marker Scoring Algorithm",c={},d=[{value:"Overview",id:"overview",level:2},{value:"The Core Formula",id:"the-core-formula",level:3},{value:"Score Interpretation",id:"score-interpretation",level:3},{value:"Component 1: Mean Enrichment",id:"component-1-mean-enrichment",level:2},{value:"Calculation",id:"calculation",level:3},{value:"Step-by-Step Breakdown",id:"step-by-step-breakdown",level:3},{value:"Why Z-Scores?",id:"why-z-scores",level:3},{value:"Interpretation Guide",id:"interpretation-guide",level:3},{value:"Worked Example",id:"worked-example",level:3},{value:"Edge Cases and Handling",id:"edge-cases-and-handling",level:3},{value:"Component 2: Mean Positive Fraction",id:"component-2-mean-positive-fraction",level:2},{value:"Calculation",id:"calculation-1",level:3},{value:"Step-by-Step Breakdown",id:"step-by-step-breakdown-1",level:3},{value:"Why Q75 (75th Percentile)?",id:"why-q75-75th-percentile",level:3},{value:"Tuning the Threshold",id:"tuning-the-threshold",level:3},{value:"Worked Example",id:"worked-example-1",level:3},{value:"Interpreting Mean Positive",id:"interpreting-mean-positive",level:3},{value:"Component 3: DE Component (Rank-Weighted)",id:"component-3-de-component-rank-weighted",level:2},{value:"Conceptual Overview",id:"conceptual-overview",level:3},{value:"Step-by-Step Breakdown",id:"step-by-step-breakdown-2",level:3},{value:"Step 1: Determine K (Number of Top DE Genes)",id:"step-1-determine-k-number-of-top-de-genes",level:4},{value:"Step 2: Check DE Membership",id:"step-2-check-de-membership",level:4},{value:"Step 3: Calculate Rank Weight",id:"step-3-calculate-rank-weight",level:4},{value:"Step 4: Calculate Commonness Penalty",id:"step-4-calculate-commonness-penalty",level:4},{value:"Step 5: Combine and Average",id:"step-5-combine-and-average",level:4},{value:"Worked Example",id:"worked-example-2",level:3},{value:"Why Rank Weighting?",id:"why-rank-weighting",level:3},{value:"Why Commonness Penalty?",id:"why-commonness-penalty",level:3},{value:"Component 4: Anti-Marker Penalty",id:"component-4-anti-marker-penalty",level:2},{value:"Conceptual Overview",id:"conceptual-overview-1",level:3},{value:"Step-by-Step Breakdown",id:"step-by-step-breakdown-3",level:3},{value:"Step 1: Calculate Anti-Enrichment",id:"step-1-calculate-anti-enrichment",level:4},{value:"Step 2: Calculate Anti-Positive Fraction",id:"step-2-calculate-anti-positive-fraction",level:4},{value:"Step 3: Aggregate Across Anti-Markers",id:"step-3-aggregate-across-anti-markers",level:4},{value:"Step 4: Compute Final Penalty",id:"step-4-compute-final-penalty",level:4},{value:"Hard Gate Behavior",id:"hard-gate-behavior",level:3},{value:"Example Scenarios",id:"example-scenarios",level:3},{value:"Worked Example",id:"worked-example-3",level:3},{value:"Choosing Anti-Aggregation Mode",id:"choosing-anti-aggregation-mode",level:3},{value:"Putting It All Together",id:"putting-it-all-together",level:2},{value:"Complete Scoring Example",id:"complete-scoring-example",level:3},{value:"Parameter Reference",id:"parameter-reference",level:2},{value:"Positive Fraction Parameters",id:"positive-fraction-parameters",level:3},{value:"DE Component Parameters",id:"de-component-parameters",level:3},{value:"Anti-Marker Parameters",id:"anti-marker-parameters",level:3},{value:"Parameter Interaction Guidelines",id:"parameter-interaction-guidelines",level:3},{value:"Debugging Scores",id:"debugging-scores",level:2},{value:"Low Scores for Expected Cell Types",id:"low-scores-for-expected-cell-types",level:3},{value:"Multiple High-Scoring Cell Types",id:"multiple-high-scoring-cell-types",level:3},{value:"Unexpected Rejections (Hard Gate)",id:"unexpected-rejections-hard-gate",level:3},{value:"Mathematical Properties",id:"mathematical-properties",level:2},{value:"Score Range",id:"score-range",level:3},{value:"Component Independence",id:"component-independence",level:3},{value:"Normalization Considerations",id:"normalization-considerations",level:3},{value:"See Also",id:"see-also",level:2}];function o(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"marker-scoring-algorithm",children:"Marker Scoring Algorithm"})}),"\n",(0,s.jsx)(n.admonition,{title:"Prerequisites",type:"info",children:(0,s.jsxs)(n.p,{children:["This page explains scoring details. For conceptual background, see ",(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/",children:"Methodology Overview"})," first."]})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"The CellType-Refinery scoring algorithm evaluates how well each cluster matches each candidate cell type in the marker map. The algorithm produces a single numeric score for each (cluster, cell_type) pair, enabling systematic ranking and selection of the best-fitting annotation."}),"\n",(0,s.jsx)(n.h3,{id:"the-core-formula",children:"The Core Formula"}),"\n",(0,s.jsx)(n.p,{children:"The scoring formula for each (cluster, cell_type) pair:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"score = mean_enrichment + mean_positive + de_component - anti_penalty\n"})}),"\n",(0,s.jsx)(n.p,{children:"Each component captures a different biological signal:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Component"}),(0,s.jsx)(n.th,{children:"Range"}),(0,s.jsx)(n.th,{children:"What It Measures"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mean_enrichment"})}),(0,s.jsx)(n.td,{children:"Unbounded (typically -2 to +4)"}),(0,s.jsx)(n.td,{children:"How much higher is expression vs. global average?"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mean_positive"})}),(0,s.jsx)(n.td,{children:"0 to 1"}),(0,s.jsx)(n.td,{children:"What fraction of cells clearly express markers?"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"de_component"})}),(0,s.jsx)(n.td,{children:"0 to ~0.6"}),(0,s.jsx)(n.td,{children:"Are markers differentially expressed in this cluster?"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"anti_penalty"})}),(0,s.jsx)(n.td,{children:"0 to unbounded"}),(0,s.jsx)(n.td,{children:"Is conflicting marker expression present?"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"score-interpretation",children:"Score Interpretation"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Typical winning scores"}),": 1.5 to 4.0 for well-matched cell types"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Marginal matches"}),": 0.5 to 1.5, may indicate subtypes or transitional states"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Poor matches"}),": < 0.5, usually indicates wrong cell type assignment"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Negative scores"}),": Strong evidence against the cell type"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The following sections explain each component in detail with worked examples."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"component-1-mean-enrichment",children:"Component 1: Mean Enrichment"}),"\n",(0,s.jsx)(n.p,{children:"The mean enrichment component measures whether marker genes are expressed at higher levels in the cluster compared to the global population. This is the foundation of marker-based annotation."}),"\n",(0,s.jsx)(n.h3,{id:"calculation",children:"Calculation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"For each marker m in cell_type:\n    enrichment[m] = (cluster_median[m] - global_median[m]) / global_std[m]\n\nmean_enrichment = average(enrichment[all markers])\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-by-step-breakdown",children:"Step-by-Step Breakdown"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Calculate cluster median"}),": For marker gene ",(0,s.jsx)(n.code,{children:"m"}),", compute the median expression value across all cells in the cluster"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Calculate global median"}),": Compute the median expression across ALL cells in the dataset"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Calculate global standard deviation"}),": Compute std across all cells (measures natural variation)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Compute Z-score"}),": Standardize the difference using the global std"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Average across markers"}),": Take the mean of all marker Z-scores"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"why-z-scores",children:"Why Z-Scores?"}),"\n",(0,s.jsx)(n.p,{children:"Z-score normalization is essential because:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Different genes have different scales"}),": CD45 might range 0-10 while CD3 ranges 0-50"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Comparability"}),": Z-scores put all markers on the same scale"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Statistical interpretation"}),': A Z-score of 2 means "2 standard deviations above average"']}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"interpretation-guide",children:"Interpretation Guide"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Z-Score Range"}),(0,s.jsx)(n.th,{children:"Interpretation"}),(0,s.jsx)(n.th,{children:"Typical Scenario"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"> 2.0"}),(0,s.jsx)(n.td,{children:"Strong enrichment"}),(0,s.jsx)(n.td,{children:"Clear positive marker"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1.0 to 2.0"}),(0,s.jsx)(n.td,{children:"Moderate enrichment"}),(0,s.jsx)(n.td,{children:"Typical marker expression"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0 to 1.0"}),(0,s.jsx)(n.td,{children:"Weak enrichment"}),(0,s.jsx)(n.td,{children:"Subpopulation or dim expression"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"-1.0 to 0"}),(0,s.jsx)(n.td,{children:"No enrichment"}),(0,s.jsx)(n.td,{children:"Marker not characteristic"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"< -1.0"}),(0,s.jsx)(n.td,{children:"Depletion"}),(0,s.jsx)(n.td,{children:"Wrong cell type"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"worked-example",children:"Worked Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Cell type: T Cells\nMarkers: [CD3, CD4, CD8]\n\nCluster 3 statistics:\n  CD3: cluster_median=4.2, global_median=1.8, global_std=1.5\n  CD4: cluster_median=3.1, global_median=1.2, global_std=1.0\n  CD8: cluster_median=0.8, global_median=0.9, global_std=0.8\n\nEnrichment calculations:\n  CD3: (4.2 - 1.8) / 1.5 = 1.60\n  CD4: (3.1 - 1.2) / 1.0 = 1.90\n  CD8: (0.8 - 0.9) / 0.8 = -0.13\n\nmean_enrichment = (1.60 + 1.90 + (-0.13)) / 3 = 1.12\n"})}),"\n",(0,s.jsx)(n.p,{children:"This cluster shows strong enrichment for CD3 and CD4, but not CD8, suggesting CD4+ T cells rather than CD8+ T cells."}),"\n",(0,s.jsx)(n.h3,{id:"edge-cases-and-handling",children:"Edge Cases and Handling"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Zero variance markers"}),": If ",(0,s.jsx)(n.code,{children:"global_std = 0"}),", the marker is constant and skipped"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Missing markers"}),": Markers not in the expression matrix are excluded from calculation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Sparse data"}),": Median is robust to zeros from dropout in single-cell data"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"component-2-mean-positive-fraction",children:"Component 2: Mean Positive Fraction"}),"\n",(0,s.jsxs)(n.p,{children:["While mean enrichment measures ",(0,s.jsx)(n.em,{children:"how much"})," higher expression is, mean positive fraction measures ",(0,s.jsx)(n.em,{children:"how many"})," cells in the cluster clearly express the markers. This captures the consistency of marker expression."]}),"\n",(0,s.jsx)(n.h3,{id:"calculation-1",children:"Calculation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"For each marker m in cell_type:\n    threshold[m] = global_quantile[m, 0.75]  # Q75 by default\n    positive[m] = fraction of cells in cluster where expr >= threshold[m]\n\nmean_positive = average(positive[all markers])\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-by-step-breakdown-1",children:"Step-by-Step Breakdown"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Determine threshold"}),": Calculate the 75th percentile of expression across ALL cells"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Count positive cells"}),": For each cell in the cluster, check if expression >= threshold"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Calculate fraction"}),": Divide positive count by total cells in cluster"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Average across markers"}),": Mean of all marker positive fractions"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"why-q75-75th-percentile",children:"Why Q75 (75th Percentile)?"}),"\n",(0,s.jsx)(n.p,{children:"The 75th percentile threshold is chosen because:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Noise filtering"}),": Single-cell data has substantial technical noise and dropout"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Clear signal"}),": Q75 identifies cells with unambiguous expression"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Conservative"}),": Avoids false positives from background noise"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Biologically meaningful"}),': Captures the "clearly positive" population']}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"tuning-the-threshold",children:"Tuning the Threshold"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"positive_quantile"})," parameter allows adjustment:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Setting"}),(0,s.jsx)(n.th,{children:"Use Case"}),(0,s.jsx)(n.th,{children:"Effect"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0.90"}),(0,s.jsx)(n.td,{children:"Very stringent"}),(0,s.jsx)(n.td,{children:"Only the brightest cells count as positive"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0.75"}),(0,s.jsx)(n.td,{children:"Default"}),(0,s.jsx)(n.td,{children:"Balanced, works for most datasets"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0.50"}),(0,s.jsx)(n.td,{children:"Sparse data"}),(0,s.jsx)(n.td,{children:"More sensitive, useful for low-expression markers"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0.25"}),(0,s.jsx)(n.td,{children:"Very sparse"}),(0,s.jsx)(n.td,{children:"Very sensitive, may include noise"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"worked-example-1",children:"Worked Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Cell type: B Cells\nMarkers: [CD19, CD20, CD79a]\n\nGlobal Q75 thresholds:\n  CD19: Q75 = 2.5\n  CD20: Q75 = 1.8\n  CD79a: Q75 = 3.0\n\nCluster 7 (100 cells):\n  CD19: 85 cells >= 2.5 \u2192 positive = 0.85\n  CD20: 78 cells >= 1.8 \u2192 positive = 0.78\n  CD79a: 72 cells >= 3.0 \u2192 positive = 0.72\n\nmean_positive = (0.85 + 0.78 + 0.72) / 3 = 0.78\n"})}),"\n",(0,s.jsx)(n.p,{children:"A mean positive fraction of 0.78 indicates strong, consistent marker expression."}),"\n",(0,s.jsx)(n.h3,{id:"interpreting-mean-positive",children:"Interpreting Mean Positive"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Range"}),(0,s.jsx)(n.th,{children:"Interpretation"}),(0,s.jsx)(n.th,{children:"Typical Scenario"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"> 0.8"}),(0,s.jsx)(n.td,{children:"Excellent"}),(0,s.jsx)(n.td,{children:"Clear cell type, homogeneous cluster"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0.6 - 0.8"}),(0,s.jsx)(n.td,{children:"Good"}),(0,s.jsx)(n.td,{children:"Typical positive cluster"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0.4 - 0.6"}),(0,s.jsx)(n.td,{children:"Moderate"}),(0,s.jsx)(n.td,{children:"Mixed population or dim expression"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0.2 - 0.4"}),(0,s.jsx)(n.td,{children:"Weak"}),(0,s.jsx)(n.td,{children:"Subpopulation or wrong cell type"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"< 0.2"}),(0,s.jsx)(n.td,{children:"Poor"}),(0,s.jsx)(n.td,{children:"Likely wrong cell type"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"component-3-de-component-rank-weighted",children:"Component 3: DE Component (Rank-Weighted)"}),"\n",(0,s.jsx)(n.p,{children:"The differential expression (DE) component rewards cell types whose markers appear in the cluster's top differentially expressed genes. This leverages unsupervised DE analysis to validate marker-based annotations."}),"\n",(0,s.jsx)(n.h3,{id:"conceptual-overview",children:"Conceptual Overview"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  DE BONUS CALCULATION                                                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                         \u2502\n\u2502  For each marker m in cell_type's resolved markers:                     \u2502\n\u2502                                                                         \u2502\n\u2502    IF m is in cluster's top-K DE genes (upregulated):                   \u2502\n\u2502      rank = de_rank_lookup[cluster][m]  # 1-indexed                     \u2502\n\u2502      rank_weight = (K - rank + 1) / K   # Higher rank \u2192 higher weight   \u2502\n\u2502                                                                         \u2502\n\u2502      commonness = doc_freq[m] / n_cell_types                            \u2502\n\u2502      commonness_penalty = commonness ^ de_commonness_alpha              \u2502\n\u2502                                                                         \u2502\n\u2502      marker_bonus = rank_weight \xd7 (1 - commonness_penalty)              \u2502\n\u2502    ELSE:                                                                \u2502\n\u2502      marker_bonus = 0                                                   \u2502\n\u2502                                                                         \u2502\n\u2502  de_component = de_bonus \xd7 mean(marker_bonus for all markers)           \u2502\n\u2502                                                                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-by-step-breakdown-2",children:"Step-by-Step Breakdown"}),"\n",(0,s.jsx)(n.h4,{id:"step-1-determine-k-number-of-top-de-genes",children:"Step 1: Determine K (Number of Top DE Genes)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"K = clip(n_markers \xd7 de_top_frac, de_min_k, de_max_k)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Where:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"n_markers"})," = total unique markers in the panel"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"de_top_frac"})," = fraction of panel to consider (default 0.2)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"de_min_k"})," = minimum K value (default 3)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"de_max_k"})," = maximum K value (default 12)"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Example: Panel with 40 markers \u2192 K = clip(40 \xd7 0.2, 3, 12) = clip(8, 3, 12) = 8"}),"\n",(0,s.jsx)(n.h4,{id:"step-2-check-de-membership",children:"Step 2: Check DE Membership"}),"\n",(0,s.jsx)(n.p,{children:"For each marker in the cell type, check if it appears in the cluster's top-K upregulated genes."}),"\n",(0,s.jsx)(n.h4,{id:"step-3-calculate-rank-weight",children:"Step 3: Calculate Rank Weight"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"rank_weight = (K - rank + 1) / K\n"})}),"\n",(0,s.jsx)(n.p,{children:"This creates a linear decay from 1.0 (rank 1) to 1/K (rank K):"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Rank"}),(0,s.jsx)(n.th,{children:"K=8 Weight"}),(0,s.jsx)(n.th,{children:"K=12 Weight"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1"}),(0,s.jsx)(n.td,{children:"1.000"}),(0,s.jsx)(n.td,{children:"1.000"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"2"}),(0,s.jsx)(n.td,{children:"0.875"}),(0,s.jsx)(n.td,{children:"0.917"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:"0.750"}),(0,s.jsx)(n.td,{children:"0.833"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"4"}),(0,s.jsx)(n.td,{children:"0.625"}),(0,s.jsx)(n.td,{children:"0.750"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"5"}),(0,s.jsx)(n.td,{children:"0.500"}),(0,s.jsx)(n.td,{children:"0.667"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"6"}),(0,s.jsx)(n.td,{children:"0.375"}),(0,s.jsx)(n.td,{children:"0.583"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"step-4-calculate-commonness-penalty",children:"Step 4: Calculate Commonness Penalty"}),"\n",(0,s.jsx)(n.p,{children:"Markers that appear in many cell type definitions are less informative:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"commonness = doc_freq[m] / n_cell_types\ncommonness_penalty = commonness ^ de_commonness_alpha\neffective_weight = 1 - commonness_penalty\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Example with ",(0,s.jsx)(n.code,{children:"de_commonness_alpha = 0.5"}),":"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Marker Usage"}),(0,s.jsx)(n.th,{children:"Commonness"}),(0,s.jsx)(n.th,{children:"Penalty"}),(0,s.jsx)(n.th,{children:"Effective Weight"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Unique (1/20)"}),(0,s.jsx)(n.td,{children:"0.05"}),(0,s.jsx)(n.td,{children:"0.22"}),(0,s.jsx)(n.td,{children:"0.78"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Moderate (5/20)"}),(0,s.jsx)(n.td,{children:"0.25"}),(0,s.jsx)(n.td,{children:"0.50"}),(0,s.jsx)(n.td,{children:"0.50"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Common (10/20)"}),(0,s.jsx)(n.td,{children:"0.50"}),(0,s.jsx)(n.td,{children:"0.71"}),(0,s.jsx)(n.td,{children:"0.29"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Ubiquitous (20/20)"}),(0,s.jsx)(n.td,{children:"1.00"}),(0,s.jsx)(n.td,{children:"1.00"}),(0,s.jsx)(n.td,{children:"0.00"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"step-5-combine-and-average",children:"Step 5: Combine and Average"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"marker_bonus = rank_weight \xd7 (1 - commonness_penalty)\nde_component = de_bonus \xd7 mean(marker_bonus for all markers)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"worked-example-2",children:"Worked Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Cell type: Immune Cells\nMarkers: [CD45, CD3, CD19]\n\nCluster 5 top-K DE: [CD45 (rank 1), VWF (rank 2), CD3 (rank 4), ...]\nK = 8, de_bonus = 0.6, de_commonness_alpha = 0.5\n\nDocument frequencies (20 cell types total):\n  CD45: appears in 2 cell types \u2192 commonness = 0.10\n  CD3: appears in 4 cell types \u2192 commonness = 0.20\n  CD19: appears in 2 cell types \u2192 commonness = 0.10\n\nCalculations:\n  CD45: rank=1\n        rank_weight = (8-1+1)/8 = 1.0\n        commonness_penalty = 0.10^0.5 = 0.316\n        bonus = 1.0 \xd7 (1 - 0.316) = 0.68\n\n  CD3:  rank=4\n        rank_weight = (8-4+1)/8 = 0.625\n        commonness_penalty = 0.20^0.5 = 0.447\n        bonus = 0.625 \xd7 (1 - 0.447) = 0.34\n\n  CD19: not in top-K\n        bonus = 0\n\nde_component = 0.6 \xd7 mean([0.68, 0.34, 0]) = 0.6 \xd7 0.34 = 0.20\n"})}),"\n",(0,s.jsx)(n.h3,{id:"why-rank-weighting",children:"Why Rank Weighting?"}),"\n",(0,s.jsx)(n.p,{children:"Rank weighting captures the intuition that:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Top-ranked DE genes are most distinctive"})," for the cluster"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Lower-ranked genes add some evidence"})," but are less specific"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Non-DE genes contribute nothing"})," (they don't distinguish the cluster)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"why-commonness-penalty",children:"Why Commonness Penalty?"}),"\n",(0,s.jsx)(n.p,{children:"The commonness penalty prevents ubiquitous markers from dominating:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CD45 (pan-immune) shouldn't boost all immune types equally"}),"\n",(0,s.jsx)(n.li,{children:"Cell-type-specific markers (e.g., CD19 for B cells) should matter more"}),"\n",(0,s.jsx)(n.li,{children:'Prevents "generic" markers from creating false matches'}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"component-4-anti-marker-penalty",children:"Component 4: Anti-Marker Penalty"}),"\n",(0,s.jsx)(n.p,{children:"Anti-markers define genes that should NOT be expressed in a cell type. The anti-marker penalty reduces scores when conflicting markers are detected, preventing misannotation."}),"\n",(0,s.jsx)(n.h3,{id:"conceptual-overview-1",children:"Conceptual Overview"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  ANTI-MARKER PENALTY CALCULATION                                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                         \u2502\n\u2502  For each anti-marker a in cell_type.anti_markers:                      \u2502\n\u2502                                                                         \u2502\n\u2502    anti_enrichment[a] = (cluster_median[a] - global_median[a]) / std[a] \u2502\n\u2502    anti_enrichment[a] = max(anti_enrichment[a], 0)  # Clip negative     \u2502\n\u2502                                                                         \u2502\n\u2502    anti_positive[a] = fraction of cells >= Q75 threshold                \u2502\n\u2502                                                                         \u2502\n\u2502  Aggregation modes (--anti-agg):                                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 "max"           \u2502 Strictest: max(anti-markers)                    \u2502  \u2502\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502\n\u2502  \u2502 "top2mean"      \u2502 DEFAULT: mean of top 2 anti-markers             \u2502  \u2502\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502\n\u2502  \u2502 "mean"          \u2502 Lenient: mean of all anti-markers               \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                         \u2502\n\u2502  anti_penalty = anti_weight \xd7 (agg_enrichment + agg_positive)           \u2502\n\u2502                                                                         \u2502\n\u2502  HARD GATE: If anti_penalty > 1.0, the cell type is REJECTED            \u2502\n\u2502                                                                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,s.jsx)(n.h3,{id:"step-by-step-breakdown-3",children:"Step-by-Step Breakdown"}),"\n",(0,s.jsx)(n.h4,{id:"step-1-calculate-anti-enrichment",children:"Step 1: Calculate Anti-Enrichment"}),"\n",(0,s.jsx)(n.p,{children:"For each anti-marker, compute a Z-score similar to mean enrichment:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"anti_enrichment[a] = (cluster_median[a] - global_median[a]) / global_std[a]\nanti_enrichment[a] = max(anti_enrichment[a], 0)  # Only positive values penalize\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The clipping to zero is important: we only penalize when anti-markers are ",(0,s.jsx)(n.em,{children:"enriched"}),", not when they're absent (which is expected)."]}),"\n",(0,s.jsx)(n.h4,{id:"step-2-calculate-anti-positive-fraction",children:"Step 2: Calculate Anti-Positive Fraction"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"anti_positive[a] = fraction of cells in cluster where expr >= Q75 threshold\n"})}),"\n",(0,s.jsx)(n.p,{children:"This measures how many cells express the anti-marker."}),"\n",(0,s.jsx)(n.h4,{id:"step-3-aggregate-across-anti-markers",children:"Step 3: Aggregate Across Anti-Markers"}),"\n",(0,s.jsx)(n.p,{children:"The aggregation method determines how multiple anti-markers combine:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Method"}),(0,s.jsx)(n.th,{children:"Formula"}),(0,s.jsx)(n.th,{children:"Use Case"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"max"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"max(anti_enrichment), max(anti_positive)"})}),(0,s.jsx)(n.td,{children:"Strict: any conflict rejects"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"top2mean"})}),(0,s.jsx)(n.td,{children:"Mean of top 2 values"}),(0,s.jsx)(n.td,{children:"Balanced: robust to single outliers"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mean"})}),(0,s.jsx)(n.td,{children:"Mean of all values"}),(0,s.jsx)(n.td,{children:"Lenient: only strong conflicts penalize"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"step-4-compute-final-penalty",children:"Step 4: Compute Final Penalty"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"anti_penalty = anti_weight \xd7 (agg_enrichment + agg_positive)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"hard-gate-behavior",children:"Hard Gate Behavior"}),"\n",(0,s.jsxs)(n.p,{children:["When ",(0,s.jsx)(n.code,{children:"anti_penalty > 1.0"}),", the cell type is completely rejected:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The score is set to a large negative value (e.g., -999)"}),"\n",(0,s.jsx)(n.li,{children:"This cell type cannot be selected regardless of other scores"}),"\n",(0,s.jsx)(n.li,{children:"Prevents obvious biological conflicts"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-scenarios",children:"Example Scenarios"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Scenario"}),(0,s.jsx)(n.th,{children:"Anti-Enrichment"}),(0,s.jsx)(n.th,{children:"Anti-Positive"}),(0,s.jsx)(n.th,{children:"Penalty (w=0.5)"}),(0,s.jsx)(n.th,{children:"Result"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Clean"}),(0,s.jsx)(n.td,{children:"0.0"}),(0,s.jsx)(n.td,{children:"0.05"}),(0,s.jsx)(n.td,{children:"0.025"}),(0,s.jsx)(n.td,{children:"Minor"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Mild conflict"}),(0,s.jsx)(n.td,{children:"0.5"}),(0,s.jsx)(n.td,{children:"0.15"}),(0,s.jsx)(n.td,{children:"0.325"}),(0,s.jsx)(n.td,{children:"Moderate"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Moderate conflict"}),(0,s.jsx)(n.td,{children:"1.2"}),(0,s.jsx)(n.td,{children:"0.35"}),(0,s.jsx)(n.td,{children:"0.775"}),(0,s.jsx)(n.td,{children:"Significant"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Strong conflict"}),(0,s.jsx)(n.td,{children:"2.5"}),(0,s.jsx)(n.td,{children:"0.65"}),(0,s.jsx)(n.td,{children:"1.575"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"REJECTED"})})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"worked-example-3",children:"Worked Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Cell type: CD4+ T Cells\nAnti-markers: [CD8, CD19, CD14]\n\nCluster 8 statistics:\n  CD8:  cluster_median=2.1, global_median=0.8, global_std=0.9\n        enrichment = (2.1-0.8)/0.9 = 1.44, positive = 0.25\n  CD19: cluster_median=0.2, global_median=0.5, global_std=0.6\n        enrichment = max((0.2-0.5)/0.6, 0) = 0, positive = 0.02\n  CD14: cluster_median=0.1, global_median=0.3, global_std=0.4\n        enrichment = max((0.1-0.3)/0.4, 0) = 0, positive = 0.01\n\nUsing top2mean aggregation:\n  Top 2 enrichments: [1.44, 0] \u2192 mean = 0.72\n  Top 2 positives: [0.25, 0.02] \u2192 mean = 0.135\n\nanti_penalty = 0.5 \xd7 (0.72 + 0.135) = 0.43\n"})}),"\n",(0,s.jsx)(n.p,{children:"This penalty of 0.43 significantly reduces the score, flagging potential CD8 contamination."}),"\n",(0,s.jsx)(n.h3,{id:"choosing-anti-aggregation-mode",children:"Choosing Anti-Aggregation Mode"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Mode"}),(0,s.jsx)(n.th,{children:"Best For"}),(0,s.jsx)(n.th,{children:"Behavior"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"max"})}),(0,s.jsx)(n.td,{children:"Well-defined types with clear exclusions"}),(0,s.jsx)(n.td,{children:"Single strong conflict rejects"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"top2mean"})}),(0,s.jsx)(n.td,{children:"Most datasets (default)"}),(0,s.jsx)(n.td,{children:"Robust to noise, catches real conflicts"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mean"})}),(0,s.jsx)(n.td,{children:"Complex panels, many anti-markers"}),(0,s.jsx)(n.td,{children:"Only consistent conflicts penalize"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"putting-it-all-together",children:"Putting It All Together"}),"\n",(0,s.jsx)(n.h3,{id:"complete-scoring-example",children:"Complete Scoring Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Cell type: NK Cells\nMarkers: [CD56, CD16, NKG2D]\nAnti-markers: [CD3, CD19]\n\nCluster 12 (150 cells)\n\nStep 1: Mean Enrichment\n  CD56: Z = 2.1\n  CD16: Z = 1.8\n  NKG2D: Z = 1.5\n  mean_enrichment = 1.80\n\nStep 2: Mean Positive\n  CD56: 0.82\n  CD16: 0.75\n  NKG2D: 0.68\n  mean_positive = 0.75\n\nStep 3: DE Component\n  CD56: rank 2, bonus = 0.52\n  CD16: rank 5, bonus = 0.28\n  NKG2D: not in top-K, bonus = 0\n  de_component = 0.6 \xd7 0.27 = 0.16\n\nStep 4: Anti-Penalty\n  CD3: enrichment = 0.3, positive = 0.08\n  CD19: enrichment = 0, positive = 0.01\n  anti_penalty = 0.5 \xd7 (0.15 + 0.045) = 0.10\n\nFinal Score:\n  score = 1.80 + 0.75 + 0.16 - 0.10 = 2.61\n"})}),"\n",(0,s.jsx)(n.p,{children:"A score of 2.61 indicates a strong NK cell match."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"parameter-reference",children:"Parameter Reference"}),"\n",(0,s.jsx)(n.p,{children:"The following parameters control scoring behavior. They can be set via command-line arguments or configuration files."}),"\n",(0,s.jsx)(n.h3,{id:"positive-fraction-parameters",children:"Positive Fraction Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Effect"}),(0,s.jsx)(n.th,{children:"When to Adjust"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"positive_quantile"})}),(0,s.jsx)(n.td,{children:"0.75"}),(0,s.jsx)(n.td,{children:'Threshold for "positive" cells'}),(0,s.jsx)(n.td,{children:"Sparse data \u2192 lower to 0.5-0.6"})]})})]}),"\n",(0,s.jsx)(n.h3,{id:"de-component-parameters",children:"DE Component Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Effect"}),(0,s.jsx)(n.th,{children:"When to Adjust"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"de_bonus"})}),(0,s.jsx)(n.td,{children:"0.5-0.6"}),(0,s.jsx)(n.td,{children:"Weight of DE component"}),(0,s.jsx)(n.td,{children:"Good DE results \u2192 increase to 0.7"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"de_top_frac"})}),(0,s.jsx)(n.td,{children:"0.2"}),(0,s.jsx)(n.td,{children:"Fraction of panel for K"}),(0,s.jsx)(n.td,{children:"Large panel (>50) \u2192 decrease to 0.15"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"de_min_k"})}),(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:"Minimum top-K"}),(0,s.jsx)(n.td,{children:"Small panels \u2192 keep at 3"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"de_max_k"})}),(0,s.jsx)(n.td,{children:"12"}),(0,s.jsx)(n.td,{children:"Maximum top-K"}),(0,s.jsx)(n.td,{children:"Large panels (>60) \u2192 increase to 15"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"de_commonness_alpha"})}),(0,s.jsx)(n.td,{children:"0.5"}),(0,s.jsx)(n.td,{children:"Commonness penalty strength"}),(0,s.jsx)(n.td,{children:"Many shared markers \u2192 increase to 0.7"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"anti-marker-parameters",children:"Anti-Marker Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Effect"}),(0,s.jsx)(n.th,{children:"When to Adjust"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"anti_weight"})}),(0,s.jsx)(n.td,{children:"0.5-0.8"}),(0,s.jsx)(n.td,{children:"Penalty strength"}),(0,s.jsx)(n.td,{children:"Wrong assignments \u2192 increase to 0.8-1.0"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"anti_agg"})}),(0,s.jsx)(n.td,{children:"top2mean"}),(0,s.jsx)(n.td,{children:"Aggregation method"}),(0,s.jsx)(n.td,{children:"Strict \u2192 use max; lenient \u2192 use mean"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"parameter-interaction-guidelines",children:"Parameter Interaction Guidelines"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Sparse data"}),": Lower ",(0,s.jsx)(n.code,{children:"positive_quantile"}),", may need higher ",(0,s.jsx)(n.code,{children:"de_bonus"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Dense data"}),": Default parameters usually work well"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Many similar cell types"}),": Increase ",(0,s.jsx)(n.code,{children:"anti_weight"}),", consider ",(0,s.jsx)(n.code,{children:"max"})," aggregation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Large marker panel"}),": Decrease ",(0,s.jsx)(n.code,{children:"de_top_frac"}),", increase ",(0,s.jsx)(n.code,{children:"de_max_k"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Poor DE results"}),": Decrease ",(0,s.jsx)(n.code,{children:"de_bonus"}),", rely more on expression"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"debugging-scores",children:"Debugging Scores"}),"\n",(0,s.jsx)(n.p,{children:"When scores seem incorrect, check these common issues:"}),"\n",(0,s.jsx)(n.h3,{id:"low-scores-for-expected-cell-types",children:"Low Scores for Expected Cell Types"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Check marker expression"}),": Are markers actually expressed in the cluster?"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify DE results"}),": Are markers appearing in DE gene lists?"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Inspect anti-markers"}),": Is an anti-marker unexpectedly enriched?"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Review thresholds"}),": Is ",(0,s.jsx)(n.code,{children:"positive_quantile"})," too stringent?"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"multiple-high-scoring-cell-types",children:"Multiple High-Scoring Cell Types"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Check for subtypes"}),": Parent and child types may both score well"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Review anti-markers"}),": Add more discriminating anti-markers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Inspect markers"}),": Are marker sets too overlapping?"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Consider DE bonus"}),": Increase to differentiate similar types"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"unexpected-rejections-hard-gate",children:"Unexpected Rejections (Hard Gate)"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify anti-marker enrichment"}),": Is rejection justified?"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Check for batch effects"}),": Technical artifacts can cause false conflicts"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Review aggregation mode"}),": Switch from ",(0,s.jsx)(n.code,{children:"max"})," to ",(0,s.jsx)(n.code,{children:"top2mean"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Adjust anti_weight"}),": Lower if rejections seem too aggressive"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"mathematical-properties",children:"Mathematical Properties"}),"\n",(0,s.jsx)(n.h3,{id:"score-range",children:"Score Range"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Theoretical minimum"}),": Unbounded negative (due to enrichment Z-scores)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Practical minimum"}),": -2 to 0 for poor matches"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Theoretical maximum"}),": Unbounded positive"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Practical maximum"}),": 3 to 5 for excellent matches"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"component-independence",children:"Component Independence"}),"\n",(0,s.jsx)(n.p,{children:"The four components are largely independent:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A cluster can have high enrichment but low positive fraction (bimodal expression)"}),"\n",(0,s.jsx)(n.li,{children:"DE bonus can be high even with moderate enrichment (distinct markers)"}),"\n",(0,s.jsx)(n.li,{children:"Anti-penalty applies regardless of positive component values"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"normalization-considerations",children:"Normalization Considerations"}),"\n",(0,s.jsx)(n.p,{children:"The algorithm does NOT normalize scores across cell types. This is intentional:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Absolute scores indicate match quality"}),"\n",(0,s.jsx)(n.li,{children:'Enables setting quality thresholds (e.g., "minimum score of 1.0")'}),"\n",(0,s.jsx)(n.li,{children:"Allows comparison across different runs"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm",children:"Hierarchical Gating Algorithm"})," - How scores determine labels at each hierarchy level"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/tuning-guide",children:"Tuning Guide"})," - Practical guidance for adjusting scoring parameters"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/CellType-Refinery/docs/methodology/",children:"Methodology Overview"})," - Conceptual background on the annotation approach"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},8453(e,n,i){i.d(n,{R:()=>t,x:()=>a});var r=i(6540);const s={},l=r.createContext(s);function t(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);