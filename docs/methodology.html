<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-methodology/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Cell Type Annotation Methodology | CellType-Refinery</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kuang-da.github.io/CellType-Refinery/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://kuang-da.github.io/CellType-Refinery/img/social-card.png"><meta data-rh="true" property="og:url" content="https://kuang-da.github.io/CellType-Refinery/docs/methodology"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cell Type Annotation Methodology | CellType-Refinery"><meta data-rh="true" name="description" content="This document describes the core methodological contribution of CellType-Refinery: a hierarchical marker-based annotation system that combines the scalability of automated clustering with the biological rigor of expert-defined marker hierarchies. Unlike traditional approaches that rely on post-hoc manual annotation of unsupervised clusters, our method embeds domain knowledge directly into the assignment algorithm, producing interpretable and reproducible cell type labels at scale."><meta data-rh="true" property="og:description" content="This document describes the core methodological contribution of CellType-Refinery: a hierarchical marker-based annotation system that combines the scalability of automated clustering with the biological rigor of expert-defined marker hierarchies. Unlike traditional approaches that rely on post-hoc manual annotation of unsupervised clusters, our method embeds domain knowledge directly into the assignment algorithm, producing interpretable and reproducible cell type labels at scale."><link data-rh="true" rel="icon" href="/CellType-Refinery/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kuang-da.github.io/CellType-Refinery/docs/methodology"><link data-rh="true" rel="alternate" href="https://kuang-da.github.io/CellType-Refinery/docs/methodology" hreflang="en"><link data-rh="true" rel="alternate" href="https://kuang-da.github.io/CellType-Refinery/docs/methodology" hreflang="x-default"><link rel="stylesheet" href="/CellType-Refinery/assets/css/styles.be0b7b16.css">
<script src="/CellType-Refinery/assets/js/runtime~main.adcd1756.js" defer="defer"></script>
<script src="/CellType-Refinery/assets/js/main.396c890a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/CellType-Refinery/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/CellType-Refinery/"><div class="navbar__logo"><img src="/CellType-Refinery/img/logo.svg" alt="CellType-Refinery Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/CellType-Refinery/img/logo.svg" alt="CellType-Refinery Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">CellType-Refinery</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/CellType-Refinery/docs">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kuang-da/CellType-Refinery" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/CellType-Refinery/docs">CellType-Refinery</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/getting-started/installation">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/CellType-Refinery/docs/methodology">Methodology</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/CellType-Refinery/docs/methodology">Cell Type Annotation Methodology</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/annotation-pipeline">Annotation Pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/marker-scoring-algorithm">Marker Scoring Algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm">Hierarchical Gating Algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/refinement-decision-logic">Refinement Decision Logic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/tuning-guide">Tuning Guide</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/core-workflows/workflow-overview">Core Workflows</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/modules/preprocessing/overview">Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/cli/overview">CLI Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/configuration/marker-maps">Configuration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/reference/glossary">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/examples/fallopian-tube">Examples</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/CellType-Refinery/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Methodology</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Cell Type Annotation Methodology</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Cell Type Annotation Methodology</h1></header>
<p>This document describes the core methodological contribution of CellType-Refinery: a hierarchical marker-based annotation system that combines the scalability of automated clustering with the biological rigor of expert-defined marker hierarchies. Unlike traditional approaches that rely on post-hoc manual annotation of unsupervised clusters, our method embeds domain knowledge directly into the assignment algorithm, producing interpretable and reproducible cell type labels at scale.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem">The Problem<a href="#the-problem" class="hash-link" aria-label="Direct link to The Problem" title="Direct link to The Problem">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="traditional-clustering-falls-short-at-scale">Traditional Clustering Falls Short at Scale<a href="#traditional-clustering-falls-short-at-scale" class="hash-link" aria-label="Direct link to Traditional Clustering Falls Short at Scale" title="Direct link to Traditional Clustering Falls Short at Scale">​</a></h3>
<p>The standard single-cell annotation workflow follows a familiar pattern: cluster cells using an unsupervised algorithm (typically Leiden or Louvain), then manually inspect each cluster to assign biological labels. This approach has served the field well for small datasets, but breaks down as datasets grow:</p>
<ul>
<li><strong>Manual bottleneck</strong>: A dataset with 50-100 clusters requires significant expert time to annotate, and this work must be repeated whenever clustering parameters change.</li>
<li><strong>Inconsistent labels</strong>: Different annotators may assign different labels to similar clusters, and the same annotator may be inconsistent across sessions.</li>
<li><strong>No audit trail</strong>: When a cluster is labeled &quot;CD8+ T cells,&quot; there is often no record of which markers were considered, which were present, or how close the call was.</li>
<li><strong>Binary decisions</strong>: Traditional annotation forces a single label per cluster, even when the evidence is genuinely ambiguous.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="marker-ambiguity-and-overlapping-cell-types">Marker Ambiguity and Overlapping Cell Types<a href="#marker-ambiguity-and-overlapping-cell-types" class="hash-link" aria-label="Direct link to Marker Ambiguity and Overlapping Cell Types" title="Direct link to Marker Ambiguity and Overlapping Cell Types">​</a></h3>
<p>Biological complexity compounds these challenges:</p>
<ul>
<li><strong>Shared markers</strong>: Many markers are expressed by multiple cell types. CD45 is expressed by all immune cells; EpCAM is expressed by multiple epithelial subtypes. A cluster expressing CD45 alone cannot be assigned to a specific immune lineage.</li>
<li><strong>Continuous phenotypes</strong>: Cell states exist on a continuum. A &quot;transitional&quot; cell may express markers from two canonical types, making assignment genuinely difficult.</li>
<li><strong>Panel limitations</strong>: Multiplexed imaging panels (20-60 markers) cannot capture the full transcriptome. A panel may lack the discriminating markers for certain cell types.</li>
<li><strong>Technical noise</strong>: Spillover, autofluorescence, and batch effects can obscure true biological signal.</li>
</ul>
<p>These realities mean that any automated annotation system must handle ambiguity gracefully, rather than pretending it does not exist.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-insight-hierarchical-marker-based-gating">Key Insight: Hierarchical Marker-Based Gating<a href="#key-insight-hierarchical-marker-based-gating" class="hash-link" aria-label="Direct link to Key Insight: Hierarchical Marker-Based Gating" title="Direct link to Key Insight: Hierarchical Marker-Based Gating">​</a></h2>
<p>The central insight of CellType-Refinery is that cell type annotation should mirror how experts actually think about cell identity: as a hierarchical decision tree where each branch point is defined by specific marker requirements.</p>
<p>Consider how a pathologist would identify a neutrophil:</p>
<ol>
<li>First, confirm the cell is immune (CD45+, not epithelial)</li>
<li>Then, confirm it is myeloid (not lymphoid)</li>
<li>Then, confirm it is granulocytic (not monocytic)</li>
<li>Finally, distinguish neutrophil from eosinophil based on specific markers</li>
</ol>
<p>This hierarchical reasoning has critical implications for algorithm design:</p>
<ul>
<li><strong>Order matters</strong>: You cannot meaningfully compare a neutrophil to an epithelial cell. They exist at different positions in the hierarchy.</li>
<li><strong>Parents gate children</strong>: A cluster cannot be considered for &quot;Neutrophil&quot; unless it first passes the gates for &quot;Immune,&quot; &quot;Myeloid,&quot; and &quot;Granulocyte.&quot;</li>
<li><strong>Siblings compete</strong>: At each level, only nodes sharing a parent are compared. Neutrophils compete with eosinophils, not with T cells.</li>
</ul>
<p>This structure is not just computationally convenient; it reflects biological reality. Cell types are organized hierarchically, and annotation should respect that organization.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="beyond-simple-clustering">Beyond Simple Clustering<a href="#beyond-simple-clustering" class="hash-link" aria-label="Direct link to Beyond Simple Clustering" title="Direct link to Beyond Simple Clustering">​</a></h3>
<p>Traditional approaches treat clustering and annotation as separate steps:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cells → Cluster → Manual Review → Labels</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>CellType-Refinery integrates domain knowledge into the assignment process:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cells → Cluster → Hierarchical Gating → Traceable Labels + Confidence Scores</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The key differences:</p>
<table><thead><tr><th>Traditional Approach</th><th>CellType-Refinery</th></tr></thead><tbody><tr><td>Labels assigned post-hoc by expert</td><td>Labels assigned algorithmically using expert-defined rules</td></tr><tr><td>No confidence scores</td><td>Every assignment has a confidence score</td></tr><tr><td>No audit trail</td><td>Every decision step is logged</td></tr><tr><td>Binary labels only</td><td>Ambiguous cases flagged for review</td></tr><tr><td>Restart from scratch if markers change</td><td>Re-run annotation without re-clustering</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-principles">Design Principles<a href="#design-principles" class="hash-link" aria-label="Direct link to Design Principles" title="Direct link to Design Principles">​</a></h2>
<p>The annotation algorithm is built on five core principles, each addressing a specific failure mode of traditional approaches:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-parents-as-gates">1. Parents as Gates<a href="#1-parents-as-gates" class="hash-link" aria-label="Direct link to 1. Parents as Gates" title="Direct link to 1. Parents as Gates">​</a></h3>
<p>A cluster must pass the parent&#x27;s gate before comparing with siblings. This prevents biologically meaningless comparisons and ensures that each level of the hierarchy adds specificity.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Wrong: Compare Epithelium vs Immune vs Neutrophils directly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Right: Must pass Immune gate before comparing Neutrophils vs Eosinophils</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For example, a cluster cannot be considered for &quot;Ciliated Epithelium&quot; unless it first demonstrates strong epithelial markers (EpCAM, E-cadherin). This prevents a cluster of immune cells with weak off-target EpCAM signal from being erroneously assigned an epithelial label.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-siblings-only-competition">2. Siblings-Only Competition<a href="#2-siblings-only-competition" class="hash-link" aria-label="Direct link to 2. Siblings-Only Competition" title="Direct link to 2. Siblings-Only Competition">​</a></h3>
<p>At each level, only compare nodes that share a parent. This maintains biological coherence and prevents the algorithm from making comparisons that an expert would never make.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Level 0: Epithelium vs Immune vs Mesenchymal vs Endothelium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Level 1 (under Immune): Lymphoids vs Myeloids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Level 2 (under Myeloids): Granulocytes vs Monocytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Never compare: Neutrophils vs Ciliated Epithelium (different branches)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This principle ensures that the discriminating markers are always appropriate for the comparison being made.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-traceable-decisions">3. Traceable Decisions<a href="#3-traceable-decisions" class="hash-link" aria-label="Direct link to 3. Traceable Decisions" title="Direct link to 3. Traceable Decisions">​</a></h3>
<p>Every assignment step is logged with full context. For any cluster, you can trace exactly which candidates were considered, which passed or failed gates (and why), and how the final selection was made.</p>
<p>This traceability serves multiple purposes:</p>
<ul>
<li><strong>Debugging</strong>: When an assignment seems wrong, you can inspect the decision trace to understand why</li>
<li><strong>Quality control</strong>: Reviewers can audit the algorithm&#x27;s reasoning</li>
<li><strong>Reproducibility</strong>: The same inputs always produce the same outputs, with full documentation</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-ambiguity-detection">4. Ambiguity Detection<a href="#4-ambiguity-detection" class="hash-link" aria-label="Direct link to 4. Ambiguity Detection" title="Direct link to 4. Ambiguity Detection">​</a></h3>
<p>Close calls are flagged for review rather than forced into a single label. The algorithm distinguishes between:</p>
<ul>
<li><strong>Confident assignments</strong>: Clear winner with large margin over alternatives</li>
<li><strong>Ambiguous assignments</strong>: Two or more candidates within the minimum gap threshold</li>
</ul>
<p>When ambiguity is detected, the algorithm:</p>
<ul>
<li>Assigns the parent label (not a child)</li>
<li>Records the stop reason as &quot;ambiguous_siblings&quot;</li>
<li>Collects per-cell voting evidence for downstream refinement</li>
</ul>
<p>This approach acknowledges biological reality: some clusters genuinely contain mixed populations or transitional states.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-evidence-vs-override">5. Evidence vs Override<a href="#5-evidence-vs-override" class="hash-link" aria-label="Direct link to 5. Evidence vs Override" title="Direct link to 5. Evidence vs Override">​</a></h3>
<p>Per-cell voting provides evidence but never overrides cluster-level assignments. When siblings are too close to call at the cluster level, the algorithm computes per-cell scores for each candidate and records the vote composition.</p>
<p>This evidence is invaluable for refinement decisions:</p>
<ul>
<li>If 80% of cells vote for one type and 20% for another, subclustering may reveal two distinct populations</li>
<li>If votes are evenly split, the cluster may represent a genuine transitional state</li>
</ul>
<p>Critically, this voting does not override the cluster-level assignment. The cluster is labeled with the parent type, and the voting composition is stored as evidence for expert review or Stage I refinement.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pipeline-overview">Pipeline Overview<a href="#pipeline-overview" class="hash-link" aria-label="Direct link to Pipeline Overview" title="Direct link to Pipeline Overview">​</a></h2>
<p>The complete annotation pipeline consists of two major stages that work together iteratively:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                    CELL TYPE ANNOTATION PIPELINE                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  STAGE H: Initial Clustering &amp; Annotation                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  ----------------------------------------                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1. Preprocessing (layer selection, marker resolution)            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  2. Clustering (PCA -&gt; k-NN -&gt; Leiden)                            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  3. Differential Expression (Wilcoxon rank-sum)                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  4. Marker Scoring (enrichment + positive + DE - anti)            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  5. Hierarchical Assignment (top-down with gating)                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  6. Per-Cell Voting (evidence collection)                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                           |                                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                           v                                       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  STAGE I: Refinement                                              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  -------------------                                              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  - Diagnostic mode: identify clusters needing attention           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  - Subclustering: split heterogeneous clusters                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  - Relabeling: instant reassignment when clear signal exists      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  - Iterative: H -&gt; I -&gt; I -&gt; I until convergence                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                                                                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-h-initial-clustering-and-annotation">Stage H: Initial Clustering and Annotation<a href="#stage-h-initial-clustering-and-annotation" class="hash-link" aria-label="Direct link to Stage H: Initial Clustering and Annotation" title="Direct link to Stage H: Initial Clustering and Annotation">​</a></h3>
<p>Stage H performs the heavy lifting of clustering and initial annotation:</p>
<ol>
<li>
<p><strong>Preprocessing</strong>: Select the appropriate expression layer, resolve marker names against the panel, exclude technical markers (DAPI, housekeeping genes)</p>
</li>
<li>
<p><strong>Clustering</strong>: Standard single-cell workflow (scale, PCA, k-NN graph, Leiden community detection) with optional GPU acceleration</p>
</li>
<li>
<p><strong>Differential Expression</strong>: Wilcoxon rank-sum test identifies markers enriched in each cluster vs. all others, providing orthogonal evidence for annotation</p>
</li>
<li>
<p><strong>Marker Scoring</strong>: For each (cluster, cell type) pair, compute a composite score incorporating expression enrichment, positive fraction, DE bonus, and anti-marker penalty</p>
</li>
<li>
<p><strong>Hierarchical Assignment</strong>: Top-down traversal through the marker hierarchy, selecting the best-scoring child at each level until a leaf is reached or ambiguity is detected</p>
</li>
<li>
<p><strong>Per-Cell Voting</strong>: When siblings are too close, collect per-cell scores to record vote composition as evidence</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stage-i-refinement">Stage I: Refinement<a href="#stage-i-refinement" class="hash-link" aria-label="Direct link to Stage I: Refinement" title="Direct link to Stage I: Refinement">​</a></h3>
<p>Stage I addresses the clusters that Stage H could not confidently annotate:</p>
<ul>
<li><strong>Diagnostic Mode</strong>: Identify clusters with low confidence, ambiguous assignments, or unusual marker patterns</li>
<li><strong>Subclustering</strong>: Re-cluster ambiguous clusters at higher resolution to separate mixed populations</li>
<li><strong>Relabeling</strong>: When new evidence (from subclustering or marker map updates) provides clear signal, instantly reassign labels</li>
<li><strong>Iteration</strong>: The refinement loop can be repeated until annotation quality converges</li>
</ul>
<p>The iterative nature of this workflow acknowledges that perfect annotation rarely happens in one pass. Stage H provides a strong starting point; Stage I refines the difficult cases.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="algorithm-summary">Algorithm Summary<a href="#algorithm-summary" class="hash-link" aria-label="Direct link to Algorithm Summary" title="Direct link to Algorithm Summary">​</a></h2>
<p>The hierarchical assignment algorithm can be summarized in pseudocode:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">For each cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1. Evaluate all root cell types (Epithelium, Immune, etc.)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2. Select the best-scoring root that passes the root gate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    3. While current node has children:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a. Evaluate all children of current node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b. Filter to those passing the child gate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c. If no children pass: stop, assign current node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        d. If gap between top two children &lt; threshold: stop, flag ambiguous</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e. Otherwise: select best child, continue descent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    4. Record final assignment with confidence and stop reason</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The confidence score is the minimum margin along the entire path from root to final assignment. This captures the &quot;weakest link&quot; in the decision chain.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-makes-this-different">What Makes This Different<a href="#what-makes-this-different" class="hash-link" aria-label="Direct link to What Makes This Different" title="Direct link to What Makes This Different">​</a></h2>
<p>CellType-Refinery is not the first tool to attempt automated cell type annotation. What distinguishes this approach:</p>
<ol>
<li>
<p><strong>Hierarchy-aware</strong>: Most tools treat cell types as a flat list. CellType-Refinery respects the biological hierarchy.</p>
</li>
<li>
<p><strong>Interpretable</strong>: Every decision is logged and can be inspected. No black-box classifiers.</p>
</li>
<li>
<p><strong>Uncertainty-aware</strong>: Ambiguity is detected and flagged, not hidden.</p>
</li>
<li>
<p><strong>Iterative refinement</strong>: The two-stage workflow allows progressive improvement.</p>
</li>
<li>
<p><strong>Configurable</strong>: Gating thresholds, marker definitions, and anti-marker rules can all be customized per tissue and per cell type.</p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="see-also">See Also<a href="#see-also" class="hash-link" aria-label="Direct link to See Also" title="Direct link to See Also">​</a></h2>
<ul>
<li><a href="/CellType-Refinery/docs/methodology/annotation-pipeline">Annotation Pipeline</a> - Detailed pipeline flow with implementation notes</li>
<li><a href="/CellType-Refinery/docs/methodology/marker-scoring-algorithm">Marker Scoring Algorithm</a> - The scoring formula and its components</li>
<li><a href="/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm">Hierarchical Gating</a> - Assignment logic and gate checking</li>
<li><a href="/CellType-Refinery/docs/methodology/refinement-decision-logic">Refinement Decision Logic</a> - When to subcluster vs relabel</li>
<li><a href="/CellType-Refinery/docs/methodology/tuning-guide">Tuning Guide</a> - Parameter adjustment for different tissues and panels</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/kuang-da/CellType-Refinery/tree/main/celltype-refinery-docs/docs/methodology/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/CellType-Refinery/docs/getting-started/first-annotation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">First Annotation Tutorial</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/CellType-Refinery/docs/methodology/annotation-pipeline"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Annotation Pipeline</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-problem" class="table-of-contents__link toc-highlight">The Problem</a><ul><li><a href="#traditional-clustering-falls-short-at-scale" class="table-of-contents__link toc-highlight">Traditional Clustering Falls Short at Scale</a></li><li><a href="#marker-ambiguity-and-overlapping-cell-types" class="table-of-contents__link toc-highlight">Marker Ambiguity and Overlapping Cell Types</a></li></ul></li><li><a href="#key-insight-hierarchical-marker-based-gating" class="table-of-contents__link toc-highlight">Key Insight: Hierarchical Marker-Based Gating</a><ul><li><a href="#beyond-simple-clustering" class="table-of-contents__link toc-highlight">Beyond Simple Clustering</a></li></ul></li><li><a href="#design-principles" class="table-of-contents__link toc-highlight">Design Principles</a><ul><li><a href="#1-parents-as-gates" class="table-of-contents__link toc-highlight">1. Parents as Gates</a></li><li><a href="#2-siblings-only-competition" class="table-of-contents__link toc-highlight">2. Siblings-Only Competition</a></li><li><a href="#3-traceable-decisions" class="table-of-contents__link toc-highlight">3. Traceable Decisions</a></li><li><a href="#4-ambiguity-detection" class="table-of-contents__link toc-highlight">4. Ambiguity Detection</a></li><li><a href="#5-evidence-vs-override" class="table-of-contents__link toc-highlight">5. Evidence vs Override</a></li></ul></li><li><a href="#pipeline-overview" class="table-of-contents__link toc-highlight">Pipeline Overview</a><ul><li><a href="#stage-h-initial-clustering-and-annotation" class="table-of-contents__link toc-highlight">Stage H: Initial Clustering and Annotation</a></li><li><a href="#stage-i-refinement" class="table-of-contents__link toc-highlight">Stage I: Refinement</a></li></ul></li><li><a href="#algorithm-summary" class="table-of-contents__link toc-highlight">Algorithm Summary</a></li><li><a href="#what-makes-this-different" class="table-of-contents__link toc-highlight">What Makes This Different</a></li><li><a href="#see-also" class="table-of-contents__link toc-highlight">See Also</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/CellType-Refinery/docs/getting-started/installation">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/CellType-Refinery/docs/core-workflows/workflow-overview">Core Workflows</a></li><li class="footer__item"><a class="footer__link-item" href="/CellType-Refinery/docs/cli/overview">CLI Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/kuang-da/CellType-Refinery" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/kuang-da/CellType-Refinery/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2026 Penn Biomedical Image Analysis Lab. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>