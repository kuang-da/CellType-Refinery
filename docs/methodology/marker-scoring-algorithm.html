<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-methodology/marker-scoring-algorithm" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Marker Scoring Algorithm | CellType-Refinery</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kuang-da.github.io/CellType-Refinery/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://kuang-da.github.io/CellType-Refinery/img/social-card.png"><meta data-rh="true" property="og:url" content="https://kuang-da.github.io/CellType-Refinery/docs/methodology/marker-scoring-algorithm"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Marker Scoring Algorithm | CellType-Refinery"><meta data-rh="true" name="description" content="This page explains scoring details. For conceptual background, see Methodology Overview first."><meta data-rh="true" property="og:description" content="This page explains scoring details. For conceptual background, see Methodology Overview first."><link data-rh="true" rel="icon" href="/CellType-Refinery/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kuang-da.github.io/CellType-Refinery/docs/methodology/marker-scoring-algorithm"><link data-rh="true" rel="alternate" href="https://kuang-da.github.io/CellType-Refinery/docs/methodology/marker-scoring-algorithm" hreflang="en"><link data-rh="true" rel="alternate" href="https://kuang-da.github.io/CellType-Refinery/docs/methodology/marker-scoring-algorithm" hreflang="x-default"><link rel="stylesheet" href="/CellType-Refinery/assets/css/styles.be0b7b16.css">
<script src="/CellType-Refinery/assets/js/runtime~main.adcd1756.js" defer="defer"></script>
<script src="/CellType-Refinery/assets/js/main.396c890a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/CellType-Refinery/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/CellType-Refinery/"><div class="navbar__logo"><img src="/CellType-Refinery/img/logo.svg" alt="CellType-Refinery Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/CellType-Refinery/img/logo.svg" alt="CellType-Refinery Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">CellType-Refinery</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/CellType-Refinery/docs">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/kuang-da/CellType-Refinery" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/CellType-Refinery/docs">CellType-Refinery</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/getting-started/installation">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/CellType-Refinery/docs/methodology">Methodology</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology">Cell Type Annotation Methodology</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/annotation-pipeline">Annotation Pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/CellType-Refinery/docs/methodology/marker-scoring-algorithm">Marker Scoring Algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm">Hierarchical Gating Algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/refinement-decision-logic">Refinement Decision Logic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/CellType-Refinery/docs/methodology/tuning-guide">Tuning Guide</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/core-workflows/workflow-overview">Core Workflows</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/modules/preprocessing/overview">Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/cli/overview">CLI Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/configuration/marker-maps">Configuration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/reference/glossary">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/CellType-Refinery/docs/examples/fallopian-tube">Examples</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/CellType-Refinery/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Methodology</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Marker Scoring Algorithm</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Marker Scoring Algorithm</h1></header>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Prerequisites</div><div class="admonitionContent_BuS1"><p>This page explains scoring details. For conceptual background, see <a href="/CellType-Refinery/docs/methodology">Methodology Overview</a> first.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>The CellType-Refinery scoring algorithm evaluates how well each cluster matches each candidate cell type in the marker map. The algorithm produces a single numeric score for each (cluster, cell_type) pair, enabling systematic ranking and selection of the best-fitting annotation.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-core-formula">The Core Formula<a href="#the-core-formula" class="hash-link" aria-label="Direct link to The Core Formula" title="Direct link to The Core Formula">​</a></h3>
<p>The scoring formula for each (cluster, cell_type) pair:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">score = mean_enrichment + mean_positive + de_component - anti_penalty</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Each component captures a different biological signal:</p>
<table><thead><tr><th>Component</th><th>Range</th><th>What It Measures</th></tr></thead><tbody><tr><td><code>mean_enrichment</code></td><td>Unbounded (typically -2 to +4)</td><td>How much higher is expression vs. global average?</td></tr><tr><td><code>mean_positive</code></td><td>0 to 1</td><td>What fraction of cells clearly express markers?</td></tr><tr><td><code>de_component</code></td><td>0 to ~0.6</td><td>Are markers differentially expressed in this cluster?</td></tr><tr><td><code>anti_penalty</code></td><td>0 to unbounded</td><td>Is conflicting marker expression present?</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="score-interpretation">Score Interpretation<a href="#score-interpretation" class="hash-link" aria-label="Direct link to Score Interpretation" title="Direct link to Score Interpretation">​</a></h3>
<ul>
<li><strong>Typical winning scores</strong>: 1.5 to 4.0 for well-matched cell types</li>
<li><strong>Marginal matches</strong>: 0.5 to 1.5, may indicate subtypes or transitional states</li>
<li><strong>Poor matches</strong>: &lt; 0.5, usually indicates wrong cell type assignment</li>
<li><strong>Negative scores</strong>: Strong evidence against the cell type</li>
</ul>
<p>The following sections explain each component in detail with worked examples.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="component-1-mean-enrichment">Component 1: Mean Enrichment<a href="#component-1-mean-enrichment" class="hash-link" aria-label="Direct link to Component 1: Mean Enrichment" title="Direct link to Component 1: Mean Enrichment">​</a></h2>
<p>The mean enrichment component measures whether marker genes are expressed at higher levels in the cluster compared to the global population. This is the foundation of marker-based annotation.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="calculation">Calculation<a href="#calculation" class="hash-link" aria-label="Direct link to Calculation" title="Direct link to Calculation">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">For each marker m in cell_type:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enrichment[m] = (cluster_median[m] - global_median[m]) / global_std[m]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_enrichment = average(enrichment[all markers])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-breakdown">Step-by-Step Breakdown<a href="#step-by-step-breakdown" class="hash-link" aria-label="Direct link to Step-by-Step Breakdown" title="Direct link to Step-by-Step Breakdown">​</a></h3>
<ol>
<li><strong>Calculate cluster median</strong>: For marker gene <code>m</code>, compute the median expression value across all cells in the cluster</li>
<li><strong>Calculate global median</strong>: Compute the median expression across ALL cells in the dataset</li>
<li><strong>Calculate global standard deviation</strong>: Compute std across all cells (measures natural variation)</li>
<li><strong>Compute Z-score</strong>: Standardize the difference using the global std</li>
<li><strong>Average across markers</strong>: Take the mean of all marker Z-scores</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-z-scores">Why Z-Scores?<a href="#why-z-scores" class="hash-link" aria-label="Direct link to Why Z-Scores?" title="Direct link to Why Z-Scores?">​</a></h3>
<p>Z-score normalization is essential because:</p>
<ul>
<li><strong>Different genes have different scales</strong>: CD45 might range 0-10 while CD3 ranges 0-50</li>
<li><strong>Comparability</strong>: Z-scores put all markers on the same scale</li>
<li><strong>Statistical interpretation</strong>: A Z-score of 2 means &quot;2 standard deviations above average&quot;</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="interpretation-guide">Interpretation Guide<a href="#interpretation-guide" class="hash-link" aria-label="Direct link to Interpretation Guide" title="Direct link to Interpretation Guide">​</a></h3>
<table><thead><tr><th>Z-Score Range</th><th>Interpretation</th><th>Typical Scenario</th></tr></thead><tbody><tr><td>&gt; 2.0</td><td>Strong enrichment</td><td>Clear positive marker</td></tr><tr><td>1.0 to 2.0</td><td>Moderate enrichment</td><td>Typical marker expression</td></tr><tr><td>0 to 1.0</td><td>Weak enrichment</td><td>Subpopulation or dim expression</td></tr><tr><td>-1.0 to 0</td><td>No enrichment</td><td>Marker not characteristic</td></tr><tr><td>&lt; -1.0</td><td>Depletion</td><td>Wrong cell type</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="worked-example">Worked Example<a href="#worked-example" class="hash-link" aria-label="Direct link to Worked Example" title="Direct link to Worked Example">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cell type: T Cells</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Markers: [CD3, CD4, CD8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster 3 statistics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD3: cluster_median=4.2, global_median=1.8, global_std=1.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD4: cluster_median=3.1, global_median=1.2, global_std=1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD8: cluster_median=0.8, global_median=0.9, global_std=0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enrichment calculations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD3: (4.2 - 1.8) / 1.5 = 1.60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD4: (3.1 - 1.2) / 1.0 = 1.90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD8: (0.8 - 0.9) / 0.8 = -0.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_enrichment = (1.60 + 1.90 + (-0.13)) / 3 = 1.12</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This cluster shows strong enrichment for CD3 and CD4, but not CD8, suggesting CD4+ T cells rather than CD8+ T cells.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="edge-cases-and-handling">Edge Cases and Handling<a href="#edge-cases-and-handling" class="hash-link" aria-label="Direct link to Edge Cases and Handling" title="Direct link to Edge Cases and Handling">​</a></h3>
<ul>
<li><strong>Zero variance markers</strong>: If <code>global_std = 0</code>, the marker is constant and skipped</li>
<li><strong>Missing markers</strong>: Markers not in the expression matrix are excluded from calculation</li>
<li><strong>Sparse data</strong>: Median is robust to zeros from dropout in single-cell data</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="component-2-mean-positive-fraction">Component 2: Mean Positive Fraction<a href="#component-2-mean-positive-fraction" class="hash-link" aria-label="Direct link to Component 2: Mean Positive Fraction" title="Direct link to Component 2: Mean Positive Fraction">​</a></h2>
<p>While mean enrichment measures <em>how much</em> higher expression is, mean positive fraction measures <em>how many</em> cells in the cluster clearly express the markers. This captures the consistency of marker expression.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="calculation-1">Calculation<a href="#calculation-1" class="hash-link" aria-label="Direct link to Calculation" title="Direct link to Calculation">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">For each marker m in cell_type:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threshold[m] = global_quantile[m, 0.75]  # Q75 by default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    positive[m] = fraction of cells in cluster where expr &gt;= threshold[m]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_positive = average(positive[all markers])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-breakdown-1">Step-by-Step Breakdown<a href="#step-by-step-breakdown-1" class="hash-link" aria-label="Direct link to Step-by-Step Breakdown" title="Direct link to Step-by-Step Breakdown">​</a></h3>
<ol>
<li><strong>Determine threshold</strong>: Calculate the 75th percentile of expression across ALL cells</li>
<li><strong>Count positive cells</strong>: For each cell in the cluster, check if expression &gt;= threshold</li>
<li><strong>Calculate fraction</strong>: Divide positive count by total cells in cluster</li>
<li><strong>Average across markers</strong>: Mean of all marker positive fractions</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-q75-75th-percentile">Why Q75 (75th Percentile)?<a href="#why-q75-75th-percentile" class="hash-link" aria-label="Direct link to Why Q75 (75th Percentile)?" title="Direct link to Why Q75 (75th Percentile)?">​</a></h3>
<p>The 75th percentile threshold is chosen because:</p>
<ul>
<li><strong>Noise filtering</strong>: Single-cell data has substantial technical noise and dropout</li>
<li><strong>Clear signal</strong>: Q75 identifies cells with unambiguous expression</li>
<li><strong>Conservative</strong>: Avoids false positives from background noise</li>
<li><strong>Biologically meaningful</strong>: Captures the &quot;clearly positive&quot; population</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tuning-the-threshold">Tuning the Threshold<a href="#tuning-the-threshold" class="hash-link" aria-label="Direct link to Tuning the Threshold" title="Direct link to Tuning the Threshold">​</a></h3>
<p>The <code>positive_quantile</code> parameter allows adjustment:</p>
<table><thead><tr><th>Setting</th><th>Use Case</th><th>Effect</th></tr></thead><tbody><tr><td>0.90</td><td>Very stringent</td><td>Only the brightest cells count as positive</td></tr><tr><td>0.75</td><td>Default</td><td>Balanced, works for most datasets</td></tr><tr><td>0.50</td><td>Sparse data</td><td>More sensitive, useful for low-expression markers</td></tr><tr><td>0.25</td><td>Very sparse</td><td>Very sensitive, may include noise</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="worked-example-1">Worked Example<a href="#worked-example-1" class="hash-link" aria-label="Direct link to Worked Example" title="Direct link to Worked Example">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cell type: B Cells</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Markers: [CD19, CD20, CD79a]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Global Q75 thresholds:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD19: Q75 = 2.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD20: Q75 = 1.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD79a: Q75 = 3.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster 7 (100 cells):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD19: 85 cells &gt;= 2.5 → positive = 0.85</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD20: 78 cells &gt;= 1.8 → positive = 0.78</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD79a: 72 cells &gt;= 3.0 → positive = 0.72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_positive = (0.85 + 0.78 + 0.72) / 3 = 0.78</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A mean positive fraction of 0.78 indicates strong, consistent marker expression.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="interpreting-mean-positive">Interpreting Mean Positive<a href="#interpreting-mean-positive" class="hash-link" aria-label="Direct link to Interpreting Mean Positive" title="Direct link to Interpreting Mean Positive">​</a></h3>
<table><thead><tr><th>Range</th><th>Interpretation</th><th>Typical Scenario</th></tr></thead><tbody><tr><td>&gt; 0.8</td><td>Excellent</td><td>Clear cell type, homogeneous cluster</td></tr><tr><td>0.6 - 0.8</td><td>Good</td><td>Typical positive cluster</td></tr><tr><td>0.4 - 0.6</td><td>Moderate</td><td>Mixed population or dim expression</td></tr><tr><td>0.2 - 0.4</td><td>Weak</td><td>Subpopulation or wrong cell type</td></tr><tr><td>&lt; 0.2</td><td>Poor</td><td>Likely wrong cell type</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="component-3-de-component-rank-weighted">Component 3: DE Component (Rank-Weighted)<a href="#component-3-de-component-rank-weighted" class="hash-link" aria-label="Direct link to Component 3: DE Component (Rank-Weighted)" title="Direct link to Component 3: DE Component (Rank-Weighted)">​</a></h2>
<p>The differential expression (DE) component rewards cell types whose markers appear in the cluster&#x27;s top differentially expressed genes. This leverages unsupervised DE analysis to validate marker-based annotations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="conceptual-overview">Conceptual Overview<a href="#conceptual-overview" class="hash-link" aria-label="Direct link to Conceptual Overview" title="Direct link to Conceptual Overview">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  DE BONUS CALCULATION                                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  For each marker m in cell_type&#x27;s resolved markers:                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    IF m is in cluster&#x27;s top-K DE genes (upregulated):                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      rank = de_rank_lookup[cluster][m]  # 1-indexed                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      rank_weight = (K - rank + 1) / K   # Higher rank → higher weight   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      commonness = doc_freq[m] / n_cell_types                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      commonness_penalty = commonness ^ de_commonness_alpha              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      marker_bonus = rank_weight × (1 - commonness_penalty)              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ELSE:                                                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      marker_bonus = 0                                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  de_component = de_bonus × mean(marker_bonus for all markers)           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-breakdown-2">Step-by-Step Breakdown<a href="#step-by-step-breakdown-2" class="hash-link" aria-label="Direct link to Step-by-Step Breakdown" title="Direct link to Step-by-Step Breakdown">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-determine-k-number-of-top-de-genes">Step 1: Determine K (Number of Top DE Genes)<a href="#step-1-determine-k-number-of-top-de-genes" class="hash-link" aria-label="Direct link to Step 1: Determine K (Number of Top DE Genes)" title="Direct link to Step 1: Determine K (Number of Top DE Genes)">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">K = clip(n_markers × de_top_frac, de_min_k, de_max_k)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Where:</p>
<ul>
<li><code>n_markers</code> = total unique markers in the panel</li>
<li><code>de_top_frac</code> = fraction of panel to consider (default 0.2)</li>
<li><code>de_min_k</code> = minimum K value (default 3)</li>
<li><code>de_max_k</code> = maximum K value (default 12)</li>
</ul>
<p>Example: Panel with 40 markers → K = clip(40 × 0.2, 3, 12) = clip(8, 3, 12) = 8</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-check-de-membership">Step 2: Check DE Membership<a href="#step-2-check-de-membership" class="hash-link" aria-label="Direct link to Step 2: Check DE Membership" title="Direct link to Step 2: Check DE Membership">​</a></h4>
<p>For each marker in the cell type, check if it appears in the cluster&#x27;s top-K upregulated genes.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-calculate-rank-weight">Step 3: Calculate Rank Weight<a href="#step-3-calculate-rank-weight" class="hash-link" aria-label="Direct link to Step 3: Calculate Rank Weight" title="Direct link to Step 3: Calculate Rank Weight">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rank_weight = (K - rank + 1) / K</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This creates a linear decay from 1.0 (rank 1) to 1/K (rank K):</p>
<table><thead><tr><th>Rank</th><th>K=8 Weight</th><th>K=12 Weight</th></tr></thead><tbody><tr><td>1</td><td>1.000</td><td>1.000</td></tr><tr><td>2</td><td>0.875</td><td>0.917</td></tr><tr><td>3</td><td>0.750</td><td>0.833</td></tr><tr><td>4</td><td>0.625</td><td>0.750</td></tr><tr><td>5</td><td>0.500</td><td>0.667</td></tr><tr><td>6</td><td>0.375</td><td>0.583</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-calculate-commonness-penalty">Step 4: Calculate Commonness Penalty<a href="#step-4-calculate-commonness-penalty" class="hash-link" aria-label="Direct link to Step 4: Calculate Commonness Penalty" title="Direct link to Step 4: Calculate Commonness Penalty">​</a></h4>
<p>Markers that appear in many cell type definitions are less informative:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">commonness = doc_freq[m] / n_cell_types</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">commonness_penalty = commonness ^ de_commonness_alpha</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">effective_weight = 1 - commonness_penalty</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Example with <code>de_commonness_alpha = 0.5</code>:</p>
<table><thead><tr><th>Marker Usage</th><th>Commonness</th><th>Penalty</th><th>Effective Weight</th></tr></thead><tbody><tr><td>Unique (1/20)</td><td>0.05</td><td>0.22</td><td>0.78</td></tr><tr><td>Moderate (5/20)</td><td>0.25</td><td>0.50</td><td>0.50</td></tr><tr><td>Common (10/20)</td><td>0.50</td><td>0.71</td><td>0.29</td></tr><tr><td>Ubiquitous (20/20)</td><td>1.00</td><td>1.00</td><td>0.00</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-combine-and-average">Step 5: Combine and Average<a href="#step-5-combine-and-average" class="hash-link" aria-label="Direct link to Step 5: Combine and Average" title="Direct link to Step 5: Combine and Average">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">marker_bonus = rank_weight × (1 - commonness_penalty)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">de_component = de_bonus × mean(marker_bonus for all markers)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="worked-example-2">Worked Example<a href="#worked-example-2" class="hash-link" aria-label="Direct link to Worked Example" title="Direct link to Worked Example">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cell type: Immune Cells</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Markers: [CD45, CD3, CD19]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster 5 top-K DE: [CD45 (rank 1), VWF (rank 2), CD3 (rank 4), ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">K = 8, de_bonus = 0.6, de_commonness_alpha = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Document frequencies (20 cell types total):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD45: appears in 2 cell types → commonness = 0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD3: appears in 4 cell types → commonness = 0.20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD19: appears in 2 cell types → commonness = 0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Calculations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD45: rank=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rank_weight = (8-1+1)/8 = 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        commonness_penalty = 0.10^0.5 = 0.316</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bonus = 1.0 × (1 - 0.316) = 0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD3:  rank=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rank_weight = (8-4+1)/8 = 0.625</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        commonness_penalty = 0.20^0.5 = 0.447</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bonus = 0.625 × (1 - 0.447) = 0.34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD19: not in top-K</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bonus = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">de_component = 0.6 × mean([0.68, 0.34, 0]) = 0.6 × 0.34 = 0.20</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-rank-weighting">Why Rank Weighting?<a href="#why-rank-weighting" class="hash-link" aria-label="Direct link to Why Rank Weighting?" title="Direct link to Why Rank Weighting?">​</a></h3>
<p>Rank weighting captures the intuition that:</p>
<ol>
<li><strong>Top-ranked DE genes are most distinctive</strong> for the cluster</li>
<li><strong>Lower-ranked genes add some evidence</strong> but are less specific</li>
<li><strong>Non-DE genes contribute nothing</strong> (they don&#x27;t distinguish the cluster)</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-commonness-penalty">Why Commonness Penalty?<a href="#why-commonness-penalty" class="hash-link" aria-label="Direct link to Why Commonness Penalty?" title="Direct link to Why Commonness Penalty?">​</a></h3>
<p>The commonness penalty prevents ubiquitous markers from dominating:</p>
<ul>
<li>CD45 (pan-immune) shouldn&#x27;t boost all immune types equally</li>
<li>Cell-type-specific markers (e.g., CD19 for B cells) should matter more</li>
<li>Prevents &quot;generic&quot; markers from creating false matches</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="component-4-anti-marker-penalty">Component 4: Anti-Marker Penalty<a href="#component-4-anti-marker-penalty" class="hash-link" aria-label="Direct link to Component 4: Anti-Marker Penalty" title="Direct link to Component 4: Anti-Marker Penalty">​</a></h2>
<p>Anti-markers define genes that should NOT be expressed in a cell type. The anti-marker penalty reduces scores when conflicting markers are detected, preventing misannotation.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="conceptual-overview-1">Conceptual Overview<a href="#conceptual-overview-1" class="hash-link" aria-label="Direct link to Conceptual Overview" title="Direct link to Conceptual Overview">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ANTI-MARKER PENALTY CALCULATION                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  For each anti-marker a in cell_type.anti_markers:                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    anti_enrichment[a] = (cluster_median[a] - global_median[a]) / std[a] │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    anti_enrichment[a] = max(anti_enrichment[a], 0)  # Clip negative     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    anti_positive[a] = fraction of cells &gt;= Q75 threshold                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Aggregation modes (--anti-agg):                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────┬─────────────────────────────────────────────────┐  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ &quot;max&quot;           │ Strictest: max(anti-markers)                    │  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─────────────────┼─────────────────────────────────────────────────┤  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ &quot;top2mean&quot;      │ DEFAULT: mean of top 2 anti-markers             │  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─────────────────┼─────────────────────────────────────────────────┤  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ &quot;mean&quot;          │ Lenient: mean of all anti-markers               │  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────┴─────────────────────────────────────────────────┘  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  anti_penalty = anti_weight × (agg_enrichment + agg_positive)           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  HARD GATE: If anti_penalty &gt; 1.0, the cell type is REJECTED            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-breakdown-3">Step-by-Step Breakdown<a href="#step-by-step-breakdown-3" class="hash-link" aria-label="Direct link to Step-by-Step Breakdown" title="Direct link to Step-by-Step Breakdown">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-calculate-anti-enrichment">Step 1: Calculate Anti-Enrichment<a href="#step-1-calculate-anti-enrichment" class="hash-link" aria-label="Direct link to Step 1: Calculate Anti-Enrichment" title="Direct link to Step 1: Calculate Anti-Enrichment">​</a></h4>
<p>For each anti-marker, compute a Z-score similar to mean enrichment:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">anti_enrichment[a] = (cluster_median[a] - global_median[a]) / global_std[a]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">anti_enrichment[a] = max(anti_enrichment[a], 0)  # Only positive values penalize</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The clipping to zero is important: we only penalize when anti-markers are <em>enriched</em>, not when they&#x27;re absent (which is expected).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-calculate-anti-positive-fraction">Step 2: Calculate Anti-Positive Fraction<a href="#step-2-calculate-anti-positive-fraction" class="hash-link" aria-label="Direct link to Step 2: Calculate Anti-Positive Fraction" title="Direct link to Step 2: Calculate Anti-Positive Fraction">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">anti_positive[a] = fraction of cells in cluster where expr &gt;= Q75 threshold</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This measures how many cells express the anti-marker.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-aggregate-across-anti-markers">Step 3: Aggregate Across Anti-Markers<a href="#step-3-aggregate-across-anti-markers" class="hash-link" aria-label="Direct link to Step 3: Aggregate Across Anti-Markers" title="Direct link to Step 3: Aggregate Across Anti-Markers">​</a></h4>
<p>The aggregation method determines how multiple anti-markers combine:</p>
<table><thead><tr><th>Method</th><th>Formula</th><th>Use Case</th></tr></thead><tbody><tr><td><code>max</code></td><td><code>max(anti_enrichment), max(anti_positive)</code></td><td>Strict: any conflict rejects</td></tr><tr><td><code>top2mean</code></td><td>Mean of top 2 values</td><td>Balanced: robust to single outliers</td></tr><tr><td><code>mean</code></td><td>Mean of all values</td><td>Lenient: only strong conflicts penalize</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-compute-final-penalty">Step 4: Compute Final Penalty<a href="#step-4-compute-final-penalty" class="hash-link" aria-label="Direct link to Step 4: Compute Final Penalty" title="Direct link to Step 4: Compute Final Penalty">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">anti_penalty = anti_weight × (agg_enrichment + agg_positive)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hard-gate-behavior">Hard Gate Behavior<a href="#hard-gate-behavior" class="hash-link" aria-label="Direct link to Hard Gate Behavior" title="Direct link to Hard Gate Behavior">​</a></h3>
<p>When <code>anti_penalty &gt; 1.0</code>, the cell type is completely rejected:</p>
<ul>
<li>The score is set to a large negative value (e.g., -999)</li>
<li>This cell type cannot be selected regardless of other scores</li>
<li>Prevents obvious biological conflicts</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-scenarios">Example Scenarios<a href="#example-scenarios" class="hash-link" aria-label="Direct link to Example Scenarios" title="Direct link to Example Scenarios">​</a></h3>
<table><thead><tr><th>Scenario</th><th>Anti-Enrichment</th><th>Anti-Positive</th><th>Penalty (w=0.5)</th><th>Result</th></tr></thead><tbody><tr><td>Clean</td><td>0.0</td><td>0.05</td><td>0.025</td><td>Minor</td></tr><tr><td>Mild conflict</td><td>0.5</td><td>0.15</td><td>0.325</td><td>Moderate</td></tr><tr><td>Moderate conflict</td><td>1.2</td><td>0.35</td><td>0.775</td><td>Significant</td></tr><tr><td>Strong conflict</td><td>2.5</td><td>0.65</td><td>1.575</td><td><strong>REJECTED</strong></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="worked-example-3">Worked Example<a href="#worked-example-3" class="hash-link" aria-label="Direct link to Worked Example" title="Direct link to Worked Example">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cell type: CD4+ T Cells</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Anti-markers: [CD8, CD19, CD14]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster 8 statistics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD8:  cluster_median=2.1, global_median=0.8, global_std=0.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enrichment = (2.1-0.8)/0.9 = 1.44, positive = 0.25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD19: cluster_median=0.2, global_median=0.5, global_std=0.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enrichment = max((0.2-0.5)/0.6, 0) = 0, positive = 0.02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD14: cluster_median=0.1, global_median=0.3, global_std=0.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enrichment = max((0.1-0.3)/0.4, 0) = 0, positive = 0.01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using top2mean aggregation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Top 2 enrichments: [1.44, 0] → mean = 0.72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Top 2 positives: [0.25, 0.02] → mean = 0.135</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">anti_penalty = 0.5 × (0.72 + 0.135) = 0.43</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This penalty of 0.43 significantly reduces the score, flagging potential CD8 contamination.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="choosing-anti-aggregation-mode">Choosing Anti-Aggregation Mode<a href="#choosing-anti-aggregation-mode" class="hash-link" aria-label="Direct link to Choosing Anti-Aggregation Mode" title="Direct link to Choosing Anti-Aggregation Mode">​</a></h3>
<table><thead><tr><th>Mode</th><th>Best For</th><th>Behavior</th></tr></thead><tbody><tr><td><code>max</code></td><td>Well-defined types with clear exclusions</td><td>Single strong conflict rejects</td></tr><tr><td><code>top2mean</code></td><td>Most datasets (default)</td><td>Robust to noise, catches real conflicts</td></tr><tr><td><code>mean</code></td><td>Complex panels, many anti-markers</td><td>Only consistent conflicts penalize</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="putting-it-all-together">Putting It All Together<a href="#putting-it-all-together" class="hash-link" aria-label="Direct link to Putting It All Together" title="Direct link to Putting It All Together">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="complete-scoring-example">Complete Scoring Example<a href="#complete-scoring-example" class="hash-link" aria-label="Direct link to Complete Scoring Example" title="Direct link to Complete Scoring Example">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cell type: NK Cells</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Markers: [CD56, CD16, NKG2D]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Anti-markers: [CD3, CD19]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster 12 (150 cells)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 1: Mean Enrichment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD56: Z = 2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD16: Z = 1.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NKG2D: Z = 1.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mean_enrichment = 1.80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2: Mean Positive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD56: 0.82</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD16: 0.75</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NKG2D: 0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mean_positive = 0.75</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 3: DE Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD56: rank 2, bonus = 0.52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD16: rank 5, bonus = 0.28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NKG2D: not in top-K, bonus = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  de_component = 0.6 × 0.27 = 0.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 4: Anti-Penalty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD3: enrichment = 0.3, positive = 0.08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CD19: enrichment = 0, positive = 0.01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  anti_penalty = 0.5 × (0.15 + 0.045) = 0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final Score:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  score = 1.80 + 0.75 + 0.16 - 0.10 = 2.61</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A score of 2.61 indicates a strong NK cell match.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="parameter-reference">Parameter Reference<a href="#parameter-reference" class="hash-link" aria-label="Direct link to Parameter Reference" title="Direct link to Parameter Reference">​</a></h2>
<p>The following parameters control scoring behavior. They can be set via command-line arguments or configuration files.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive-fraction-parameters">Positive Fraction Parameters<a href="#positive-fraction-parameters" class="hash-link" aria-label="Direct link to Positive Fraction Parameters" title="Direct link to Positive Fraction Parameters">​</a></h3>
<table><thead><tr><th>Parameter</th><th>Default</th><th>Effect</th><th>When to Adjust</th></tr></thead><tbody><tr><td><code>positive_quantile</code></td><td>0.75</td><td>Threshold for &quot;positive&quot; cells</td><td>Sparse data → lower to 0.5-0.6</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="de-component-parameters">DE Component Parameters<a href="#de-component-parameters" class="hash-link" aria-label="Direct link to DE Component Parameters" title="Direct link to DE Component Parameters">​</a></h3>
<table><thead><tr><th>Parameter</th><th>Default</th><th>Effect</th><th>When to Adjust</th></tr></thead><tbody><tr><td><code>de_bonus</code></td><td>0.5-0.6</td><td>Weight of DE component</td><td>Good DE results → increase to 0.7</td></tr><tr><td><code>de_top_frac</code></td><td>0.2</td><td>Fraction of panel for K</td><td>Large panel (&gt;50) → decrease to 0.15</td></tr><tr><td><code>de_min_k</code></td><td>3</td><td>Minimum top-K</td><td>Small panels → keep at 3</td></tr><tr><td><code>de_max_k</code></td><td>12</td><td>Maximum top-K</td><td>Large panels (&gt;60) → increase to 15</td></tr><tr><td><code>de_commonness_alpha</code></td><td>0.5</td><td>Commonness penalty strength</td><td>Many shared markers → increase to 0.7</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="anti-marker-parameters">Anti-Marker Parameters<a href="#anti-marker-parameters" class="hash-link" aria-label="Direct link to Anti-Marker Parameters" title="Direct link to Anti-Marker Parameters">​</a></h3>
<table><thead><tr><th>Parameter</th><th>Default</th><th>Effect</th><th>When to Adjust</th></tr></thead><tbody><tr><td><code>anti_weight</code></td><td>0.5-0.8</td><td>Penalty strength</td><td>Wrong assignments → increase to 0.8-1.0</td></tr><tr><td><code>anti_agg</code></td><td>top2mean</td><td>Aggregation method</td><td>Strict → use max; lenient → use mean</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="parameter-interaction-guidelines">Parameter Interaction Guidelines<a href="#parameter-interaction-guidelines" class="hash-link" aria-label="Direct link to Parameter Interaction Guidelines" title="Direct link to Parameter Interaction Guidelines">​</a></h3>
<ol>
<li><strong>Sparse data</strong>: Lower <code>positive_quantile</code>, may need higher <code>de_bonus</code></li>
<li><strong>Dense data</strong>: Default parameters usually work well</li>
<li><strong>Many similar cell types</strong>: Increase <code>anti_weight</code>, consider <code>max</code> aggregation</li>
<li><strong>Large marker panel</strong>: Decrease <code>de_top_frac</code>, increase <code>de_max_k</code></li>
<li><strong>Poor DE results</strong>: Decrease <code>de_bonus</code>, rely more on expression</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-scores">Debugging Scores<a href="#debugging-scores" class="hash-link" aria-label="Direct link to Debugging Scores" title="Direct link to Debugging Scores">​</a></h2>
<p>When scores seem incorrect, check these common issues:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="low-scores-for-expected-cell-types">Low Scores for Expected Cell Types<a href="#low-scores-for-expected-cell-types" class="hash-link" aria-label="Direct link to Low Scores for Expected Cell Types" title="Direct link to Low Scores for Expected Cell Types">​</a></h3>
<ol>
<li><strong>Check marker expression</strong>: Are markers actually expressed in the cluster?</li>
<li><strong>Verify DE results</strong>: Are markers appearing in DE gene lists?</li>
<li><strong>Inspect anti-markers</strong>: Is an anti-marker unexpectedly enriched?</li>
<li><strong>Review thresholds</strong>: Is <code>positive_quantile</code> too stringent?</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multiple-high-scoring-cell-types">Multiple High-Scoring Cell Types<a href="#multiple-high-scoring-cell-types" class="hash-link" aria-label="Direct link to Multiple High-Scoring Cell Types" title="Direct link to Multiple High-Scoring Cell Types">​</a></h3>
<ol>
<li><strong>Check for subtypes</strong>: Parent and child types may both score well</li>
<li><strong>Review anti-markers</strong>: Add more discriminating anti-markers</li>
<li><strong>Inspect markers</strong>: Are marker sets too overlapping?</li>
<li><strong>Consider DE bonus</strong>: Increase to differentiate similar types</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unexpected-rejections-hard-gate">Unexpected Rejections (Hard Gate)<a href="#unexpected-rejections-hard-gate" class="hash-link" aria-label="Direct link to Unexpected Rejections (Hard Gate)" title="Direct link to Unexpected Rejections (Hard Gate)">​</a></h3>
<ol>
<li><strong>Verify anti-marker enrichment</strong>: Is rejection justified?</li>
<li><strong>Check for batch effects</strong>: Technical artifacts can cause false conflicts</li>
<li><strong>Review aggregation mode</strong>: Switch from <code>max</code> to <code>top2mean</code></li>
<li><strong>Adjust anti_weight</strong>: Lower if rejections seem too aggressive</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mathematical-properties">Mathematical Properties<a href="#mathematical-properties" class="hash-link" aria-label="Direct link to Mathematical Properties" title="Direct link to Mathematical Properties">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="score-range">Score Range<a href="#score-range" class="hash-link" aria-label="Direct link to Score Range" title="Direct link to Score Range">​</a></h3>
<ul>
<li><strong>Theoretical minimum</strong>: Unbounded negative (due to enrichment Z-scores)</li>
<li><strong>Practical minimum</strong>: -2 to 0 for poor matches</li>
<li><strong>Theoretical maximum</strong>: Unbounded positive</li>
<li><strong>Practical maximum</strong>: 3 to 5 for excellent matches</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="component-independence">Component Independence<a href="#component-independence" class="hash-link" aria-label="Direct link to Component Independence" title="Direct link to Component Independence">​</a></h3>
<p>The four components are largely independent:</p>
<ul>
<li>A cluster can have high enrichment but low positive fraction (bimodal expression)</li>
<li>DE bonus can be high even with moderate enrichment (distinct markers)</li>
<li>Anti-penalty applies regardless of positive component values</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="normalization-considerations">Normalization Considerations<a href="#normalization-considerations" class="hash-link" aria-label="Direct link to Normalization Considerations" title="Direct link to Normalization Considerations">​</a></h3>
<p>The algorithm does NOT normalize scores across cell types. This is intentional:</p>
<ul>
<li>Absolute scores indicate match quality</li>
<li>Enables setting quality thresholds (e.g., &quot;minimum score of 1.0&quot;)</li>
<li>Allows comparison across different runs</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="see-also">See Also<a href="#see-also" class="hash-link" aria-label="Direct link to See Also" title="Direct link to See Also">​</a></h2>
<ul>
<li><a href="/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm">Hierarchical Gating Algorithm</a> - How scores determine labels at each hierarchy level</li>
<li><a href="/CellType-Refinery/docs/methodology/tuning-guide">Tuning Guide</a> - Practical guidance for adjusting scoring parameters</li>
<li><a href="/CellType-Refinery/docs/methodology">Methodology Overview</a> - Conceptual background on the annotation approach</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/kuang-da/CellType-Refinery/tree/main/celltype-refinery-docs/docs/methodology/marker-scoring-algorithm.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/CellType-Refinery/docs/methodology/annotation-pipeline"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Annotation Pipeline</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/CellType-Refinery/docs/methodology/hierarchical-gating-algorithm"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Hierarchical Gating Algorithm</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#the-core-formula" class="table-of-contents__link toc-highlight">The Core Formula</a></li><li><a href="#score-interpretation" class="table-of-contents__link toc-highlight">Score Interpretation</a></li></ul></li><li><a href="#component-1-mean-enrichment" class="table-of-contents__link toc-highlight">Component 1: Mean Enrichment</a><ul><li><a href="#calculation" class="table-of-contents__link toc-highlight">Calculation</a></li><li><a href="#step-by-step-breakdown" class="table-of-contents__link toc-highlight">Step-by-Step Breakdown</a></li><li><a href="#why-z-scores" class="table-of-contents__link toc-highlight">Why Z-Scores?</a></li><li><a href="#interpretation-guide" class="table-of-contents__link toc-highlight">Interpretation Guide</a></li><li><a href="#worked-example" class="table-of-contents__link toc-highlight">Worked Example</a></li><li><a href="#edge-cases-and-handling" class="table-of-contents__link toc-highlight">Edge Cases and Handling</a></li></ul></li><li><a href="#component-2-mean-positive-fraction" class="table-of-contents__link toc-highlight">Component 2: Mean Positive Fraction</a><ul><li><a href="#calculation-1" class="table-of-contents__link toc-highlight">Calculation</a></li><li><a href="#step-by-step-breakdown-1" class="table-of-contents__link toc-highlight">Step-by-Step Breakdown</a></li><li><a href="#why-q75-75th-percentile" class="table-of-contents__link toc-highlight">Why Q75 (75th Percentile)?</a></li><li><a href="#tuning-the-threshold" class="table-of-contents__link toc-highlight">Tuning the Threshold</a></li><li><a href="#worked-example-1" class="table-of-contents__link toc-highlight">Worked Example</a></li><li><a href="#interpreting-mean-positive" class="table-of-contents__link toc-highlight">Interpreting Mean Positive</a></li></ul></li><li><a href="#component-3-de-component-rank-weighted" class="table-of-contents__link toc-highlight">Component 3: DE Component (Rank-Weighted)</a><ul><li><a href="#conceptual-overview" class="table-of-contents__link toc-highlight">Conceptual Overview</a></li><li><a href="#step-by-step-breakdown-2" class="table-of-contents__link toc-highlight">Step-by-Step Breakdown</a></li><li><a href="#worked-example-2" class="table-of-contents__link toc-highlight">Worked Example</a></li><li><a href="#why-rank-weighting" class="table-of-contents__link toc-highlight">Why Rank Weighting?</a></li><li><a href="#why-commonness-penalty" class="table-of-contents__link toc-highlight">Why Commonness Penalty?</a></li></ul></li><li><a href="#component-4-anti-marker-penalty" class="table-of-contents__link toc-highlight">Component 4: Anti-Marker Penalty</a><ul><li><a href="#conceptual-overview-1" class="table-of-contents__link toc-highlight">Conceptual Overview</a></li><li><a href="#step-by-step-breakdown-3" class="table-of-contents__link toc-highlight">Step-by-Step Breakdown</a></li><li><a href="#hard-gate-behavior" class="table-of-contents__link toc-highlight">Hard Gate Behavior</a></li><li><a href="#example-scenarios" class="table-of-contents__link toc-highlight">Example Scenarios</a></li><li><a href="#worked-example-3" class="table-of-contents__link toc-highlight">Worked Example</a></li><li><a href="#choosing-anti-aggregation-mode" class="table-of-contents__link toc-highlight">Choosing Anti-Aggregation Mode</a></li></ul></li><li><a href="#putting-it-all-together" class="table-of-contents__link toc-highlight">Putting It All Together</a><ul><li><a href="#complete-scoring-example" class="table-of-contents__link toc-highlight">Complete Scoring Example</a></li></ul></li><li><a href="#parameter-reference" class="table-of-contents__link toc-highlight">Parameter Reference</a><ul><li><a href="#positive-fraction-parameters" class="table-of-contents__link toc-highlight">Positive Fraction Parameters</a></li><li><a href="#de-component-parameters" class="table-of-contents__link toc-highlight">DE Component Parameters</a></li><li><a href="#anti-marker-parameters" class="table-of-contents__link toc-highlight">Anti-Marker Parameters</a></li><li><a href="#parameter-interaction-guidelines" class="table-of-contents__link toc-highlight">Parameter Interaction Guidelines</a></li></ul></li><li><a href="#debugging-scores" class="table-of-contents__link toc-highlight">Debugging Scores</a><ul><li><a href="#low-scores-for-expected-cell-types" class="table-of-contents__link toc-highlight">Low Scores for Expected Cell Types</a></li><li><a href="#multiple-high-scoring-cell-types" class="table-of-contents__link toc-highlight">Multiple High-Scoring Cell Types</a></li><li><a href="#unexpected-rejections-hard-gate" class="table-of-contents__link toc-highlight">Unexpected Rejections (Hard Gate)</a></li></ul></li><li><a href="#mathematical-properties" class="table-of-contents__link toc-highlight">Mathematical Properties</a><ul><li><a href="#score-range" class="table-of-contents__link toc-highlight">Score Range</a></li><li><a href="#component-independence" class="table-of-contents__link toc-highlight">Component Independence</a></li><li><a href="#normalization-considerations" class="table-of-contents__link toc-highlight">Normalization Considerations</a></li></ul></li><li><a href="#see-also" class="table-of-contents__link toc-highlight">See Also</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/CellType-Refinery/docs/getting-started/installation">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/CellType-Refinery/docs/core-workflows/workflow-overview">Core Workflows</a></li><li class="footer__item"><a class="footer__link-item" href="/CellType-Refinery/docs/cli/overview">CLI Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/kuang-da/CellType-Refinery" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/kuang-da/CellType-Refinery/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2026 Penn Biomedical Image Analysis Lab. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>